<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-1 vector-feature-appearance-pinned-clientpref-1 vector-feature-night-mode-enabled skin-theme-clientpref-day vector-sticky-header-enabled vector-toc-not-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Module:Citation/CS1/Identifiers - Wikipedia</title>
<script>(function(){var className="client-js vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-1 vector-feature-appearance-pinned-clientpref-1 vector-feature-night-mode-enabled skin-theme-clientpref-day vector-sticky-header-enabled vector-toc-not-available";var cookie=document.cookie.match(/(?:^|; )enwikimwclientpreferences=([^;]+)/);if(cookie){cookie[1].split('%2C').forEach(function(pref){className=className.replace(new RegExp('(^| )'+pref.replace(/-clientpref-\w+$|[^\w-]+/g,'')+'-clientpref-\\w+( |$)'),'$1'+pref+'$2');});}document.documentElement.className=className;}());RLCONF={"wgBreakFrames":false,"wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgRequestId":"5c5a06b3-c91d-45e5-8c0f-16aa0ad078e0","wgCanonicalNamespace":"Module","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":828,"wgPageName":"Module:Citation/CS1/Identifiers","wgTitle":"Citation/CS1/Identifiers","wgCurRevisionId":1265768031,"wgRevisionId":1265768031,"wgArticleId":48812124,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":["Wikipedia fully protected modules","Modules subject to page protection"],"wgPageViewLanguage":"en","wgPageContentLanguage":"en","wgPageContentModel":"Scribunto","wgRelevantPageName":"Module:Citation/CS1/Identifiers","wgRelevantArticleId":48812124,"wgIsProbablyEditable":false,"wgRelevantPageIsProbablyEditable":false,"wgRestrictionEdit":["sysop"],"wgRestrictionMove":["sysop"],"wgNoticeProject":"wikipedia","wgCiteReferencePreviewsActive":false,"wgFlaggedRevsParams":{"tags":{"status":{"levels":1}}},"wgMediaViewerOnClick":true,"wgMediaViewerEnabledByDefault":true,"wgPopupsFlags":0,"wgVisualEditor":{"pageLanguageCode":"en","pageLanguageDir":"ltr","pageVariantFallbacks":"en"},"wgMFDisplayWikibaseDescriptions":{"search":true,"watchlist":true,"tagline":false,"nearby":true},"wgWMESchemaEditAttemptStepOversample":false,"wgWMEPageLength":80000,"wgEditSubmitButtonLabelPublish":true,"wgULSPosition":"interlanguage","wgULSisCompactLinksEnabled":false,"wgVector2022LanguageInHeader":true,"wgULSisLanguageSelectorEmpty":false,"wgWikibaseItemId":"Q19841691","wgCheckUserClientHintsHeadersJsApi":["brands","architecture","bitness","fullVersionList","mobile","model","platform","platformVersion"],"GEHomepageSuggestedEditsEnableTopics":true,"wgGETopicsMatchModeEnabled":false,"wgGELevelingUpEnabledForUser":false};
RLSTATE={"ext.globalCssJs.user.styles":"ready","site.styles":"ready","user.styles":"ready","ext.globalCssJs.user":"ready","user":"ready","user.options":"loading","ext.pygments":"ready","skins.vector.search.codex.styles":"ready","skins.vector.styles":"ready","skins.vector.icons":"ready","ext.wikimediamessages.styles":"ready","ext.visualEditor.desktopArticleTarget.noscript":"ready","ext.uls.interlanguage":"ready","wikibase.client.init":"ready"};RLPAGEMODULES=["ext.pygments.view","site","mediawiki.page.ready","skins.vector.js","ext.centralNotice.geoIP","ext.centralNotice.startUp","ext.gadget.ReferenceTooltips","ext.gadget.switcher","ext.urlShortener.toolbar","ext.centralauth.centralautologin","mmv.bootstrap","ext.popups","ext.visualEditor.desktopArticleTarget.init","ext.visualEditor.targetLoader","ext.echo.centralauth","ext.eventLogging","ext.wikimediaEvents","ext.navigationTiming","ext.uls.interface","ext.cx.eventlogging.campaigns","wikibase.client.vector-2022","ext.checkUser.clientHints"];</script>
<script>(RLQ=window.RLQ||[]).push(function(){mw.loader.impl(function(){return["user.options@12s5i",function($,jQuery,require,module){mw.user.tokens.set({"patrolToken":"+\\","watchToken":"+\\","csrfToken":"+\\"});
}];});});</script>
<link rel="stylesheet" href="/w/load.php?lang=en&amp;modules=ext.pygments%7Cext.uls.interlanguage%7Cext.visualEditor.desktopArticleTarget.noscript%7Cext.wikimediamessages.styles%7Cskins.vector.icons%2Cstyles%7Cskins.vector.search.codex.styles%7Cwikibase.client.init&amp;only=styles&amp;skin=vector-2022">
<script async="" src="/w/load.php?lang=en&amp;modules=startup&amp;only=scripts&amp;raw=1&amp;skin=vector-2022"></script>
<meta name="ResourceLoaderDynamicStyles" content="">
<link rel="stylesheet" href="/w/load.php?lang=en&amp;modules=site.styles&amp;only=styles&amp;skin=vector-2022">
<meta name="generator" content="MediaWiki 1.44.0-wmf.22">
<meta name="referrer" content="origin">
<meta name="referrer" content="origin-when-cross-origin">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=1120">
<meta property="og:title" content="Module:Citation/CS1/Identifiers - Wikipedia">
<meta property="og:type" content="website">
<link rel="preconnect" href="//upload.wikimedia.org">
<link rel="alternate" media="only screen and (max-width: 640px)" href="//en.m.wikipedia.org/wiki/Module:Citation/CS1/Identifiers">
<link rel="apple-touch-icon" href="/static/apple-touch/wikipedia.png">
<link rel="icon" href="/static/favicon/wikipedia.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/w/rest.php/v1/search" title="Wikipedia (en)">
<link rel="EditURI" type="application/rsd+xml" href="//en.wikipedia.org/w/api.php?action=rsd">
<link rel="canonical" href="https://en.wikipedia.org/wiki/Module:Citation/CS1/Identifiers">
<link rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/deed.en">
<link rel="alternate" type="application/atom+xml" title="Wikipedia Atom feed" href="/w/index.php?title=Special:RecentChanges&amp;feed=atom">
<link rel="dns-prefetch" href="//meta.wikimedia.org" />
<link rel="dns-prefetch" href="login.wikimedia.org">
</head>
<body class="skin--responsive skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-828 ns-subject page-Module_Citation_CS1_Identifiers rootpage-Module_Citation skin-vector-2022 action-view"><a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	<header class="vector-header mw-header">
		<div class="vector-header-start">
			<nav class="vector-main-menu-landmark" aria-label="Site">
				
<div id="vector-main-menu-dropdown" class="vector-dropdown vector-main-menu-dropdown vector-button-flush-left vector-button-flush-right"  title="Main menu" >
	<input type="checkbox" id="vector-main-menu-dropdown-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-main-menu-dropdown" class="vector-dropdown-checkbox "  aria-label="Main menu"  >
	<label id="vector-main-menu-dropdown-label" for="vector-main-menu-dropdown-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"  ><span class="vector-icon mw-ui-icon-menu mw-ui-icon-wikimedia-menu"></span>

<span class="vector-dropdown-label-text">Main menu</span>
	</label>
	<div class="vector-dropdown-content">


				<div id="vector-main-menu-unpinned-container" class="vector-unpinned-container">
		
<div id="vector-main-menu" class="vector-main-menu vector-pinnable-element">
	<div
	class="vector-pinnable-header vector-main-menu-pinnable-header vector-pinnable-header-unpinned"
	data-feature-name="main-menu-pinned"
	data-pinnable-element-id="vector-main-menu"
	data-pinned-container-id="vector-main-menu-pinned-container"
	data-unpinned-container-id="vector-main-menu-unpinned-container"
>
	<div class="vector-pinnable-header-label">Main menu</div>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-main-menu.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-main-menu.unpin">hide</button>
</div>

	
<div id="p-navigation" class="vector-menu mw-portlet mw-portlet-navigation"  >
	<div class="vector-menu-heading">
		Navigation
	</div>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
			
			<li id="n-mainpage-description" class="mw-list-item"><a href="/wiki/Main_Page" title="Visit the main page [z]" accesskey="z"><span>Main page</span></a></li><li id="n-contents" class="mw-list-item"><a href="/wiki/Wikipedia:Contents" title="Guides to browsing Wikipedia"><span>Contents</span></a></li><li id="n-currentevents" class="mw-list-item"><a href="/wiki/Portal:Current_events" title="Articles related to current events"><span>Current events</span></a></li><li id="n-randompage" class="mw-list-item"><a href="/wiki/Special:Random" title="Visit a randomly selected article [x]" accesskey="x"><span>Random article</span></a></li><li id="n-aboutsite" class="mw-list-item"><a href="/wiki/Wikipedia:About" title="Learn about Wikipedia and how it works"><span>About Wikipedia</span></a></li><li id="n-contactpage" class="mw-list-item"><a href="//en.wikipedia.org/wiki/Wikipedia:Contact_us" title="How to contact Wikipedia"><span>Contact us</span></a></li>
		</ul>
		
	</div>
</div>

	
	
<div id="p-interaction" class="vector-menu mw-portlet mw-portlet-interaction"  >
	<div class="vector-menu-heading">
		Contribute
	</div>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
			
			<li id="n-help" class="mw-list-item"><a href="/wiki/Help:Contents" title="Guidance on how to use and edit Wikipedia"><span>Help</span></a></li><li id="n-introduction" class="mw-list-item"><a href="/wiki/Help:Introduction" title="Learn how to edit Wikipedia"><span>Learn to edit</span></a></li><li id="n-portal" class="mw-list-item"><a href="/wiki/Wikipedia:Community_portal" title="The hub for editors"><span>Community portal</span></a></li><li id="n-recentchanges" class="mw-list-item"><a href="/wiki/Special:RecentChanges" title="A list of recent changes to Wikipedia [r]" accesskey="r"><span>Recent changes</span></a></li><li id="n-upload" class="mw-list-item"><a href="/wiki/Wikipedia:File_upload_wizard" title="Add images or other media for use on Wikipedia"><span>Upload file</span></a></li><li id="n-specialpages" class="mw-list-item"><a href="/wiki/Special:SpecialPages"><span>Special pages</span></a></li>
		</ul>
		
	</div>
</div>

</div>

				</div>

	</div>
</div>

		</nav>
			
<a href="/wiki/Main_Page" class="mw-logo">
	<img class="mw-logo-icon" src="/static/images/icons/wikipedia.png" alt="" aria-hidden="true" height="50" width="50">
	<span class="mw-logo-container skin-invert">
		<img class="mw-logo-wordmark" alt="Wikipedia" src="/static/images/mobile/copyright/wikipedia-wordmark-en.svg" style="width: 7.5em; height: 1.125em;">
		<img class="mw-logo-tagline" alt="The Free Encyclopedia" src="/static/images/mobile/copyright/wikipedia-tagline-en.svg" width="117" height="13" style="width: 7.3125em; height: 0.8125em;">
	</span>
</a>

		</div>
		<div class="vector-header-end">
			
<div id="p-search" role="search" class="vector-search-box-vue  vector-search-box-collapses vector-search-box-show-thumbnail vector-search-box-auto-expand-width vector-search-box">
	<a href="/wiki/Special:Search" class="cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only search-toggle" title="Search Wikipedia [f]" accesskey="f"><span class="vector-icon mw-ui-icon-search mw-ui-icon-wikimedia-search"></span>

<span>Search</span>
	</a>
	<div class="vector-typeahead-search-container">
		<div class="cdx-typeahead-search cdx-typeahead-search--show-thumbnail cdx-typeahead-search--auto-expand-width">
			<form action="/w/index.php" id="searchform" class="cdx-search-input cdx-search-input--has-end-button">
				<div id="simpleSearch" class="cdx-search-input__input-wrapper"  data-search-loc="header-moved">
					<div class="cdx-text-input cdx-text-input--has-start-icon">
						<input
							class="cdx-text-input__input"
							 type="search" name="search" placeholder="Search Wikipedia" aria-label="Search Wikipedia" autocapitalize="sentences" title="Search Wikipedia [f]" accesskey="f" id="searchInput"
							>
						<span class="cdx-text-input__icon cdx-text-input__start-icon"></span>
					</div>
					<input type="hidden" name="title" value="Special:Search">
				</div>
				<button class="cdx-button cdx-search-input__end-button">Search</button>
			</form>
		</div>
	</div>
</div>

			<nav class="vector-user-links vector-user-links-wide" aria-label="Personal tools">
	<div class="vector-user-links-main">
	
<div id="p-vector-user-menu-preferences" class="vector-menu mw-portlet emptyPortlet"  >
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
			
			
		</ul>
		
	</div>
</div>

	
<div id="p-vector-user-menu-userpage" class="vector-menu mw-portlet emptyPortlet"  >
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
			
			
		</ul>
		
	</div>
</div>

	<nav class="vector-appearance-landmark" aria-label="Appearance">
		
<div id="vector-appearance-dropdown" class="vector-dropdown "  title="Change the appearance of the page&#039;s font size, width, and color" >
	<input type="checkbox" id="vector-appearance-dropdown-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-appearance-dropdown" class="vector-dropdown-checkbox "  aria-label="Appearance"  >
	<label id="vector-appearance-dropdown-label" for="vector-appearance-dropdown-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"  ><span class="vector-icon mw-ui-icon-appearance mw-ui-icon-wikimedia-appearance"></span>

<span class="vector-dropdown-label-text">Appearance</span>
	</label>
	<div class="vector-dropdown-content">


			<div id="vector-appearance-unpinned-container" class="vector-unpinned-container">
				
			</div>
		
	</div>
</div>

	</nav>
	
<div id="p-vector-user-menu-notifications" class="vector-menu mw-portlet emptyPortlet"  >
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
			
			
		</ul>
		
	</div>
</div>

	
<div id="p-vector-user-menu-overflow" class="vector-menu mw-portlet"  >
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
			<li id="pt-sitesupport-2" class="user-links-collapsible-item mw-list-item user-links-collapsible-item"><a data-mw="interface" href="https://donate.wikimedia.org/?wmf_source=donate&amp;wmf_medium=sidebar&amp;wmf_campaign=en.wikipedia.org&amp;uselang=en" class=""><span>Donate</span></a>
</li>
<li id="pt-createaccount-2" class="user-links-collapsible-item mw-list-item user-links-collapsible-item"><a data-mw="interface" href="/w/index.php?title=Special:CreateAccount&amp;returnto=Module%3ACitation%2FCS1%2FIdentifiers" title="You are encouraged to create an account and log in; however, it is not mandatory" class=""><span>Create account</span></a>
</li>
<li id="pt-login-2" class="user-links-collapsible-item mw-list-item user-links-collapsible-item"><a data-mw="interface" href="/w/index.php?title=Special:UserLogin&amp;returnto=Module%3ACitation%2FCS1%2FIdentifiers" title="You&#039;re encouraged to log in; however, it&#039;s not mandatory. [o]" accesskey="o" class=""><span>Log in</span></a>
</li>

			
		</ul>
		
	</div>
</div>

	</div>
	
<div id="vector-user-links-dropdown" class="vector-dropdown vector-user-menu vector-button-flush-right vector-user-menu-logged-out"  title="Log in and more options" >
	<input type="checkbox" id="vector-user-links-dropdown-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-user-links-dropdown" class="vector-dropdown-checkbox "  aria-label="Personal tools"  >
	<label id="vector-user-links-dropdown-label" for="vector-user-links-dropdown-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"  ><span class="vector-icon mw-ui-icon-ellipsis mw-ui-icon-wikimedia-ellipsis"></span>

<span class="vector-dropdown-label-text">Personal tools</span>
	</label>
	<div class="vector-dropdown-content">


		
<div id="p-personal" class="vector-menu mw-portlet mw-portlet-personal user-links-collapsible-item"  title="User menu" >
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
			
			<li id="pt-sitesupport" class="user-links-collapsible-item mw-list-item"><a href="https://donate.wikimedia.org/?wmf_source=donate&amp;wmf_medium=sidebar&amp;wmf_campaign=en.wikipedia.org&amp;uselang=en"><span>Donate</span></a></li><li id="pt-createaccount" class="user-links-collapsible-item mw-list-item"><a href="/w/index.php?title=Special:CreateAccount&amp;returnto=Module%3ACitation%2FCS1%2FIdentifiers" title="You are encouraged to create an account and log in; however, it is not mandatory"><span class="vector-icon mw-ui-icon-userAdd mw-ui-icon-wikimedia-userAdd"></span> <span>Create account</span></a></li><li id="pt-login" class="user-links-collapsible-item mw-list-item"><a href="/w/index.php?title=Special:UserLogin&amp;returnto=Module%3ACitation%2FCS1%2FIdentifiers" title="You&#039;re encouraged to log in; however, it&#039;s not mandatory. [o]" accesskey="o"><span class="vector-icon mw-ui-icon-logIn mw-ui-icon-wikimedia-logIn"></span> <span>Log in</span></a></li>
		</ul>
		
	</div>
</div>

<div id="p-user-menu-anon-editor" class="vector-menu mw-portlet mw-portlet-user-menu-anon-editor"  >
	<div class="vector-menu-heading">
		Pages for logged out editors <a href="/wiki/Help:Introduction" aria-label="Learn more about editing"><span>learn more</span></a>
	</div>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
			
			<li id="pt-anoncontribs" class="mw-list-item"><a href="/wiki/Special:MyContributions" title="A list of edits made from this IP address [y]" accesskey="y"><span>Contributions</span></a></li><li id="pt-anontalk" class="mw-list-item"><a href="/wiki/Special:MyTalk" title="Discussion about edits from this IP address [n]" accesskey="n"><span>Talk</span></a></li>
		</ul>
		
	</div>
</div>

	
	</div>
</div>

</nav>

		</div>
	</header>
</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-sitenotice-container">
			<div id="siteNotice"><!-- CentralNotice --></div>
		</div>
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		<div id="mw-navigation">
			<nav id="mw-panel" class="vector-main-menu-landmark" aria-label="Site">
				<div id="vector-main-menu-pinned-container" class="vector-pinned-container">
				
				</div>
		</nav>
		</div>
	</div>
</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body">
				<header class="mw-body-header vector-page-titlebar">
					<h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-namespace">Module</span><span class="mw-page-title-separator">:</span><span class="mw-page-title-main">Citation/CS1/Identifiers</span></h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang"  >
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 134 languages"   >
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-134" aria-hidden="true"  ><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">134 languages</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-af mw-list-item"><a href="https://af.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Afrikaans" lang="af" hreflang="af" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Afrikaans" data-language-local-name="Afrikaans" class="interlanguage-link-target"><span>Afrikaans</span></a></li><li class="interlanguage-link interwiki-smn mw-list-item"><a href="https://smn.wikipedia.org/wiki/Mooduul:Citation/CS1/Identifiers" title="Mooduul:Citation/CS1/Identifiers – Inari Sami" lang="smn" hreflang="smn" data-title="Mooduul:Citation/CS1/Identifiers" data-language-autonym="Anarâškielâ" data-language-local-name="Inari Sami" class="interlanguage-link-target"><span>Anarâškielâ</span></a></li><li class="interlanguage-link interwiki-ang mw-list-item"><a href="https://ang.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Old English" lang="ang" hreflang="ang" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Ænglisc" data-language-local-name="Old English" class="interlanguage-link-target"><span>Ænglisc</span></a></li><li class="interlanguage-link interwiki-ab mw-list-item"><a href="https://ab.wikipedia.org/wiki/%D0%90%D0%BC%D0%BE%D0%B4%D1%83%D0%BB%D1%8C:Citation/CS1/Identifiers" title="Амодуль:Citation/CS1/Identifiers – Abkhazian" lang="ab" hreflang="ab" data-title="Амодуль:Citation/CS1/Identifiers" data-language-autonym="Аԥсшәа" data-language-local-name="Abkhazian" class="interlanguage-link-target"><span>Аԥсшәа</span></a></li><li class="interlanguage-link interwiki-ar mw-list-item"><a href="https://ar.wikipedia.org/wiki/%D9%88%D8%AD%D8%AF%D8%A9:Citation/CS1/Identifiers" title="وحدة:Citation/CS1/Identifiers – Arabic" lang="ar" hreflang="ar" data-title="وحدة:Citation/CS1/Identifiers" data-language-autonym="العربية" data-language-local-name="Arabic" class="interlanguage-link-target"><span>العربية</span></a></li><li class="interlanguage-link interwiki-arc mw-list-item"><a href="https://arc.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Aramaic" lang="arc" hreflang="arc" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="ܐܪܡܝܐ" data-language-local-name="Aramaic" class="interlanguage-link-target"><span>ܐܪܡܝܐ</span></a></li><li class="interlanguage-link interwiki-as mw-list-item"><a href="https://as.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Assamese" lang="as" hreflang="as" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="অসমীয়া" data-language-local-name="Assamese" class="interlanguage-link-target"><span>অসমীয়া</span></a></li><li class="interlanguage-link interwiki-ast mw-list-item"><a href="https://ast.wikipedia.org/wiki/M%C3%B3dulu:Identificadores" title="Módulu:Identificadores – Asturian" lang="ast" hreflang="ast" data-title="Módulu:Identificadores" data-language-autonym="Asturianu" data-language-local-name="Asturian" class="interlanguage-link-target"><span>Asturianu</span></a></li><li class="interlanguage-link interwiki-av mw-list-item"><a href="https://av.wikipedia.org/wiki/%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C:Citation/CS1/Identifiers" title="Модуль:Citation/CS1/Identifiers – Avaric" lang="av" hreflang="av" data-title="Модуль:Citation/CS1/Identifiers" data-language-autonym="Авар" data-language-local-name="Avaric" class="interlanguage-link-target"><span>Авар</span></a></li><li class="interlanguage-link interwiki-az mw-list-item"><a href="https://az.wikipedia.org/wiki/Modul:Citation/CS1/Identifiers" title="Modul:Citation/CS1/Identifiers – Azerbaijani" lang="az" hreflang="az" data-title="Modul:Citation/CS1/Identifiers" data-language-autonym="Azərbaycanca" data-language-local-name="Azerbaijani" class="interlanguage-link-target"><span>Azərbaycanca</span></a></li><li class="interlanguage-link interwiki-azb mw-list-item"><a href="https://azb.wikipedia.org/wiki/%D9%85%D8%A7%DA%98%D9%88%D9%84:Citation/CS1/Identifiers" title="ماژول:Citation/CS1/Identifiers – South Azerbaijani" lang="azb" hreflang="azb" data-title="ماژول:Citation/CS1/Identifiers" data-language-autonym="تۆرکجه" data-language-local-name="South Azerbaijani" class="interlanguage-link-target"><span>تۆرکجه</span></a></li><li class="interlanguage-link interwiki-ban mw-list-item"><a href="https://ban.wikipedia.org/wiki/Modul:Citation/CS1/Identifiers" title="Modul:Citation/CS1/Identifiers – Balinese" lang="ban" hreflang="ban" data-title="Modul:Citation/CS1/Identifiers" data-language-autonym="Basa Bali" data-language-local-name="Balinese" class="interlanguage-link-target"><span>Basa Bali</span></a></li><li class="interlanguage-link interwiki-bm mw-list-item"><a href="https://bm.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Bambara" lang="bm" hreflang="bm" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Bamanankan" data-language-local-name="Bambara" class="interlanguage-link-target"><span>Bamanankan</span></a></li><li class="interlanguage-link interwiki-bn mw-list-item"><a href="https://bn.wikipedia.org/wiki/%E0%A6%AE%E0%A6%A1%E0%A6%BF%E0%A6%89%E0%A6%B2:%E0%A6%89%E0%A6%A6%E0%A7%8D%E0%A6%A7%E0%A7%83%E0%A6%A4%E0%A6%BF/%E0%A6%B6%E0%A6%A8%E0%A6%BE%E0%A6%95%E0%A7%8D%E0%A6%A4%E0%A6%95%E0%A6%BE%E0%A6%B0%E0%A7%80" title="মডিউল:উদ্ধৃতি/শনাক্তকারী – Bangla" lang="bn" hreflang="bn" data-title="মডিউল:উদ্ধৃতি/শনাক্তকারী" data-language-autonym="বাংলা" data-language-local-name="Bangla" class="interlanguage-link-target"><span>বাংলা</span></a></li><li class="interlanguage-link interwiki-bjn mw-list-item"><a href="https://bjn.wikipedia.org/wiki/Modul:Citation/CS1/Identifiers" title="Modul:Citation/CS1/Identifiers – Banjar" lang="bjn" hreflang="bjn" data-title="Modul:Citation/CS1/Identifiers" data-language-autonym="Banjar" data-language-local-name="Banjar" class="interlanguage-link-target"><span>Banjar</span></a></li><li class="interlanguage-link interwiki-zh-min-nan mw-list-item"><a href="https://zh-min-nan.wikipedia.org/wiki/%E6%A8%A1%E7%B5%84:Citation/CS1/Identifiers" title="模組:Citation/CS1/Identifiers – Minnan" lang="nan" hreflang="nan" data-title="模組:Citation/CS1/Identifiers" data-language-autonym="閩南語 / Bân-lâm-gú" data-language-local-name="Minnan" class="interlanguage-link-target"><span>閩南語 / Bân-lâm-gú</span></a></li><li class="interlanguage-link interwiki-ba mw-list-item"><a href="https://ba.wikipedia.org/wiki/%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C:Citation/CS1/Identifiers" title="Модуль:Citation/CS1/Identifiers – Bashkir" lang="ba" hreflang="ba" data-title="Модуль:Citation/CS1/Identifiers" data-language-autonym="Башҡортса" data-language-local-name="Bashkir" class="interlanguage-link-target"><span>Башҡортса</span></a></li><li class="interlanguage-link interwiki-be mw-list-item"><a href="https://be.wikipedia.org/wiki/%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C:Citation/CS1/Identifiers" title="Модуль:Citation/CS1/Identifiers – Belarusian" lang="be" hreflang="be" data-title="Модуль:Citation/CS1/Identifiers" data-language-autonym="Беларуская" data-language-local-name="Belarusian" class="interlanguage-link-target"><span>Беларуская</span></a></li><li class="interlanguage-link interwiki-bh mw-list-item"><a href="https://bh.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Bhojpuri" lang="bh" hreflang="bh" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="भोजपुरी" data-language-local-name="Bhojpuri" class="interlanguage-link-target"><span>भोजपुरी</span></a></li><li class="interlanguage-link interwiki-bcl mw-list-item"><a href="https://bcl.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Central Bikol" lang="bcl" hreflang="bcl" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Bikol Central" data-language-local-name="Central Bikol" class="interlanguage-link-target"><span>Bikol Central</span></a></li><li class="interlanguage-link interwiki-bg mw-list-item"><a href="https://bg.wikipedia.org/wiki/%D0%9C%D0%BE%D0%B4%D1%83%D0%BB:Citation/CS1/Identifiers" title="Модул:Citation/CS1/Identifiers – Bulgarian" lang="bg" hreflang="bg" data-title="Модул:Citation/CS1/Identifiers" data-language-autonym="Български" data-language-local-name="Bulgarian" class="interlanguage-link-target"><span>Български</span></a></li><li class="interlanguage-link interwiki-bo mw-list-item"><a href="https://bo.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Tibetan" lang="bo" hreflang="bo" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="བོད་ཡིག" data-language-local-name="Tibetan" class="interlanguage-link-target"><span>བོད་ཡིག</span></a></li><li class="interlanguage-link interwiki-bs mw-list-item"><a href="https://bs.wikipedia.org/wiki/Modul:Citation/CS1/Identifiers" title="Modul:Citation/CS1/Identifiers – Bosnian" lang="bs" hreflang="bs" data-title="Modul:Citation/CS1/Identifiers" data-language-autonym="Bosanski" data-language-local-name="Bosnian" class="interlanguage-link-target"><span>Bosanski</span></a></li><li class="interlanguage-link interwiki-bxr mw-list-item"><a href="https://bxr.wikipedia.org/wiki/%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C:Citation/CS1/Identifiers" title="Модуль:Citation/CS1/Identifiers – Russia Buriat" lang="bxr" hreflang="bxr" data-title="Модуль:Citation/CS1/Identifiers" data-language-autonym="Буряад" data-language-local-name="Russia Buriat" class="interlanguage-link-target"><span>Буряад</span></a></li><li class="interlanguage-link interwiki-ca mw-list-item"><a href="https://ca.wikipedia.org/wiki/M%C3%B2dul:Citation/CS1/Identifiers" title="Mòdul:Citation/CS1/Identifiers – Catalan" lang="ca" hreflang="ca" data-title="Mòdul:Citation/CS1/Identifiers" data-language-autonym="Català" data-language-local-name="Catalan" class="interlanguage-link-target"><span>Català</span></a></li><li class="interlanguage-link interwiki-cv mw-list-item"><a href="https://cv.wikipedia.org/wiki/%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C:Citation/CS1/Identifiers" title="Модуль:Citation/CS1/Identifiers – Chuvash" lang="cv" hreflang="cv" data-title="Модуль:Citation/CS1/Identifiers" data-language-autonym="Чӑвашла" data-language-local-name="Chuvash" class="interlanguage-link-target"><span>Чӑвашла</span></a></li><li class="interlanguage-link interwiki-ceb mw-list-item"><a href="https://ceb.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Cebuano" lang="ceb" hreflang="ceb" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Cebuano" data-language-local-name="Cebuano" class="interlanguage-link-target"><span>Cebuano</span></a></li><li class="interlanguage-link interwiki-cy mw-list-item"><a href="https://cy.wikipedia.org/wiki/Modiwl:Citation/CS1/Identifiers" title="Modiwl:Citation/CS1/Identifiers – Welsh" lang="cy" hreflang="cy" data-title="Modiwl:Citation/CS1/Identifiers" data-language-autonym="Cymraeg" data-language-local-name="Welsh" class="interlanguage-link-target"><span>Cymraeg</span></a></li><li class="interlanguage-link interwiki-da mw-list-item"><a href="https://da.wikipedia.org/wiki/Modul:Citation/CS1/Identifiers" title="Modul:Citation/CS1/Identifiers – Danish" lang="da" hreflang="da" data-title="Modul:Citation/CS1/Identifiers" data-language-autonym="Dansk" data-language-local-name="Danish" class="interlanguage-link-target"><span>Dansk</span></a></li><li class="interlanguage-link interwiki-ary mw-list-item"><a href="https://ary.wikipedia.org/wiki/%D9%85%D9%88%D8%AF%D9%88%D9%84:Citation/CS1/Identifiers" title="مودول:Citation/CS1/Identifiers – Moroccan Arabic" lang="ary" hreflang="ary" data-title="مودول:Citation/CS1/Identifiers" data-language-autonym="الدارجة" data-language-local-name="Moroccan Arabic" class="interlanguage-link-target"><span>الدارجة</span></a></li><li class="interlanguage-link interwiki-pdc mw-list-item"><a href="https://pdc.wikipedia.org/wiki/Modul:Citation/CS1/Identifiers" title="Modul:Citation/CS1/Identifiers – Pennsylvania German" lang="pdc" hreflang="pdc" data-title="Modul:Citation/CS1/Identifiers" data-language-autonym="Deitsch" data-language-local-name="Pennsylvania German" class="interlanguage-link-target"><span>Deitsch</span></a></li><li class="interlanguage-link interwiki-et mw-list-item"><a href="https://et.wikipedia.org/wiki/Moodul:Citation/CS1/Identifiers" title="Moodul:Citation/CS1/Identifiers – Estonian" lang="et" hreflang="et" data-title="Moodul:Citation/CS1/Identifiers" data-language-autonym="Eesti" data-language-local-name="Estonian" class="interlanguage-link-target"><span>Eesti</span></a></li><li class="interlanguage-link interwiki-el mw-list-item"><a href="https://el.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Greek" lang="el" hreflang="el" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Ελληνικά" data-language-local-name="Greek" class="interlanguage-link-target"><span>Ελληνικά</span></a></li><li class="interlanguage-link interwiki-myv mw-list-item"><a href="https://myv.wikipedia.org/wiki/%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C:Citation/CS1/Identifiers" title="Модуль:Citation/CS1/Identifiers – Erzya" lang="myv" hreflang="myv" data-title="Модуль:Citation/CS1/Identifiers" data-language-autonym="Эрзянь" data-language-local-name="Erzya" class="interlanguage-link-target"><span>Эрзянь</span></a></li><li class="interlanguage-link interwiki-es mw-list-item"><a href="https://es.wikipedia.org/wiki/M%C3%B3dulo:Identificadores" title="Módulo:Identificadores – Spanish" lang="es" hreflang="es" data-title="Módulo:Identificadores" data-language-autonym="Español" data-language-local-name="Spanish" class="interlanguage-link-target"><span>Español</span></a></li><li class="interlanguage-link interwiki-ext mw-list-item"><a href="https://ext.wikipedia.org/wiki/M%C3%B3dulo:Citation/CS1/Identifiers" title="Módulo:Citation/CS1/Identifiers – Extremaduran" lang="ext" hreflang="ext" data-title="Módulo:Citation/CS1/Identifiers" data-language-autonym="Estremeñu" data-language-local-name="Extremaduran" class="interlanguage-link-target"><span>Estremeñu</span></a></li><li class="interlanguage-link interwiki-fa mw-list-item"><a href="https://fa.wikipedia.org/wiki/%D9%BE%D9%88%D8%AF%D9%85%D8%A7%D9%86:Citation/CS1/en/Identifiers" title="پودمان:Citation/CS1/en/Identifiers – Persian" lang="fa" hreflang="fa" data-title="پودمان:Citation/CS1/en/Identifiers" data-language-autonym="فارسی" data-language-local-name="Persian" class="interlanguage-link-target"><span>فارسی</span></a></li><li class="interlanguage-link interwiki-ga mw-list-item"><a href="https://ga.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Irish" lang="ga" hreflang="ga" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Gaeilge" data-language-local-name="Irish" class="interlanguage-link-target"><span>Gaeilge</span></a></li><li class="interlanguage-link interwiki-gl mw-list-item"><a href="https://gl.wikipedia.org/wiki/M%C3%B3dulo:Citas/Identifiers" title="Módulo:Citas/Identifiers – Galician" lang="gl" hreflang="gl" data-title="Módulo:Citas/Identifiers" data-language-autonym="Galego" data-language-local-name="Galician" class="interlanguage-link-target"><span>Galego</span></a></li><li class="interlanguage-link interwiki-glk mw-list-item"><a href="https://glk.wikipedia.org/wiki/%D9%85%D8%A7%D8%AC%DB%8A%D9%84:Citation/CS1/Identifiers" title="ماجۊل:Citation/CS1/Identifiers – Gilaki" lang="glk" hreflang="glk" data-title="ماجۊل:Citation/CS1/Identifiers" data-language-autonym="گیلکی" data-language-local-name="Gilaki" class="interlanguage-link-target"><span>گیلکی</span></a></li><li class="interlanguage-link interwiki-gu mw-list-item"><a href="https://gu.wikipedia.org/wiki/%E0%AA%B5%E0%AA%BF%E0%AA%AD%E0%AA%BE%E0%AA%97:Citation/CS1/Identifiers" title="વિભાગ:Citation/CS1/Identifiers – Gujarati" lang="gu" hreflang="gu" data-title="વિભાગ:Citation/CS1/Identifiers" data-language-autonym="ગુજરાતી" data-language-local-name="Gujarati" class="interlanguage-link-target"><span>ગુજરાતી</span></a></li><li class="interlanguage-link interwiki-gom mw-list-item"><a href="https://gom.wikipedia.org/wiki/%E0%A4%8F%E0%A4%95%E0%A4%95:Citation/CS1/Identifiers" title="एकक:Citation/CS1/Identifiers – Goan Konkani" lang="gom" hreflang="gom" data-title="एकक:Citation/CS1/Identifiers" data-language-autonym="गोंयची कोंकणी / Gõychi Konknni" data-language-local-name="Goan Konkani" class="interlanguage-link-target"><span>गोंयची कोंकणी / Gõychi Konknni</span></a></li><li class="interlanguage-link interwiki-ko mw-list-item"><a href="https://ko.wikipedia.org/wiki/%EB%AA%A8%EB%93%88:Citation/CS1/Identifiers" title="모듈:Citation/CS1/Identifiers – Korean" lang="ko" hreflang="ko" data-title="모듈:Citation/CS1/Identifiers" data-language-autonym="한국어" data-language-local-name="Korean" class="interlanguage-link-target"><span>한국어</span></a></li><li class="interlanguage-link interwiki-ha mw-list-item"><a href="https://ha.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Hausa" lang="ha" hreflang="ha" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Hausa" data-language-local-name="Hausa" class="interlanguage-link-target"><span>Hausa</span></a></li><li class="interlanguage-link interwiki-hy mw-list-item"><a href="https://hy.wikipedia.org/wiki/%D5%84%D5%B8%D5%A4%D5%B8%D6%82%D5%AC:Citation/CS1/Identifiers" title="Մոդուլ:Citation/CS1/Identifiers – Armenian" lang="hy" hreflang="hy" data-title="Մոդուլ:Citation/CS1/Identifiers" data-language-autonym="Հայերեն" data-language-local-name="Armenian" class="interlanguage-link-target"><span>Հայերեն</span></a></li><li class="interlanguage-link interwiki-hr mw-list-item"><a href="https://hr.wikipedia.org/wiki/Modul:Citation/CS1/Identifiers" title="Modul:Citation/CS1/Identifiers – Croatian" lang="hr" hreflang="hr" data-title="Modul:Citation/CS1/Identifiers" data-language-autonym="Hrvatski" data-language-local-name="Croatian" class="interlanguage-link-target"><span>Hrvatski</span></a></li><li class="interlanguage-link interwiki-gor mw-list-item"><a href="https://gor.wikipedia.org/wiki/Modul:Citation/CS1/Identifiers" title="Modul:Citation/CS1/Identifiers – Gorontalo" lang="gor" hreflang="gor" data-title="Modul:Citation/CS1/Identifiers" data-language-autonym="Bahasa Hulontalo" data-language-local-name="Gorontalo" class="interlanguage-link-target"><span>Bahasa Hulontalo</span></a></li><li class="interlanguage-link interwiki-ig mw-list-item"><a href="https://ig.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Igbo" lang="ig" hreflang="ig" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Igbo" data-language-local-name="Igbo" class="interlanguage-link-target"><span>Igbo</span></a></li><li class="interlanguage-link interwiki-ilo mw-list-item"><a href="https://ilo.wikipedia.org/wiki/Modulo:Citation/CS1/Identifiers" title="Modulo:Citation/CS1/Identifiers – Iloko" lang="ilo" hreflang="ilo" data-title="Modulo:Citation/CS1/Identifiers" data-language-autonym="Ilokano" data-language-local-name="Iloko" class="interlanguage-link-target"><span>Ilokano</span></a></li><li class="interlanguage-link interwiki-id mw-list-item"><a href="https://id.wikipedia.org/wiki/Modul:Citation/CS1/Identifiers" title="Modul:Citation/CS1/Identifiers – Indonesian" lang="id" hreflang="id" data-title="Modul:Citation/CS1/Identifiers" data-language-autonym="Bahasa Indonesia" data-language-local-name="Indonesian" class="interlanguage-link-target"><span>Bahasa Indonesia</span></a></li><li class="interlanguage-link interwiki-ia mw-list-item"><a href="https://ia.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Interlingua" lang="ia" hreflang="ia" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Interlingua" data-language-local-name="Interlingua" class="interlanguage-link-target"><span>Interlingua</span></a></li><li class="interlanguage-link interwiki-os mw-list-item"><a href="https://os.wikipedia.org/wiki/%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C:Citation/CS1/Identifiers" title="Модуль:Citation/CS1/Identifiers – Ossetic" lang="os" hreflang="os" data-title="Модуль:Citation/CS1/Identifiers" data-language-autonym="Ирон" data-language-local-name="Ossetic" class="interlanguage-link-target"><span>Ирон</span></a></li><li class="interlanguage-link interwiki-is mw-list-item"><a href="https://is.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Icelandic" lang="is" hreflang="is" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Íslenska" data-language-local-name="Icelandic" class="interlanguage-link-target"><span>Íslenska</span></a></li><li class="interlanguage-link interwiki-he mw-list-item"><a href="https://he.wikipedia.org/wiki/%D7%99%D7%97%D7%99%D7%93%D7%94:Citation/CS1/Identifiers" title="יחידה:Citation/CS1/Identifiers – Hebrew" lang="he" hreflang="he" data-title="יחידה:Citation/CS1/Identifiers" data-language-autonym="עברית" data-language-local-name="Hebrew" class="interlanguage-link-target"><span>עברית</span></a></li><li class="interlanguage-link interwiki-jv mw-list-item"><a href="https://jv.wikipedia.org/wiki/Modhul:Citation/CS1/Identifiers" title="Modhul:Citation/CS1/Identifiers – Javanese" lang="jv" hreflang="jv" data-title="Modhul:Citation/CS1/Identifiers" data-language-autonym="Jawa" data-language-local-name="Javanese" class="interlanguage-link-target"><span>Jawa</span></a></li><li class="interlanguage-link interwiki-kn mw-list-item"><a href="https://kn.wikipedia.org/wiki/%E0%B2%AE%E0%B2%BE%E0%B2%A1%E0%B3%8D%E0%B2%AF%E0%B3%82%E0%B2%B2%E0%B3%8D:Citation/CS1/Identifiers" title="ಮಾಡ್ಯೂಲ್:Citation/CS1/Identifiers – Kannada" lang="kn" hreflang="kn" data-title="ಮಾಡ್ಯೂಲ್:Citation/CS1/Identifiers" data-language-autonym="ಕನ್ನಡ" data-language-local-name="Kannada" class="interlanguage-link-target"><span>ಕನ್ನಡ</span></a></li><li class="interlanguage-link interwiki-ka mw-list-item"><a href="https://ka.wikipedia.org/wiki/%E1%83%9B%E1%83%9D%E1%83%93%E1%83%A3%E1%83%9A%E1%83%98:Citation/CS1/Identifiers" title="მოდული:Citation/CS1/Identifiers – Georgian" lang="ka" hreflang="ka" data-title="მოდული:Citation/CS1/Identifiers" data-language-autonym="ქართული" data-language-local-name="Georgian" class="interlanguage-link-target"><span>ქართული</span></a></li><li class="interlanguage-link interwiki-kk mw-list-item"><a href="https://kk.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Kazakh" lang="kk" hreflang="kk" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Қазақша" data-language-local-name="Kazakh" class="interlanguage-link-target"><span>Қазақша</span></a></li><li class="interlanguage-link interwiki-kw mw-list-item"><a href="https://kw.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Cornish" lang="kw" hreflang="kw" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Kernowek" data-language-local-name="Cornish" class="interlanguage-link-target"><span>Kernowek</span></a></li><li class="interlanguage-link interwiki-rn mw-list-item"><a href="https://rn.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Rundi" lang="rn" hreflang="rn" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Ikirundi" data-language-local-name="Rundi" class="interlanguage-link-target"><span>Ikirundi</span></a></li><li class="interlanguage-link interwiki-ht mw-list-item"><a href="https://ht.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Haitian Creole" lang="ht" hreflang="ht" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Kreyòl ayisyen" data-language-local-name="Haitian Creole" class="interlanguage-link-target"><span>Kreyòl ayisyen</span></a></li><li class="interlanguage-link interwiki-ku mw-list-item"><a href="https://ku.wikipedia.org/wiki/Modul:Citation/CS1/Identifiers" title="Modul:Citation/CS1/Identifiers – Kurdish" lang="ku" hreflang="ku" data-title="Modul:Citation/CS1/Identifiers" data-language-autonym="Kurdî" data-language-local-name="Kurdish" class="interlanguage-link-target"><span>Kurdî</span></a></li><li class="interlanguage-link interwiki-lld mw-list-item"><a href="https://lld.wikipedia.org/wiki/Modulo:Citation/CS1/Identifiers" title="Modulo:Citation/CS1/Identifiers – Ladin" lang="lld" hreflang="lld" data-title="Modulo:Citation/CS1/Identifiers" data-language-autonym="Ladin" data-language-local-name="Ladin" class="interlanguage-link-target"><span>Ladin</span></a></li><li class="interlanguage-link interwiki-lad mw-list-item"><a href="https://lad.wikipedia.org/wiki/M%C3%B3dulo:Citation/CS1/Identifiers" title="Módulo:Citation/CS1/Identifiers – Ladino" lang="lad" hreflang="lad" data-title="Módulo:Citation/CS1/Identifiers" data-language-autonym="Ladino" data-language-local-name="Ladino" class="interlanguage-link-target"><span>Ladino</span></a></li><li class="interlanguage-link interwiki-lt mw-list-item"><a href="https://lt.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Lithuanian" lang="lt" hreflang="lt" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Lietuvių" data-language-local-name="Lithuanian" class="interlanguage-link-target"><span>Lietuvių</span></a></li><li class="interlanguage-link interwiki-lfn mw-list-item"><a href="https://lfn.wikipedia.org/wiki/Modulo:Citation/CS1/Identifiers" title="Modulo:Citation/CS1/Identifiers – Lingua Franca Nova" lang="lfn" hreflang="lfn" data-title="Modulo:Citation/CS1/Identifiers" data-language-autonym="Lingua Franca Nova" data-language-local-name="Lingua Franca Nova" class="interlanguage-link-target"><span>Lingua Franca Nova</span></a></li><li class="interlanguage-link interwiki-hu mw-list-item"><a href="https://hu.wikipedia.org/wiki/Modul:Citation/CS1/Identifiers" title="Modul:Citation/CS1/Identifiers – Hungarian" lang="hu" hreflang="hu" data-title="Modul:Citation/CS1/Identifiers" data-language-autonym="Magyar" data-language-local-name="Hungarian" class="interlanguage-link-target"><span>Magyar</span></a></li><li class="interlanguage-link interwiki-mad mw-list-item"><a href="https://mad.wikipedia.org/wiki/Modul:Citation/CS1/Identifiers" title="Modul:Citation/CS1/Identifiers – Madurese" lang="mad" hreflang="mad" data-title="Modul:Citation/CS1/Identifiers" data-language-autonym="Madhurâ" data-language-local-name="Madurese" class="interlanguage-link-target"><span>Madhurâ</span></a></li><li class="interlanguage-link interwiki-mai mw-list-item"><a href="https://mai.wikipedia.org/wiki/%E0%A4%AE%E0%A5%8B%E0%A4%A1%E0%A5%8D%E0%A4%AF%E0%A5%81%E0%A4%B2:Citation/CS1/Identifiers" title="मोड्युल:Citation/CS1/Identifiers – Maithili" lang="mai" hreflang="mai" data-title="मोड्युल:Citation/CS1/Identifiers" data-language-autonym="मैथिली" data-language-local-name="Maithili" class="interlanguage-link-target"><span>मैथिली</span></a></li><li class="interlanguage-link interwiki-mk mw-list-item"><a href="https://mk.wikipedia.org/wiki/%D0%9C%D0%BE%D0%B4%D1%83%D0%BB:Citation/CS1/Identifiers" title="Модул:Citation/CS1/Identifiers – Macedonian" lang="mk" hreflang="mk" data-title="Модул:Citation/CS1/Identifiers" data-language-autonym="Македонски" data-language-local-name="Macedonian" class="interlanguage-link-target"><span>Македонски</span></a></li><li class="interlanguage-link interwiki-mg mw-list-item"><a href="https://mg.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Malagasy" lang="mg" hreflang="mg" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Malagasy" data-language-local-name="Malagasy" class="interlanguage-link-target"><span>Malagasy</span></a></li><li class="interlanguage-link interwiki-ml mw-list-item"><a href="https://ml.wikipedia.org/wiki/%E0%B4%98%E0%B4%9F%E0%B4%95%E0%B4%82:Citation/CS1/Identifiers" title="ഘടകം:Citation/CS1/Identifiers – Malayalam" lang="ml" hreflang="ml" data-title="ഘടകം:Citation/CS1/Identifiers" data-language-autonym="മലയാളം" data-language-local-name="Malayalam" class="interlanguage-link-target"><span>മലയാളം</span></a></li><li class="interlanguage-link interwiki-mt mw-list-item"><a href="https://mt.wikipedia.org/wiki/Module:%C4%8Aitazzjoni/CS1/Identifiers" title="Module:Ċitazzjoni/CS1/Identifiers – Maltese" lang="mt" hreflang="mt" data-title="Module:Ċitazzjoni/CS1/Identifiers" data-language-autonym="Malti" data-language-local-name="Maltese" class="interlanguage-link-target"><span>Malti</span></a></li><li class="interlanguage-link interwiki-mi mw-list-item"><a href="https://mi.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Māori" lang="mi" hreflang="mi" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Māori" data-language-local-name="Māori" class="interlanguage-link-target"><span>Māori</span></a></li><li class="interlanguage-link interwiki-arz mw-list-item"><a href="https://arz.wikipedia.org/wiki/%D9%88%D8%AD%D8%AF%D8%A9:Citation/CS1/Identifiers" title="وحدة:Citation/CS1/Identifiers – Egyptian Arabic" lang="arz" hreflang="arz" data-title="وحدة:Citation/CS1/Identifiers" data-language-autonym="مصرى" data-language-local-name="Egyptian Arabic" class="interlanguage-link-target"><span>مصرى</span></a></li><li class="interlanguage-link interwiki-mzn mw-list-item"><a href="https://mzn.wikipedia.org/wiki/%D9%85%D8%A7%DA%98%D9%88%D9%84:Citation/CS1/Identifiers" title="ماژول:Citation/CS1/Identifiers – Mazanderani" lang="mzn" hreflang="mzn" data-title="ماژول:Citation/CS1/Identifiers" data-language-autonym="مازِرونی" data-language-local-name="Mazanderani" class="interlanguage-link-target"><span>مازِرونی</span></a></li><li class="interlanguage-link interwiki-ms mw-list-item"><a href="https://ms.wikipedia.org/wiki/Modul:Citation/CS1/Identifiers" title="Modul:Citation/CS1/Identifiers – Malay" lang="ms" hreflang="ms" data-title="Modul:Citation/CS1/Identifiers" data-language-autonym="Bahasa Melayu" data-language-local-name="Malay" class="interlanguage-link-target"><span>Bahasa Melayu</span></a></li><li class="interlanguage-link interwiki-min mw-list-item"><a href="https://min.wikipedia.org/wiki/Modul:Citation/CS1/Identifiers" title="Modul:Citation/CS1/Identifiers – Minangkabau" lang="min" hreflang="min" data-title="Modul:Citation/CS1/Identifiers" data-language-autonym="Minangkabau" data-language-local-name="Minangkabau" class="interlanguage-link-target"><span>Minangkabau</span></a></li><li class="interlanguage-link interwiki-mwl mw-list-item"><a href="https://mwl.wikipedia.org/wiki/M%C3%B3dulo:Cita%C3%A7on/CS1/Eidenteficadores" title="Módulo:Citaçon/CS1/Eidenteficadores – Mirandese" lang="mwl" hreflang="mwl" data-title="Módulo:Citaçon/CS1/Eidenteficadores" data-language-autonym="Mirandés" data-language-local-name="Mirandese" class="interlanguage-link-target"><span>Mirandés</span></a></li><li class="interlanguage-link interwiki-mdf mw-list-item"><a href="https://mdf.wikipedia.org/wiki/%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C:Citation/CS1/Identifiers" title="Модуль:Citation/CS1/Identifiers – Moksha" lang="mdf" hreflang="mdf" data-title="Модуль:Citation/CS1/Identifiers" data-language-autonym="Мокшень" data-language-local-name="Moksha" class="interlanguage-link-target"><span>Мокшень</span></a></li><li class="interlanguage-link interwiki-mn mw-list-item"><a href="https://mn.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Mongolian" lang="mn" hreflang="mn" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Монгол" data-language-local-name="Mongolian" class="interlanguage-link-target"><span>Монгол</span></a></li><li class="interlanguage-link interwiki-my mw-list-item"><a href="https://my.wikipedia.org/wiki/%E1%80%99%E1%80%B1%E1%80%AC%E1%80%BA%E1%80%82%E1%80%BB%E1%80%B0%E1%80%B8:Citation/CS1/Identifiers" title="မော်ဂျူး:Citation/CS1/Identifiers – Burmese" lang="my" hreflang="my" data-title="မော်ဂျူး:Citation/CS1/Identifiers" data-language-autonym="မြန်မာဘာသာ" data-language-local-name="Burmese" class="interlanguage-link-target"><span>မြန်မာဘာသာ</span></a></li><li class="interlanguage-link interwiki-fj mw-list-item"><a href="https://fj.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Fijian" lang="fj" hreflang="fj" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Na Vosa Vakaviti" data-language-local-name="Fijian" class="interlanguage-link-target"><span>Na Vosa Vakaviti</span></a></li><li class="interlanguage-link interwiki-ne mw-list-item"><a href="https://ne.wikipedia.org/wiki/%E0%A4%AE%E0%A5%8B%E0%A4%A1%E0%A5%8D%E0%A4%AF%E0%A5%81%E0%A4%B2:%E0%A4%B8%E0%A5%8D%E0%A4%B0%E0%A5%8B%E0%A4%A4/%E0%A4%AA%E0%A4%B9%E0%A4%BF%E0%A4%9A%E0%A4%BE%E0%A4%A8%E0%A4%95%E0%A4%B0%E0%A5%8D%E0%A4%A4%E0%A4%BE" title="मोड्युल:स्रोत/पहिचानकर्ता – Nepali" lang="ne" hreflang="ne" data-title="मोड्युल:स्रोत/पहिचानकर्ता" data-language-autonym="नेपाली" data-language-local-name="Nepali" class="interlanguage-link-target"><span>नेपाली</span></a></li><li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://ja.wikipedia.org/wiki/%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB:Citation/CS1/Identifiers" title="モジュール:Citation/CS1/Identifiers – Japanese" lang="ja" hreflang="ja" data-title="モジュール:Citation/CS1/Identifiers" data-language-autonym="日本語" data-language-local-name="Japanese" class="interlanguage-link-target"><span>日本語</span></a></li><li class="interlanguage-link interwiki-ce mw-list-item"><a href="https://ce.wikipedia.org/wiki/%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C:Citation/CS1/Identifiers" title="Модуль:Citation/CS1/Identifiers – Chechen" lang="ce" hreflang="ce" data-title="Модуль:Citation/CS1/Identifiers" data-language-autonym="Нохчийн" data-language-local-name="Chechen" class="interlanguage-link-target"><span>Нохчийн</span></a></li><li class="interlanguage-link interwiki-frr mw-list-item"><a href="https://frr.wikipedia.org/wiki/Modul:Citation/CS1/Identifiers" title="Modul:Citation/CS1/Identifiers – Northern Frisian" lang="frr" hreflang="frr" data-title="Modul:Citation/CS1/Identifiers" data-language-autonym="Nordfriisk" data-language-local-name="Northern Frisian" class="interlanguage-link-target"><span>Nordfriisk</span></a></li><li class="interlanguage-link interwiki-no mw-list-item"><a href="https://no.wikipedia.org/wiki/Modul:Citation/CS1/Identifiers" title="Modul:Citation/CS1/Identifiers – Norwegian Bokmål" lang="nb" hreflang="nb" data-title="Modul:Citation/CS1/Identifiers" data-language-autonym="Norsk bokmål" data-language-local-name="Norwegian Bokmål" class="interlanguage-link-target"><span>Norsk bokmål</span></a></li><li class="interlanguage-link interwiki-oc mw-list-item"><a href="https://oc.wikipedia.org/wiki/M%C3%B2dul:Ref-citacion/CS1/Identificadors" title="Mòdul:Ref-citacion/CS1/Identificadors – Occitan" lang="oc" hreflang="oc" data-title="Mòdul:Ref-citacion/CS1/Identificadors" data-language-autonym="Occitan" data-language-local-name="Occitan" class="interlanguage-link-target"><span>Occitan</span></a></li><li class="interlanguage-link interwiki-or mw-list-item"><a href="https://or.wikipedia.org/wiki/%E0%AC%AE%E0%AC%A1%E0%AD%8D%E0%AD%9F%E0%AD%81%E0%AC%B2:Citation/CS1/Identifiers" title="ମଡ୍ୟୁଲ:Citation/CS1/Identifiers – Odia" lang="or" hreflang="or" data-title="ମଡ୍ୟୁଲ:Citation/CS1/Identifiers" data-language-autonym="ଓଡ଼ିଆ" data-language-local-name="Odia" class="interlanguage-link-target"><span>ଓଡ଼ିଆ</span></a></li><li class="interlanguage-link interwiki-uz mw-list-item"><a href="https://uz.wikipedia.org/wiki/Modul:Manba/MU1/Identifiers" title="Modul:Manba/MU1/Identifiers – Uzbek" lang="uz" hreflang="uz" data-title="Modul:Manba/MU1/Identifiers" data-language-autonym="Oʻzbekcha / ўзбекча" data-language-local-name="Uzbek" class="interlanguage-link-target"><span>Oʻzbekcha / ўзбекча</span></a></li><li class="interlanguage-link interwiki-pa mw-list-item"><a href="https://pa.wikipedia.org/wiki/%E0%A8%AE%E0%A9%8C%E0%A8%A1%E0%A8%BF%E0%A8%8A%E0%A8%B2:Citation/CS1/Identifiers" title="ਮੌਡਿਊਲ:Citation/CS1/Identifiers – Punjabi" lang="pa" hreflang="pa" data-title="ਮੌਡਿਊਲ:Citation/CS1/Identifiers" data-language-autonym="ਪੰਜਾਬੀ" data-language-local-name="Punjabi" class="interlanguage-link-target"><span>ਪੰਜਾਬੀ</span></a></li><li class="interlanguage-link interwiki-blk mw-list-item"><a href="https://blk.wikipedia.org/wiki/%E1%80%99%E1%80%B1%E1%80%AC%E1%80%BA%E1%80%82%E1%80%BB%E1%80%B0%E1%80%B8:Citation/CS1/Identifiers" title="မော်ဂျူး:Citation/CS1/Identifiers – Pa&#039;O" lang="blk" hreflang="blk" data-title="မော်ဂျူး:Citation/CS1/Identifiers" data-language-autonym="ပအိုဝ်ႏဘာႏသာႏ" data-language-local-name="Pa&#039;O" class="interlanguage-link-target"><span>ပအိုဝ်ႏဘာႏသာႏ</span></a></li><li class="interlanguage-link interwiki-ps mw-list-item"><a href="https://ps.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Pashto" lang="ps" hreflang="ps" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="پښتو" data-language-local-name="Pashto" class="interlanguage-link-target"><span>پښتو</span></a></li><li class="interlanguage-link interwiki-km mw-list-item"><a href="https://km.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Khmer" lang="km" hreflang="km" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="ភាសាខ្មែរ" data-language-local-name="Khmer" class="interlanguage-link-target"><span>ភាសាខ្មែរ</span></a></li><li class="interlanguage-link interwiki-tpi mw-list-item"><a href="https://tpi.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Tok Pisin" lang="tpi" hreflang="tpi" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Tok Pisin" data-language-local-name="Tok Pisin" class="interlanguage-link-target"><span>Tok Pisin</span></a></li><li class="interlanguage-link interwiki-pt mw-list-item"><a href="https://pt.wikipedia.org/wiki/M%C3%B3dulo:Cita%C3%A7%C3%A3o/CS1/Identificadores" title="Módulo:Citação/CS1/Identificadores – Portuguese" lang="pt" hreflang="pt" data-title="Módulo:Citação/CS1/Identificadores" data-language-autonym="Português" data-language-local-name="Portuguese" class="interlanguage-link-target"><span>Português</span></a></li><li class="interlanguage-link interwiki-kaa mw-list-item"><a href="https://kaa.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Kara-Kalpak" lang="kaa" hreflang="kaa" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Qaraqalpaqsha" data-language-local-name="Kara-Kalpak" class="interlanguage-link-target"><span>Qaraqalpaqsha</span></a></li><li class="interlanguage-link interwiki-rue mw-list-item"><a href="https://rue.wikipedia.org/wiki/%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C:Citation/CS1/Identifiers" title="Модуль:Citation/CS1/Identifiers – Rusyn" lang="rue" hreflang="rue" data-title="Модуль:Citation/CS1/Identifiers" data-language-autonym="Русиньскый" data-language-local-name="Rusyn" class="interlanguage-link-target"><span>Русиньскый</span></a></li><li class="interlanguage-link interwiki-ru mw-list-item"><a href="https://ru.wikipedia.org/wiki/%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C:Citation/CS1/Identifiers" title="Модуль:Citation/CS1/Identifiers – Russian" lang="ru" hreflang="ru" data-title="Модуль:Citation/CS1/Identifiers" data-language-autonym="Русский" data-language-local-name="Russian" class="interlanguage-link-target"><span>Русский</span></a></li><li class="interlanguage-link interwiki-sat mw-list-item"><a href="https://sat.wikipedia.org/wiki/%E1%B1%A2%E1%B1%B3%E1%B1%B0%E1%B1%A9%E1%B1%9E:Citation/CS1/Identifiers" title="ᱢᱳᱰᱩᱞ:Citation/CS1/Identifiers – Santali" lang="sat" hreflang="sat" data-title="ᱢᱳᱰᱩᱞ:Citation/CS1/Identifiers" data-language-autonym="ᱥᱟᱱᱛᱟᱲᱤ" data-language-local-name="Santali" class="interlanguage-link-target"><span>ᱥᱟᱱᱛᱟᱲᱤ</span></a></li><li class="interlanguage-link interwiki-skr mw-list-item"><a href="https://skr.wikipedia.org/wiki/%D9%85%D8%A7%DA%88%DB%8C%D9%88%D9%84:Citation/CS1/Identifiers" title="ماڈیول:Citation/CS1/Identifiers – Saraiki" lang="skr" hreflang="skr" data-title="ماڈیول:Citation/CS1/Identifiers" data-language-autonym="سرائیکی" data-language-local-name="Saraiki" class="interlanguage-link-target"><span>سرائیکی</span></a></li><li class="interlanguage-link interwiki-sco mw-list-item"><a href="https://sco.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Scots" lang="sco" hreflang="sco" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Scots" data-language-local-name="Scots" class="interlanguage-link-target"><span>Scots</span></a></li><li class="interlanguage-link interwiki-trv mw-list-item"><a href="https://trv.wikipedia.org/wiki/%E6%A8%A1%E7%B5%84:Citation/CS1/Identifiers" title="模組:Citation/CS1/Identifiers – Taroko" lang="trv" hreflang="trv" data-title="模組:Citation/CS1/Identifiers" data-language-autonym="Seediq" data-language-local-name="Taroko" class="interlanguage-link-target"><span>Seediq</span></a></li><li class="interlanguage-link interwiki-sq mw-list-item"><a href="https://sq.wikipedia.org/wiki/Moduli:Citation/CS1/Identifiers" title="Moduli:Citation/CS1/Identifiers – Albanian" lang="sq" hreflang="sq" data-title="Moduli:Citation/CS1/Identifiers" data-language-autonym="Shqip" data-language-local-name="Albanian" class="interlanguage-link-target"><span>Shqip</span></a></li><li class="interlanguage-link interwiki-si mw-list-item"><a href="https://si.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Sinhala" lang="si" hreflang="si" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="සිංහල" data-language-local-name="Sinhala" class="interlanguage-link-target"><span>සිංහල</span></a></li><li class="interlanguage-link interwiki-simple mw-list-item"><a href="https://simple.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Simple English" lang="en-simple" hreflang="en-simple" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Simple English" data-language-local-name="Simple English" class="interlanguage-link-target"><span>Simple English</span></a></li><li class="interlanguage-link interwiki-sd mw-list-item"><a href="https://sd.wikipedia.org/wiki/%D9%85%D8%A7%DA%8A%D9%8A%D9%88%D9%84:Citation/CS1/Identifiers" title="ماڊيول:Citation/CS1/Identifiers – Sindhi" lang="sd" hreflang="sd" data-title="ماڊيول:Citation/CS1/Identifiers" data-language-autonym="سنڌي" data-language-local-name="Sindhi" class="interlanguage-link-target"><span>سنڌي</span></a></li><li class="interlanguage-link interwiki-sl mw-list-item"><a href="https://sl.wikipedia.org/wiki/Modul:Citation/CS1/Identifiers" title="Modul:Citation/CS1/Identifiers – Slovenian" lang="sl" hreflang="sl" data-title="Modul:Citation/CS1/Identifiers" data-language-autonym="Slovenščina" data-language-local-name="Slovenian" class="interlanguage-link-target"><span>Slovenščina</span></a></li><li class="interlanguage-link interwiki-ckb mw-list-item"><a href="https://ckb.wikipedia.org/wiki/%D9%85%DB%86%D8%AF%DB%8C%D9%88%D9%88%D9%84:Citation/CS1/Identifiers" title="مۆدیوول:Citation/CS1/Identifiers – Central Kurdish" lang="ckb" hreflang="ckb" data-title="مۆدیوول:Citation/CS1/Identifiers" data-language-autonym="کوردی" data-language-local-name="Central Kurdish" class="interlanguage-link-target"><span>کوردی</span></a></li><li class="interlanguage-link interwiki-sr mw-list-item"><a href="https://sr.wikipedia.org/wiki/%D0%9C%D0%BE%D0%B4%D1%83%D0%BB:Citation/CS1/Identifiers" title="Модул:Citation/CS1/Identifiers – Serbian" lang="sr" hreflang="sr" data-title="Модул:Citation/CS1/Identifiers" data-language-autonym="Српски / srpski" data-language-local-name="Serbian" class="interlanguage-link-target"><span>Српски / srpski</span></a></li><li class="interlanguage-link interwiki-sh mw-list-item"><a href="https://sh.wikipedia.org/wiki/Modul:Citation/CS1/Identifiers" title="Modul:Citation/CS1/Identifiers – Serbo-Croatian" lang="sh" hreflang="sh" data-title="Modul:Citation/CS1/Identifiers" data-language-autonym="Srpskohrvatski / српскохрватски" data-language-local-name="Serbo-Croatian" class="interlanguage-link-target"><span>Srpskohrvatski / српскохрватски</span></a></li><li class="interlanguage-link interwiki-tl mw-list-item"><a href="https://tl.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Tagalog" lang="tl" hreflang="tl" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Tagalog" data-language-local-name="Tagalog" class="interlanguage-link-target"><span>Tagalog</span></a></li><li class="interlanguage-link interwiki-ta mw-list-item"><a href="https://ta.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Tamil" lang="ta" hreflang="ta" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="தமிழ்" data-language-local-name="Tamil" class="interlanguage-link-target"><span>தமிழ்</span></a></li><li class="interlanguage-link interwiki-kab mw-list-item"><a href="https://kab.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Kabyle" lang="kab" hreflang="kab" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Taqbaylit" data-language-local-name="Kabyle" class="interlanguage-link-target"><span>Taqbaylit</span></a></li><li class="interlanguage-link interwiki-tt mw-list-item"><a href="https://tt.wikipedia.org/wiki/%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C:Citation/CS1/Identifiers" title="Модуль:Citation/CS1/Identifiers – Tatar" lang="tt" hreflang="tt" data-title="Модуль:Citation/CS1/Identifiers" data-language-autonym="Татарча / tatarça" data-language-local-name="Tatar" class="interlanguage-link-target"><span>Татарча / tatarça</span></a></li><li class="interlanguage-link interwiki-shn mw-list-item"><a href="https://shn.wikipedia.org/wiki/%E1%80%99%E1%80%B1%E1%82%83%E1%82%87%E1%81%B5%E1%80%BB%E1%80%B0%E1%80%B8:Citation/CS1/Identifiers" title="မေႃႇၵျူး:Citation/CS1/Identifiers – Shan" lang="shn" hreflang="shn" data-title="မေႃႇၵျူး:Citation/CS1/Identifiers" data-language-autonym="တႆး" data-language-local-name="Shan" class="interlanguage-link-target"><span>တႆး</span></a></li><li class="interlanguage-link interwiki-th mw-list-item"><a href="https://th.wikipedia.org/wiki/%E0%B8%A1%E0%B8%AD%E0%B8%94%E0%B8%B9%E0%B8%A5:Citation/CS1/Identifiers" title="มอดูล:Citation/CS1/Identifiers – Thai" lang="th" hreflang="th" data-title="มอดูล:Citation/CS1/Identifiers" data-language-autonym="ไทย" data-language-local-name="Thai" class="interlanguage-link-target"><span>ไทย</span></a></li><li class="interlanguage-link interwiki-ti mw-list-item"><a href="https://ti.wikipedia.org/wiki/%E1%88%9E%E1%8B%B5%E1%8B%A9%E1%88%8D:Identifiers" title="ሞድዩል:Identifiers – Tigrinya" lang="ti" hreflang="ti" data-title="ሞድዩል:Identifiers" data-language-autonym="ትግርኛ" data-language-local-name="Tigrinya" class="interlanguage-link-target"><span>ትግርኛ</span></a></li><li class="interlanguage-link interwiki-tg mw-list-item"><a href="https://tg.wikipedia.org/wiki/%D0%9C%D0%BE%D0%B4%D1%83%D0%BB:Citation/CS1/Identifiers" title="Модул:Citation/CS1/Identifiers – Tajik" lang="tg" hreflang="tg" data-title="Модул:Citation/CS1/Identifiers" data-language-autonym="Тоҷикӣ" data-language-local-name="Tajik" class="interlanguage-link-target"><span>Тоҷикӣ</span></a></li><li class="interlanguage-link interwiki-chr mw-list-item"><a href="https://chr.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Cherokee" lang="chr" hreflang="chr" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="ᏣᎳᎩ" data-language-local-name="Cherokee" class="interlanguage-link-target"><span>ᏣᎳᎩ</span></a></li><li class="interlanguage-link interwiki-tcy mw-list-item"><a href="https://tcy.wikipedia.org/wiki/%E0%B2%AE%E0%B3%8B%E0%B2%A1%E0%B3%8D%E0%B2%AF%E0%B3%82%E0%B2%B2%E0%B3%8D:Citation/CS1/Identifiers" title="ಮೋಡ್ಯೂಲ್:Citation/CS1/Identifiers – Tulu" lang="tcy" hreflang="tcy" data-title="ಮೋಡ್ಯೂಲ್:Citation/CS1/Identifiers" data-language-autonym="ತುಳು" data-language-local-name="Tulu" class="interlanguage-link-target"><span>ತುಳು</span></a></li><li class="interlanguage-link interwiki-tr mw-list-item"><a href="https://tr.wikipedia.org/wiki/Mod%C3%BCl:Kaynak/KB1/Tan%C4%B1mlay%C4%B1c%C4%B1lar" title="Modül:Kaynak/KB1/Tanımlayıcılar – Turkish" lang="tr" hreflang="tr" data-title="Modül:Kaynak/KB1/Tanımlayıcılar" data-language-autonym="Türkçe" data-language-local-name="Turkish" class="interlanguage-link-target"><span>Türkçe</span></a></li><li class="interlanguage-link interwiki-tw mw-list-item"><a href="https://tw.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Twi" lang="tw" hreflang="tw" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Twi" data-language-local-name="Twi" class="interlanguage-link-target"><span>Twi</span></a></li><li class="interlanguage-link interwiki-uk mw-list-item"><a href="https://uk.wikipedia.org/wiki/%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C:Citation/CS1/Identifiers" title="Модуль:Citation/CS1/Identifiers – Ukrainian" lang="uk" hreflang="uk" data-title="Модуль:Citation/CS1/Identifiers" data-language-autonym="Українська" data-language-local-name="Ukrainian" class="interlanguage-link-target"><span>Українська</span></a></li><li class="interlanguage-link interwiki-ur mw-list-item"><a href="https://ur.wikipedia.org/wiki/%D9%85%D8%A7%DA%88%DB%8C%D9%88%D9%84:Citation/CS1/Identifiers" title="ماڈیول:Citation/CS1/Identifiers – Urdu" lang="ur" hreflang="ur" data-title="ماڈیول:Citation/CS1/Identifiers" data-language-autonym="اردو" data-language-local-name="Urdu" class="interlanguage-link-target"><span>اردو</span></a></li><li class="interlanguage-link interwiki-za mw-list-item"><a href="https://za.wikipedia.org/wiki/%E6%A8%A1%E5%9D%97:Citation/CS1/Identifiers" title="模块:Citation/CS1/Identifiers – Zhuang" lang="za" hreflang="za" data-title="模块:Citation/CS1/Identifiers" data-language-autonym="Vahcuengh" data-language-local-name="Zhuang" class="interlanguage-link-target"><span>Vahcuengh</span></a></li><li class="interlanguage-link interwiki-vi mw-list-item"><a href="https://vi.wikipedia.org/wiki/M%C3%B4_%C4%91un:Citation/CS1/Identifiers" title="Mô đun:Citation/CS1/Identifiers – Vietnamese" lang="vi" hreflang="vi" data-title="Mô đun:Citation/CS1/Identifiers" data-language-autonym="Tiếng Việt" data-language-local-name="Vietnamese" class="interlanguage-link-target"><span>Tiếng Việt</span></a></li><li class="interlanguage-link interwiki-vo mw-list-item"><a href="https://vo.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Volapük" lang="vo" hreflang="vo" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Volapük" data-language-local-name="Volapük" class="interlanguage-link-target"><span>Volapük</span></a></li><li class="interlanguage-link interwiki-war mw-list-item"><a href="https://war.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Waray" lang="war" hreflang="war" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="Winaray" data-language-local-name="Waray" class="interlanguage-link-target"><span>Winaray</span></a></li><li class="interlanguage-link interwiki-zh-yue mw-list-item"><a href="https://zh-yue.wikipedia.org/wiki/%E6%A8%A1%E7%B5%84:Citation/CS1/Identifiers" title="模組:Citation/CS1/Identifiers – Cantonese" lang="yue" hreflang="yue" data-title="模組:Citation/CS1/Identifiers" data-language-autonym="粵語" data-language-local-name="Cantonese" class="interlanguage-link-target"><span>粵語</span></a></li><li class="interlanguage-link interwiki-zh mw-list-item"><a href="https://zh.wikipedia.org/wiki/Module:Citation/CS1/Identifiers" title="Module:Citation/CS1/Identifiers – Chinese" lang="zh" hreflang="zh" data-title="Module:Citation/CS1/Identifiers" data-language-autonym="中文" data-language-local-name="Chinese" class="interlanguage-link-target"><span>中文</span></a></li><li class="interlanguage-link interwiki-iba mw-list-item"><a href="https://iba.wikipedia.org/wiki/Modul:Citation/CS1/Identifiers" title="Modul:Citation/CS1/Identifiers – Iban" lang="iba" hreflang="iba" data-title="Modul:Citation/CS1/Identifiers" data-language-autonym="Jaku Iban" data-language-local-name="Iban" class="interlanguage-link-target"><span>Jaku Iban</span></a></li><li class="interlanguage-link interwiki-kge mw-list-item"><a href="https://kge.wikipedia.org/wiki/Modul:Citation/CS1/Identifiers" title="Modul:Citation/CS1/Identifiers – Komering" lang="kge" hreflang="kge" data-title="Modul:Citation/CS1/Identifiers" data-language-autonym="Kumoring" data-language-local-name="Komering" class="interlanguage-link-target"><span>Kumoring</span></a></li>
			</ul>
			<div class="after-portlet after-portlet-lang"><span class="wb-langlinks-edit wb-langlinks-link"><a href="https://www.wikidata.org/wiki/Special:EntityPage/Q19841691#sitelinks-wikipedia" title="Edit interlanguage links" class="wbc-editpage">Edit links</a></span></div>
		</div>

	</div>
</div>
</header>
				<div class="vector-page-toolbar">
					<div class="vector-page-toolbar-container">
						<div id="left-navigation">
							<nav aria-label="Namespaces">
								
<div id="p-associated-pages" class="vector-menu vector-menu-tabs mw-portlet mw-portlet-associated-pages"  >
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
			
			<li id="ca-nstab-module" class="selected vector-tab-noicon mw-list-item"><a href="/wiki/Module:Citation/CS1/Identifiers" title="View the module page [c]" accesskey="c"><span>Module</span></a></li><li id="ca-talk" class="vector-tab-noicon mw-list-item"><a href="/wiki/Module_talk:Citation/CS1/Identifiers" rel="discussion" class="mw-redirect" title="Discuss improvements to the content page [t]" accesskey="t"><span>Talk</span></a></li>
		</ul>
		
	</div>
</div>

								
<div id="vector-variants-dropdown" class="vector-dropdown emptyPortlet"  >
	<input type="checkbox" id="vector-variants-dropdown-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-variants-dropdown" class="vector-dropdown-checkbox " aria-label="Change language variant"   >
	<label id="vector-variants-dropdown-label" for="vector-variants-dropdown-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet" aria-hidden="true"  ><span class="vector-dropdown-label-text">English</span>
	</label>
	<div class="vector-dropdown-content">


					
<div id="p-variants" class="vector-menu mw-portlet mw-portlet-variants emptyPortlet"  >
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
			
			
		</ul>
		
	</div>
</div>

				
	</div>
</div>

							</nav>
						</div>
						<div id="right-navigation" class="vector-collapsible">
							<nav aria-label="Views">
								
<div id="p-views" class="vector-menu vector-menu-tabs mw-portlet mw-portlet-views"  >
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
			
			<li id="ca-view" class="selected vector-tab-noicon mw-list-item"><a href="/wiki/Module:Citation/CS1/Identifiers"><span>Read</span></a></li><li id="ca-viewsource" class="vector-tab-noicon mw-list-item"><a href="/w/index.php?title=Module:Citation/CS1/Identifiers&amp;action=edit" title="This page is protected.&#10;You can view its source [e]" accesskey="e"><span>View source</span></a></li><li id="ca-history" class="vector-tab-noicon mw-list-item"><a href="/w/index.php?title=Module:Citation/CS1/Identifiers&amp;action=history" title="Past revisions of this page [h]" accesskey="h"><span>View history</span></a></li>
		</ul>
		
	</div>
</div>

							</nav>
				
							<nav class="vector-page-tools-landmark" aria-label="Page tools">
								
<div id="vector-page-tools-dropdown" class="vector-dropdown vector-page-tools-dropdown"  >
	<input type="checkbox" id="vector-page-tools-dropdown-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-tools-dropdown" class="vector-dropdown-checkbox "  aria-label="Tools"  >
	<label id="vector-page-tools-dropdown-label" for="vector-page-tools-dropdown-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet" aria-hidden="true"  ><span class="vector-dropdown-label-text">Tools</span>
	</label>
	<div class="vector-dropdown-content">


									<div id="vector-page-tools-unpinned-container" class="vector-unpinned-container">
						
<div id="vector-page-tools" class="vector-page-tools vector-pinnable-element">
	<div
	class="vector-pinnable-header vector-page-tools-pinnable-header vector-pinnable-header-unpinned"
	data-feature-name="page-tools-pinned"
	data-pinnable-element-id="vector-page-tools"
	data-pinned-container-id="vector-page-tools-pinned-container"
	data-unpinned-container-id="vector-page-tools-unpinned-container"
>
	<div class="vector-pinnable-header-label">Tools</div>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-page-tools.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-page-tools.unpin">hide</button>
</div>

	
<div id="p-cactions" class="vector-menu mw-portlet mw-portlet-cactions emptyPortlet vector-has-collapsible-items"  title="More options" >
	<div class="vector-menu-heading">
		Actions
	</div>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
			
			<li id="ca-more-view" class="selected vector-more-collapsible-item mw-list-item"><a href="/wiki/Module:Citation/CS1/Identifiers"><span>Read</span></a></li><li id="ca-more-viewsource" class="vector-more-collapsible-item mw-list-item"><a href="/w/index.php?title=Module:Citation/CS1/Identifiers&amp;action=edit"><span>View source</span></a></li><li id="ca-more-history" class="vector-more-collapsible-item mw-list-item"><a href="/w/index.php?title=Module:Citation/CS1/Identifiers&amp;action=history"><span>View history</span></a></li>
		</ul>
		
	</div>
</div>

<div id="p-tb" class="vector-menu mw-portlet mw-portlet-tb"  >
	<div class="vector-menu-heading">
		General
	</div>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
			
			<li id="t-whatlinkshere" class="mw-list-item"><a href="/wiki/Special:WhatLinksHere/Module:Citation/CS1/Identifiers" title="List of all English Wikipedia pages containing links to this page [j]" accesskey="j"><span>What links here</span></a></li><li id="t-recentchangeslinked" class="mw-list-item"><a href="/wiki/Special:RecentChangesLinked/Module:Citation/CS1/Identifiers" rel="nofollow" title="Recent changes in pages linked from this page [k]" accesskey="k"><span>Related changes</span></a></li><li id="t-upload" class="mw-list-item"><a href="//en.wikipedia.org/wiki/Wikipedia:File_Upload_Wizard" title="Upload files [u]" accesskey="u"><span>Upload file</span></a></li><li id="t-permalink" class="mw-list-item"><a href="/w/index.php?title=Module:Citation/CS1/Identifiers&amp;oldid=1265768031" title="Permanent link to this revision of this page"><span>Permanent link</span></a></li><li id="t-info" class="mw-list-item"><a href="/w/index.php?title=Module:Citation/CS1/Identifiers&amp;action=info" title="More information about this page"><span>Page information</span></a></li><li id="t-urlshortener" class="mw-list-item"><a href="/w/index.php?title=Special:UrlShortener&amp;url=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FModule%3ACitation%2FCS1%2FIdentifiers"><span>Get shortened URL</span></a></li><li id="t-urlshortener-qrcode" class="mw-list-item"><a href="/w/index.php?title=Special:QrCode&amp;url=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FModule%3ACitation%2FCS1%2FIdentifiers"><span>Download QR code</span></a></li>
		</ul>
		
	</div>
</div>

<div id="p-electronpdfservice-sidebar-portlet-heading" class="vector-menu mw-portlet mw-portlet-electronpdfservice-sidebar-portlet-heading"  >
	<div class="vector-menu-heading">
		Print/export
	</div>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
			
			<li id="electron-print_pdf" class="mw-list-item"><a href="/w/index.php?title=Special:DownloadAsPdf&amp;page=Module%3ACitation%2FCS1%2FIdentifiers&amp;action=show-download-screen"><span>Download as PDF</span></a></li><li id="t-print" class="mw-list-item"><a href="javascript:print();" rel="alternate" title="Printable version of this page [p]" accesskey="p"><span>Printable version</span></a></li>
		</ul>
		
	</div>
</div>

<div id="p-wikibase-otherprojects" class="vector-menu mw-portlet mw-portlet-wikibase-otherprojects"  >
	<div class="vector-menu-heading">
		In other projects
	</div>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
			
			<li class="wb-otherproject-link wb-otherproject-commons mw-list-item"><a href="https://commons.wikimedia.org/wiki/Module:Citation/CS1/Identifiers" hreflang="en"><span>Wikimedia Commons</span></a></li><li class="wb-otherproject-link wb-otherproject-species mw-list-item"><a href="https://species.wikimedia.org/wiki/Module:Citation/CS1/Identifiers" hreflang="en"><span>Wikispecies</span></a></li><li class="wb-otherproject-link wb-otherproject-wikibooks mw-list-item"><a href="https://en.wikibooks.org/wiki/Module:Citation/CS1/Identifiers" hreflang="en"><span>Wikibooks</span></a></li><li class="wb-otherproject-link wb-otherproject-wikidata mw-list-item"><a href="https://www.wikidata.org/wiki/Module:Citation/CS1/Identifiers" hreflang="en"><span>Wikidata</span></a></li><li class="wb-otherproject-link wb-otherproject-wikisource mw-list-item"><a href="https://en.wikisource.org/wiki/Module:Citation/CS1/Identifiers" hreflang="en"><span>Wikisource</span></a></li><li class="wb-otherproject-link wb-otherproject-wikiversity mw-list-item"><a href="https://en.wikiversity.org/wiki/Module:Citation/CS1/Identifiers" hreflang="en"><span>Wikiversity</span></a></li><li id="t-wikibase" class="wb-otherproject-link wb-otherproject-wikibase-dataitem mw-list-item"><a href="https://www.wikidata.org/wiki/Special:EntityPage/Q19841691" title="Structured data on this page hosted by Wikidata [g]" accesskey="g"><span>Wikidata item</span></a></li>
		</ul>
		
	</div>
</div>

</div>

									</div>
				
	</div>
</div>

							</nav>
						</div>
					</div>
				</div>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-appearance-landmark" aria-label="Appearance">
							<div id="vector-appearance-pinned-container" class="vector-pinned-container">
				<div id="vector-appearance" class="vector-appearance vector-pinnable-element">
	<div
	class="vector-pinnable-header vector-appearance-pinnable-header vector-pinnable-header-pinned"
	data-feature-name="appearance-pinned"
	data-pinnable-element-id="vector-appearance"
	data-pinned-container-id="vector-appearance-pinned-container"
	data-unpinned-container-id="vector-appearance-unpinned-container"
>
	<div class="vector-pinnable-header-label">Appearance</div>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-appearance.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-appearance.unpin">hide</button>
</div>


</div>

							</div>
		</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		<div id="mw-indicator-pp-default" class="mw-indicator"><div class="mw-parser-output"><span typeof="mw:File"><a href="/wiki/Wikipedia:Protection_policy#full" title="This high-risk module is permanently protected to prevent vandalism"><img alt="Permanently protected module" src="//upload.wikimedia.org/wikipedia/en/thumb/4/44/Full-protection-shackle.svg/20px-Full-protection-shackle.svg.png" decoding="async" width="20" height="20" class="mw-file-element" srcset="//upload.wikimedia.org/wikipedia/en/thumb/4/44/Full-protection-shackle.svg/30px-Full-protection-shackle.svg.png 1.5x, //upload.wikimedia.org/wikipedia/en/thumb/4/44/Full-protection-shackle.svg/40px-Full-protection-shackle.svg.png 2x" data-file-width="512" data-file-height="512" /></a></span></div></div>
		</div>

						<div id="siteSub" class="noprint">From Wikipedia, the free encyclopedia</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"><div class="subpages">&lt; <bdi dir="ltr"><a href="/wiki/Module:Citation" title="Module:Citation">Module:Citation</a></bdi> | <bdi dir="ltr"><a href="/wiki/Module:Citation/CS1" title="Module:Citation/CS1">CS1</a></bdi></div></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content"><div class="mw-content-ltr mw-parser-output" lang="en" dir="ltr"><style data-mw-deduplicate="TemplateStyles:r1277038544">.mw-parser-output .documentation,.mw-parser-output .documentation-metadata{border:1px solid var(--border-color-base,#a2a9b1);background-color:#ecfcf4;clear:both}.mw-parser-output .documentation{margin:1em 0 0 0;padding:1em}.mw-parser-output .documentation-metadata{margin:0.2em 0;font-style:italic;padding:0.4em 1em}.mw-parser-output .documentation-startbox{padding-bottom:3px;border-bottom:1px solid var(--border-color-base,#a2a9b1);margin-bottom:1ex}.mw-parser-output .documentation-heading{font-weight:bold;font-size:125%}.mw-parser-output .documentation-clear{clear:both}.mw-parser-output .documentation-toolbar{font-style:normal;font-size:85%}@media screen{html.skin-theme-clientpref-night .mw-parser-output .documentation,html.skin-theme-clientpref-night .mw-parser-output .documentation-metadata{background-color:#0b1e1c}}@media screen and (prefers-color-scheme:dark){html.skin-theme-clientpref-os .mw-parser-output .documentation,html.skin-theme-clientpref-os .mw-parser-output .documentation-metadata{background-color:#0b1e1c}}</style><div class="documentation-container" role="complementary" aria-labelledby="documentation-heading">
<div class="documentation">
<div class="documentation-startbox">
<span class="documentation-heading" id="documentation-heading"><span typeof="mw:File"><span><img alt="" src="//upload.wikimedia.org/wikipedia/commons/thumb/4/43/Test_Template_Info-Icon_-_Version_%282%29.svg/60px-Test_Template_Info-Icon_-_Version_%282%29.svg.png" decoding="async" width="50" height="22" class="mw-file-element" srcset="//upload.wikimedia.org/wikipedia/commons/thumb/4/43/Test_Template_Info-Icon_-_Version_%282%29.svg/120px-Test_Template_Info-Icon_-_Version_%282%29.svg.png 1.5x" data-file-width="1792" data-file-height="800" /></span></span> Module documentation</span><span class="mw-editsection-like plainlinks">&#91;<a href="/wiki/Module:Citation/CS1/Identifiers/doc" title="Module:Citation/CS1/Identifiers/doc">view</a>&#93; &#91;<a href="/wiki/Special:EditPage/Module:Citation/CS1/Identifiers/doc" title="Special:EditPage/Module:Citation/CS1/Identifiers/doc">edit</a>&#93; &#91;<a href="/wiki/Special:PageHistory/Module:Citation/CS1/Identifiers/doc" title="Special:PageHistory/Module:Citation/CS1/Identifiers/doc">history</a>&#93; &#91;<a href="/wiki/Special:Purge/Module:Citation/CS1/Identifiers" title="Special:Purge/Module:Citation/CS1/Identifiers">purge</a>&#93;</span></div>
<style data-mw-deduplicate="TemplateStyles:r1238436933">.mw-parser-output .ombox{margin:4px 0;border-collapse:collapse;border:1px solid #a2a9b1;background-color:var(--background-color-neutral-subtle,#f8f9fa);box-sizing:border-box;color:var(--color-base,#202122)}.mw-parser-output .ombox.mbox-small{font-size:88%;line-height:1.25em}.mw-parser-output .ombox-speedy{border:2px solid #b32424;background-color:#fee7e6}.mw-parser-output .ombox-delete{border:2px solid #b32424}.mw-parser-output .ombox-content{border:1px solid #f28500}.mw-parser-output .ombox-style{border:1px solid #fc3}.mw-parser-output .ombox-move{border:1px solid #9932cc}.mw-parser-output .ombox-protection{border:2px solid #a2a9b1}.mw-parser-output .ombox .mbox-text{border:none;padding:0.25em 0.9em;width:100%}.mw-parser-output .ombox .mbox-image{border:none;padding:2px 0 2px 0.9em;text-align:center}.mw-parser-output .ombox .mbox-imageright{border:none;padding:2px 0.9em 2px 0;text-align:center}.mw-parser-output .ombox .mbox-empty-cell{border:none;padding:0;width:1px}.mw-parser-output .ombox .mbox-invalid-type{text-align:center}@media(min-width:720px){.mw-parser-output .ombox{margin:4px 10%}.mw-parser-output .ombox.mbox-small{clear:right;float:right;margin:4px 0 4px 1em;width:238px}}body.skin--responsive .mw-parser-output table.ombox img{max-width:none!important}@media screen{html.skin-theme-clientpref-night .mw-parser-output .ombox-speedy{background-color:#310402}}@media screen and (prefers-color-scheme:dark){html.skin-theme-clientpref-os .mw-parser-output .ombox-speedy{background-color:#310402}}</style><table class="plainlinks ombox ombox-content" role="presentation"><tbody><tr><td class="mbox-image"><span typeof="mw:File"><span><img alt="Warning" src="//upload.wikimedia.org/wikipedia/en/thumb/5/5f/Ambox_warning_orange.svg/40px-Ambox_warning_orange.svg.png" decoding="async" width="40" height="34" class="mw-file-element" srcset="//upload.wikimedia.org/wikipedia/en/thumb/5/5f/Ambox_warning_orange.svg/60px-Ambox_warning_orange.svg.png 1.5x, //upload.wikimedia.org/wikipedia/en/thumb/5/5f/Ambox_warning_orange.svg/120px-Ambox_warning_orange.svg.png 2x" data-file-width="378" data-file-height="326" /></span></span></td><td class="mbox-text"><b>This Lua module is used on <a class="external text" href="https://linkcount.toolforge.org/?project=en.wikipedia.org&amp;page=Module%3ACitation%2FCS1%2FIdentifiers#transclusions">approximately&#x20;6,080,000 pages</a></b>.<br /> To avoid major disruption and server load, any changes should be tested in the module's <a href="/wiki/Module:Citation/CS1/Identifiers/sandbox" title="Module:Citation/CS1/Identifiers/sandbox">/sandbox</a> or <a href="/w/index.php?title=Module:Citation/CS1/Identifiers/testcases&amp;action=edit&amp;redlink=1" class="new" title="Module:Citation/CS1/Identifiers/testcases (page does not exist)">/testcases</a> subpages, or in your own <a href="/wiki/Module:Sandbox" title="Module:Sandbox">module sandbox</a>. The tested changes can be added to this page in a single edit. Consider discussing changes on the <a href="/wiki/Module_talk:Citation/CS1/Identifiers" class="mw-redirect" title="Module talk:Citation/CS1/Identifiers">talk page</a> before implementing them.</td></tr></tbody></table>
<link rel="mw-deduplicated-inline-style" href="mw-data:TemplateStyles:r1238436933" /><table class="plainlinks ombox ombox-notice" role="presentation"><tbody><tr><td class="mbox-image"><span typeof="mw:File"><span><img alt="Ready for use" src="//upload.wikimedia.org/wikipedia/commons/thumb/0/03/Green_check.svg/40px-Green_check.svg.png" decoding="async" width="40" height="40" class="mw-file-element" srcset="//upload.wikimedia.org/wikipedia/commons/thumb/0/03/Green_check.svg/60px-Green_check.svg.png 1.5x, //upload.wikimedia.org/wikipedia/commons/thumb/0/03/Green_check.svg/120px-Green_check.svg.png 2x" data-file-width="600" data-file-height="600" /></span></span></td><td class="mbox-text">This module is rated as <a href="/wiki/Category:Modules_for_general_use" title="Category:Modules for general use">ready for general use</a>. It has reached a mature form and is thought to be relatively bug-free and ready for use wherever appropriate. It is ready to mention on help pages and other Wikipedia resources as an option for new users to learn. To reduce server load and bad output, it should be improved by <a href="/wiki/Wikipedia:Template_sandbox_and_test_cases" title="Wikipedia:Template sandbox and test cases">sandbox testing</a> rather than repeated trial-and-error editing.</td></tr></tbody></table><link rel="mw-deduplicated-inline-style" href="mw-data:TemplateStyles:r1238436933" /><table class="plainlinks ombox ombox-notice" role="presentation"><tbody><tr><td class="mbox-image"><span typeof="mw:File"><span><img alt="Protected" src="//upload.wikimedia.org/wikipedia/en/thumb/4/44/Full-protection-shackle.svg/40px-Full-protection-shackle.svg.png" decoding="async" width="40" height="40" class="mw-file-element" srcset="//upload.wikimedia.org/wikipedia/en/thumb/4/44/Full-protection-shackle.svg/60px-Full-protection-shackle.svg.png 1.5x, //upload.wikimedia.org/wikipedia/en/thumb/4/44/Full-protection-shackle.svg/80px-Full-protection-shackle.svg.png 2x" data-file-width="512" data-file-height="512" /></span></span></td><td class="mbox-text">This module is <a href="/wiki/Category:Modules_subject_to_page_protection" title="Category:Modules subject to page protection">subject to page protection</a>. It is a <a href="/wiki/Wikipedia:High-risk_templates" title="Wikipedia:High-risk templates">highly visible module</a> in use by a very large number of pages, or is <a href="/wiki/Wikipedia:Substitution" title="Wikipedia:Substitution">substituted</a> very frequently. Because vandalism or mistakes would affect many pages, and even trivial editing might cause substantial load on the servers, it is <a href="/wiki/Wikipedia:Protection_policy" title="Wikipedia:Protection policy">protected</a> from editing.</td></tr></tbody></table>
<link rel="mw-deduplicated-inline-style" href="mw-data:TemplateStyles:r1238436933" /><table class="plainlinks ombox ombox-protection" role="presentation"><tbody><tr><td class="mbox-image"><span typeof="mw:File"><span><img alt="" src="//upload.wikimedia.org/wikipedia/en/thumb/0/0f/Cascade-protection-shackle.svg/40px-Cascade-protection-shackle.svg.png" decoding="async" width="40" height="40" class="mw-file-element" srcset="//upload.wikimedia.org/wikipedia/en/thumb/0/0f/Cascade-protection-shackle.svg/60px-Cascade-protection-shackle.svg.png 1.5x, //upload.wikimedia.org/wikipedia/en/thumb/0/0f/Cascade-protection-shackle.svg/80px-Cascade-protection-shackle.svg.png 2x" data-file-width="512" data-file-height="512" /></span></span></td><td class="mbox-text">This module can only be edited by <a href="/wiki/Wikipedia:Administrators" title="Wikipedia:Administrators">administrators</a> because it is <a href="/wiki/Help:Transclusion" title="Help:Transclusion">transcluded</a> onto one or more <a href="/wiki/Wikipedia:Protection_policy#Cascading_protection" title="Wikipedia:Protection policy">cascade-protected</a> pages.</td></tr></tbody></table>
<p>This page renders and performs error checking on the various named identifiers supported by <a href="/wiki/Module:Citation/CS1" title="Module:Citation/CS1">Module:Citation/CS1</a>.
</p><p><br />
These files comprise the module support for CS1|2 citation templates:
</p>
<table class="wikitable" style="margin: 1em auto 1em auto;">
<caption>CS1 &#124; CS2 modules
</caption>
<tbody><tr>
<th colspan="2">live</th>
<th colspan="2">sandbox</th>
<th>diff</th>
<th>description
</th></tr>
<tr>
<td rowspan="8"><span typeof="mw:File"><span title="sysop"><img alt="Gold padlock" src="//upload.wikimedia.org/wikipedia/en/thumb/4/44/Full-protection-shackle.svg/20px-Full-protection-shackle.svg.png" decoding="async" width="20" height="20" class="mw-file-element" srcset="//upload.wikimedia.org/wikipedia/en/thumb/4/44/Full-protection-shackle.svg/30px-Full-protection-shackle.svg.png 1.5x, //upload.wikimedia.org/wikipedia/en/thumb/4/44/Full-protection-shackle.svg/40px-Full-protection-shackle.svg.png 2x" data-file-width="512" data-file-height="512" /></span></span></td>
<td><a href="/wiki/Module:Citation/CS1" title="Module:Citation/CS1">Module:Citation/CS1</a></td>
<td><a href="/wiki/Module:Citation/CS1/sandbox" title="Module:Citation/CS1/sandbox">Module:Citation/CS1/sandbox</a></td>
<td><span class="plainlinks"><a class="external text" href="https://en.wikipedia.org/w/index.php?title=Module:Citation/CS1/sandbox&amp;action=edit">[edit]</a></span></td>
<td><a class="external text" href="https://en.wikipedia.org/wiki/Special:ComparePages?page1=Module%3ACitation%2FCS1&amp;rev1=&amp;page2=Module%3ACitation%2FCS1%2Fsandbox&amp;rev2=&amp;action=&amp;diffonly=&amp;unhide=">diff</a></td>
<td>Rendering and support functions
</td></tr>
<tr>
<td><a href="/wiki/Module:Citation/CS1/Configuration" title="Module:Citation/CS1/Configuration">Module:Citation/CS1/Configuration</a></td>
<td><a href="/wiki/Module:Citation/CS1/Configuration/sandbox" title="Module:Citation/CS1/Configuration/sandbox">Module:Citation/CS1/Configuration/sandbox</a></td>
<td><span class="plainlinks"><a class="external text" href="https://en.wikipedia.org/w/index.php?title=Module:Citation/CS1/Configuration/sandbox&amp;action=edit">[edit]</a></span></td>
<td><a class="external text" href="https://en.wikipedia.org/wiki/Special:ComparePages?page1=Module%3ACitation%2FCS1%2FConfiguration&amp;rev1=&amp;page2=Module%3ACitation%2FCS1%2FConfiguration%2Fsandbox&amp;rev2=&amp;action=&amp;diffonly=&amp;unhide=">diff</a></td>
<td>Translation tables; error and identifier handlers
</td></tr>
<tr>
<td><a href="/wiki/Module:Citation/CS1/Whitelist" title="Module:Citation/CS1/Whitelist">Module:Citation/CS1/Whitelist</a></td>
<td><a href="/wiki/Module:Citation/CS1/Whitelist/sandbox" title="Module:Citation/CS1/Whitelist/sandbox">Module:Citation/CS1/Whitelist/sandbox</a></td>
<td><span class="plainlinks"><a class="external text" href="https://en.wikipedia.org/w/index.php?title=Module:Citation/CS1/Whitelist/sandbox&amp;action=edit">[edit]</a></span></td>
<td><a class="external text" href="https://en.wikipedia.org/wiki/Special:ComparePages?page1=Module%3ACitation%2FCS1%2FWhitelist&amp;rev1=&amp;page2=Module%3ACitation%2FCS1%2FWhitelist%2Fsandbox&amp;rev2=&amp;action=&amp;diffonly=&amp;unhide=">diff</a></td>
<td>List of active and deprecated CS1&#124;2 parameters
</td></tr>
<tr>
<td><a href="/wiki/Module:Citation/CS1/Date_validation" title="Module:Citation/CS1/Date validation">Module:Citation/CS1/Date validation</a></td>
<td><a href="/wiki/Module:Citation/CS1/Date_validation/sandbox" title="Module:Citation/CS1/Date validation/sandbox">Module:Citation/CS1/Date validation/sandbox</a></td>
<td><span class="plainlinks"><a class="external text" href="https://en.wikipedia.org/w/index.php?title=Module:Citation/CS1/Date_validation/sandbox&amp;action=edit">[edit]</a></span></td>
<td><a class="external text" href="https://en.wikipedia.org/wiki/Special:ComparePages?page1=Module%3ACitation%2FCS1%2FDate+validation&amp;rev1=&amp;page2=Module%3ACitation%2FCS1%2FDate+validation%2Fsandbox&amp;rev2=&amp;action=&amp;diffonly=&amp;unhide=">diff</a></td>
<td>Date format validation functions
</td></tr>
<tr>
<td><a class="mw-selflink selflink">Module:Citation/CS1/Identifiers</a></td>
<td><a href="/wiki/Module:Citation/CS1/Identifiers/sandbox" title="Module:Citation/CS1/Identifiers/sandbox">Module:Citation/CS1/Identifiers/sandbox</a></td>
<td><span class="plainlinks"><a class="external text" href="https://en.wikipedia.org/w/index.php?title=Module:Citation/CS1/Identifiers/sandbox&amp;action=edit">[edit]</a></span></td>
<td><a class="external text" href="https://en.wikipedia.org/wiki/Special:ComparePages?page1=Module%3ACitation%2FCS1%2FIdentifiers&amp;rev1=&amp;page2=Module%3ACitation%2FCS1%2FIdentifiers%2Fsandbox&amp;rev2=&amp;action=&amp;diffonly=&amp;unhide=">diff</a></td>
<td>Functions that support the named identifiers (ISBN, DOI, PMID, etc.)
</td></tr>
<tr>
<td><a href="/wiki/Module:Citation/CS1/Utilities" title="Module:Citation/CS1/Utilities">Module:Citation/CS1/Utilities</a></td>
<td><a href="/wiki/Module:Citation/CS1/Utilities/sandbox" title="Module:Citation/CS1/Utilities/sandbox">Module:Citation/CS1/Utilities/sandbox</a></td>
<td><span class="plainlinks"><a class="external text" href="https://en.wikipedia.org/w/index.php?title=Module:Citation/CS1/Utilities/sandbox&amp;action=edit">[edit]</a></span></td>
<td><a class="external text" href="https://en.wikipedia.org/wiki/Special:ComparePages?page1=Module%3ACitation%2FCS1%2FUtilities&amp;rev1=&amp;page2=Module%3ACitation%2FCS1%2FUtilities%2Fsandbox&amp;rev2=&amp;action=&amp;diffonly=&amp;unhide=">diff</a></td>
<td>Common functions and tables
</td></tr>
<tr>
<td><a href="/wiki/Module:Citation/CS1/COinS" title="Module:Citation/CS1/COinS">Module:Citation/CS1/COinS</a></td>
<td><a href="/wiki/Module:Citation/CS1/COinS/sandbox" title="Module:Citation/CS1/COinS/sandbox">Module:Citation/CS1/COinS/sandbox</a></td>
<td><span class="plainlinks"><a class="external text" href="https://en.wikipedia.org/w/index.php?title=Module:Citation/CS1/COinS/sandbox&amp;action=edit">[edit]</a></span></td>
<td><a class="external text" href="https://en.wikipedia.org/wiki/Special:ComparePages?page1=Module%3ACitation%2FCS1%2FCOinS&amp;rev1=&amp;page2=Module%3ACitation%2FCS1%2FCOinS%2Fsandbox&amp;rev2=&amp;action=&amp;diffonly=&amp;unhide=">diff</a></td>
<td>Functions that render a CS1&#124;2 template's metadata
</td></tr>
<tr>
<td><a href="/wiki/Module:Citation/CS1/styles.css" title="Module:Citation/CS1/styles.css">Module:Citation/CS1/styles.css</a></td>
<td><a href="/wiki/Module:Citation/CS1/sandbox/styles.css" title="Module:Citation/CS1/sandbox/styles.css">Module:Citation/CS1/sandbox/styles.css</a></td>
<td><span class="plainlinks"><a class="external text" href="https://en.wikipedia.org/w/index.php?title=Module:Citation/CS1/sandbox/styles.css&amp;action=edit">[edit]</a></span></td>
<td><a class="external text" href="https://en.wikipedia.org/wiki/Special:ComparePages?page1=Module%3ACitation%2FCS1%2Fstyles.css&amp;rev1=&amp;page2=Module%3ACitation%2FCS1%2Fsandbox%2Fstyles.css&amp;rev2=&amp;action=&amp;diffonly=&amp;unhide=">diff</a></td>
<td><a href="/wiki/CSS" title="CSS">CSS</a> styles applied to the CS1&#124;2 templates
</td></tr>
<tr>
<td><span typeof="mw:File"><span title="auto confirmed"><img alt="Silver padlock" src="//upload.wikimedia.org/wikipedia/en/thumb/5/53/Template-protection-shackle.svg/20px-Template-protection-shackle.svg.png" decoding="async" width="20" height="20" class="mw-file-element" srcset="//upload.wikimedia.org/wikipedia/en/thumb/5/53/Template-protection-shackle.svg/30px-Template-protection-shackle.svg.png 1.5x, //upload.wikimedia.org/wikipedia/en/thumb/5/53/Template-protection-shackle.svg/40px-Template-protection-shackle.svg.png 2x" data-file-width="512" data-file-height="512" /></span></span></td>
<td><a href="/wiki/Module:Citation/CS1/Suggestions" title="Module:Citation/CS1/Suggestions">Module:Citation/CS1/Suggestions</a></td>
<td><a href="/wiki/Module:Citation/CS1/Suggestions/sandbox" title="Module:Citation/CS1/Suggestions/sandbox">Module:Citation/CS1/Suggestions/sandbox</a></td>
<td><span class="plainlinks"><a class="external text" href="https://en.wikipedia.org/w/index.php?title=Module:Citation/CS1/Suggestions/sandbox&amp;action=edit">[edit]</a></span></td>
<td><a class="external text" href="https://en.wikipedia.org/wiki/Special:ComparePages?page1=Module%3ACitation%2FCS1%2FSuggestions&amp;rev1=&amp;page2=Module%3ACitation%2FCS1%2FSuggestions%2Fsandbox&amp;rev2=&amp;action=&amp;diffonly=&amp;unhide=">diff</a></td>
<td>List that maps common erroneous parameter names to valid parameter names
</td></tr></tbody></table>
<div class="documentation-clear"></div>
</div>
<div role="note" class="documentation-metadata plainlinks">The above <a href="/wiki/Wikipedia:Template_documentation" title="Wikipedia:Template documentation">documentation</a> is <a href="/wiki/Help:Transclusion" title="Help:Transclusion">transcluded</a> from <a href="/wiki/Module:Citation/CS1/Identifiers/doc" title="Module:Citation/CS1/Identifiers/doc">Module:Citation/CS1/Identifiers/doc</a>. <span class="documentation-toolbar">(<a href="/wiki/Special:EditPage/Module:Citation/CS1/Identifiers/doc" title="Special:EditPage/Module:Citation/CS1/Identifiers/doc">edit</a> &#124; <a href="/wiki/Special:PageHistory/Module:Citation/CS1/Identifiers/doc" title="Special:PageHistory/Module:Citation/CS1/Identifiers/doc">history</a>)</span><br />Editors can experiment in this module's <a href="/wiki/Module:Citation/CS1/Identifiers/sandbox" title="Module:Citation/CS1/Identifiers/sandbox">sandbox</a> <span class="documentation-toolbar">(<a href="/wiki/Special:EditPage/Module:Citation/CS1/Identifiers/sandbox" title="Special:EditPage/Module:Citation/CS1/Identifiers/sandbox">edit</a> &#124; <a class="external text" href="https://en.wikipedia.org/w/index.php?title=Special%3AComparePages&amp;page1=Module%3ACitation%2FCS1%2FIdentifiers&amp;page2=Module%3ACitation%2FCS1%2FIdentifiers%2Fsandbox">diff</a>)</span> and testcases <span class="documentation-toolbar">(<a class="external text" href="https://en.wikipedia.org/w/index.php?title=Module:Citation/CS1/Identifiers/testcases&amp;action=edit&amp;preload=Template%3ADocumentation%2Fpreload-module-testcases">create</a>)</span> pages.<br /> <a href="/wiki/Special:PrefixIndex/Module:Citation/CS1/Identifiers/" title="Special:PrefixIndex/Module:Citation/CS1/Identifiers/">Subpages of this module</a>.</div></div>
<p><span id="code"></span>
</p><div class="mw-highlight mw-highlight-lang-lua mw-content-ltr mw-highlight-lines" dir="ltr"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos" data-line="1"></span></a><span class="cm">--[[--------------------------&lt; F O R W A R D   D E C L A R A T I O N S &gt;--------------------------------------</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos" data-line="2"></span></a><span class="cm">]]</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos" data-line="3"></span></a>
</span><span id="L-4"><a href="#L-4"><span class="linenos" data-line="4"></span></a><span class="kd">local</span> <span class="n">has_accept_as_written</span><span class="p">,</span> <span class="n">is_set</span><span class="p">,</span> <span class="n">in_array</span><span class="p">,</span> <span class="n">set_message</span><span class="p">,</span> <span class="n">select_one</span><span class="p">,</span>			<span class="c1">-- functions in Module:Citation/CS1/Utilities</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos" data-line="5"></span></a>		<span class="n">substitute</span><span class="p">,</span> <span class="n">make_wikilink</span><span class="p">;</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos" data-line="6"></span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos" data-line="7"></span></a><span class="kd">local</span> <span class="n">z</span><span class="p">;</span>																		<span class="c1">-- table of tables defined in Module:Citation/CS1/Utilities</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos" data-line="8"></span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos" data-line="9"></span></a><span class="kd">local</span> <span class="n">cfg</span><span class="p">;</span>																		<span class="c1">-- table of configuration tables that are defined in Module:Citation/CS1/Configuration</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos" data-line="10"></span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos" data-line="11"></span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos" data-line="12"></span></a><span class="cm">--[[--------------------------&lt; P A G E   S C O P E   V A R I A B L E S &gt;--------------------------------------</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos" data-line="13"></span></a>
</span><span id="L-14"><a href="#L-14"><span class="linenos" data-line="14"></span></a><span class="cm">declare variables here that have page-wide scope that are not brought in from other modules; that are created here and used here</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos" data-line="15"></span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos" data-line="16"></span></a><span class="cm">]]</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos" data-line="17"></span></a>
</span><span id="L-18"><a href="#L-18"><span class="linenos" data-line="18"></span></a><span class="kd">local</span> <span class="n">auto_link_urls</span> <span class="o">=</span> <span class="p">{};</span>														<span class="c1">-- holds identifier URLs for those identifiers that can auto-link |title=</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos" data-line="19"></span></a>
</span><span id="L-20"><a href="#L-20"><span class="linenos" data-line="20"></span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos" data-line="21"></span></a><span class="c1">--============================&lt;&lt; H E L P E R   F U N C T I O N S &gt;&gt;============================================</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos" data-line="22"></span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos" data-line="23"></span></a><span class="cm">--[[--------------------------&lt; W I K I D A T A _ A R T I C L E _ N A M E _ G E T &gt;----------------------------</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos" data-line="24"></span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos" data-line="25"></span></a><span class="cm">as an aid to internationalizing identifier-label wikilinks, gets identifier article names from Wikidata.</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos" data-line="26"></span></a>
</span><span id="L-27"><a href="#L-27"><span class="linenos" data-line="27"></span></a><span class="cm">returns :&lt;lang code&gt;:&lt;article title&gt; when &lt;q&gt; has an &lt;article title&gt; for &lt;lang code&gt;; nil else</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos" data-line="28"></span></a>
</span><span id="L-29"><a href="#L-29"><span class="linenos" data-line="29"></span></a><span class="cm">for identifiers that do not have q, returns nil</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos" data-line="30"></span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos" data-line="31"></span></a><span class="cm">for wikis that do not have mw.wikibase installed, returns nil</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos" data-line="32"></span></a>
</span><span id="L-33"><a href="#L-33"><span class="linenos" data-line="33"></span></a><span class="cm">]]</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos" data-line="34"></span></a>
</span><span id="L-35"><a href="#L-35"><span class="linenos" data-line="35"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">wikidata_article_name_get</span> <span class="p">(</span><span class="n">q</span><span class="p">)</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos" data-line="36"></span></a>	<span class="kr">if</span> <span class="ow">not</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">q</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mw</span><span class="p">.</span><span class="n">wikibase</span><span class="p">)</span> <span class="kr">then</span>							<span class="c1">-- when no q number or when a q number but mw.wikibase not installed on this wiki</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos" data-line="37"></span></a>		<span class="kr">return</span> <span class="kc">nil</span><span class="p">;</span>																<span class="c1">-- abandon</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos" data-line="38"></span></a>	<span class="kr">end</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos" data-line="39"></span></a>
</span><span id="L-40"><a href="#L-40"><span class="linenos" data-line="40"></span></a>	<span class="kd">local</span> <span class="n">wd_article</span><span class="p">;</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos" data-line="41"></span></a>	<span class="kd">local</span> <span class="n">this_wiki_code</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="n">this_wiki_code</span><span class="p">;</span>									<span class="c1">-- Wikipedia subdomain; &#39;en&#39; for en.wikipedia.org</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos" data-line="42"></span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos" data-line="43"></span></a>	<span class="n">wd_article</span> <span class="o">=</span> <span class="n">mw</span><span class="p">.</span><span class="n">wikibase</span><span class="p">.</span><span class="n">getSitelink</span> <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">this_wiki_code</span> <span class="o">..</span> <span class="s1">&#39;wiki&#39;</span><span class="p">);</span>			<span class="c1">-- fetch article title from WD; nil when no title available at this wiki</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos" data-line="44"></span></a>
</span><span id="L-45"><a href="#L-45"><span class="linenos" data-line="45"></span></a>	<span class="kr">if</span> <span class="n">wd_article</span> <span class="kr">then</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos" data-line="46"></span></a>		<span class="n">wd_article</span> <span class="o">=</span> <span class="nb">table.concat</span> <span class="p">({</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">this_wiki_code</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">wd_article</span><span class="p">});</span>		<span class="c1">-- interwiki-style link without brackets if taken from WD; leading colon required</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos" data-line="47"></span></a>	<span class="kr">end</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos" data-line="48"></span></a>
</span><span id="L-49"><a href="#L-49"><span class="linenos" data-line="49"></span></a>	<span class="kr">return</span> <span class="n">wd_article</span><span class="p">;</span>															<span class="c1">-- article title from WD; nil else</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos" data-line="50"></span></a><span class="kr">end</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos" data-line="51"></span></a>
</span><span id="L-52"><a href="#L-52"><span class="linenos" data-line="52"></span></a>
</span><span id="L-53"><a href="#L-53"><span class="linenos" data-line="53"></span></a><span class="cm">--[[--------------------------&lt; L I N K _ L A B E L _ M A K E &gt;------------------------------------------------</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos" data-line="54"></span></a>
</span><span id="L-55"><a href="#L-55"><span class="linenos" data-line="55"></span></a><span class="cm">common function to create identifier link label from handler table or from Wikidata</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos" data-line="56"></span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos" data-line="57"></span></a><span class="cm">returns the first available of</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos" data-line="58"></span></a><span class="cm">	1. redirect from local wiki&#39;s handler table (if enabled)</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos" data-line="59"></span></a><span class="cm">	2. Wikidata (if there is a Wikidata entry for this identifier in the local wiki&#39;s language)</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos" data-line="60"></span></a><span class="cm">	3. label specified in the local wiki&#39;s handler table</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos" data-line="61"></span></a><span class="cm">	</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos" data-line="62"></span></a><span class="cm">]]</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos" data-line="63"></span></a>
</span><span id="L-64"><a href="#L-64"><span class="linenos" data-line="64"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">link_label_make</span> <span class="p">(</span><span class="n">handler</span><span class="p">)</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos" data-line="65"></span></a>	<span class="kd">local</span> <span class="n">wd_article</span><span class="p">;</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos" data-line="66"></span></a>	
</span><span id="L-67"><a href="#L-67"><span class="linenos" data-line="67"></span></a>	<span class="kr">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">use_identifier_redirects</span> <span class="ow">and</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">))</span> <span class="kr">then</span>	<span class="c1">-- redirect has priority so if enabled and available don&#39;t fetch from Wikidata because expensive</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos" data-line="68"></span></a>		<span class="n">wd_article</span> <span class="o">=</span> <span class="n">wikidata_article_name_get</span> <span class="p">(</span><span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">);</span>						<span class="c1">-- if Wikidata has an article title for this wiki, get it;</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos" data-line="69"></span></a>	<span class="kr">end</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos" data-line="70"></span></a>	
</span><span id="L-71"><a href="#L-71"><span class="linenos" data-line="71"></span></a>	<span class="kr">return</span> <span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">use_identifier_redirects</span> <span class="ow">and</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">)</span> <span class="ow">and</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">)</span> <span class="ow">or</span> <span class="n">wd_article</span> <span class="ow">or</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">;</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos" data-line="72"></span></a><span class="kr">end</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos" data-line="73"></span></a>
</span><span id="L-74"><a href="#L-74"><span class="linenos" data-line="74"></span></a>
</span><span id="L-75"><a href="#L-75"><span class="linenos" data-line="75"></span></a><span class="cm">--[[--------------------------&lt; E X T E R N A L _ L I N K _ I D &gt;----------------------------------------------</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos" data-line="76"></span></a>
</span><span id="L-77"><a href="#L-77"><span class="linenos" data-line="77"></span></a><span class="cm">Formats a wiki-style external link</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos" data-line="78"></span></a>
</span><span id="L-79"><a href="#L-79"><span class="linenos" data-line="79"></span></a><span class="cm">]]</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos" data-line="80"></span></a>
</span><span id="L-81"><a href="#L-81"><span class="linenos" data-line="81"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">external_link_id</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos" data-line="82"></span></a>	<span class="kd">local</span> <span class="n">url_string</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos" data-line="83"></span></a>	<span class="kd">local</span> <span class="n">ext_link</span><span class="p">;</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos" data-line="84"></span></a>	<span class="kd">local</span> <span class="n">this_wiki_code</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="n">this_wiki_code</span><span class="p">;</span>									<span class="c1">-- Wikipedia subdomain; &#39;en&#39; for en.wikipedia.org</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos" data-line="85"></span></a>	<span class="kd">local</span> <span class="n">wd_article</span><span class="p">;</span>															<span class="c1">-- article title from Wikidata</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos" data-line="86"></span></a>	
</span><span id="L-87"><a href="#L-87"><span class="linenos" data-line="87"></span></a>	<span class="kr">if</span> <span class="n">options</span><span class="p">.</span><span class="n">encode</span> <span class="o">==</span> <span class="kc">true</span> <span class="ow">or</span> <span class="n">options</span><span class="p">.</span><span class="n">encode</span> <span class="o">==</span> <span class="kc">nil</span> <span class="kr">then</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos" data-line="88"></span></a>		<span class="n">url_string</span> <span class="o">=</span> <span class="n">mw</span><span class="p">.</span><span class="n">uri</span><span class="p">.</span><span class="n">encode</span> <span class="p">(</span><span class="n">url_string</span><span class="p">,</span> <span class="s1">&#39;PATH&#39;</span><span class="p">);</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos" data-line="89"></span></a>	<span class="kr">end</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos" data-line="90"></span></a>
</span><span id="L-91"><a href="#L-91"><span class="linenos" data-line="91"></span></a>	<span class="kr">if</span> <span class="n">options</span><span class="p">.</span><span class="n">auto_link</span> <span class="ow">and</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">access</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos" data-line="92"></span></a>		<span class="n">auto_link_urls</span><span class="p">[</span><span class="n">options</span><span class="p">.</span><span class="n">auto_link</span><span class="p">]</span> <span class="o">=</span> <span class="nb">table.concat</span> <span class="p">({</span><span class="n">options</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">url_string</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">suffix</span><span class="p">});</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos" data-line="93"></span></a>	<span class="kr">end</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos" data-line="94"></span></a>
</span><span id="L-95"><a href="#L-95"><span class="linenos" data-line="95"></span></a>	<span class="n">ext_link</span> <span class="o">=</span> <span class="n">mw</span><span class="p">.</span><span class="n">ustring</span><span class="p">.</span><span class="n">format</span> <span class="p">(</span><span class="s1">&#39;[%s%s%s %s]&#39;</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">url_string</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">suffix</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">mw</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">nowiki</span> <span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">));</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos" data-line="96"></span></a>	<span class="kr">if</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">access</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos" data-line="97"></span></a>		<span class="n">ext_link</span> <span class="o">=</span> <span class="n">substitute</span> <span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">presentation</span><span class="p">[</span><span class="s1">&#39;ext-link-access-signal&#39;</span><span class="p">],</span> <span class="p">{</span><span class="n">cfg</span><span class="p">.</span><span class="n">presentation</span><span class="p">[</span><span class="n">options</span><span class="p">.</span><span class="n">access</span><span class="p">].</span><span class="n">class</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">presentation</span><span class="p">[</span><span class="n">options</span><span class="p">.</span><span class="n">access</span><span class="p">].</span><span class="n">title</span><span class="p">,</span> <span class="n">ext_link</span><span class="p">});</span>	<span class="c1">-- add the free-to-read / paywall lock</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos" data-line="98"></span></a>	<span class="kr">end</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos" data-line="99"></span></a>
</span><span id="L-100"><a href="#L-100"><span class="linenos" data-line="100"></span></a>	<span class="kr">return</span> <span class="nb">table.concat</span>	<span class="p">({</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos" data-line="101"></span></a>		<span class="n">make_wikilink</span> <span class="p">(</span><span class="n">link_label_make</span> <span class="p">(</span><span class="n">options</span><span class="p">),</span> <span class="n">options</span><span class="p">.</span><span class="n">label</span><span class="p">),</span>				<span class="c1">-- redirect, Wikidata link, or locally specified link (in that order)</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos" data-line="102"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">separator</span> <span class="ow">or</span> <span class="s1">&#39;&amp;nbsp;&#39;</span><span class="p">,</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos" data-line="103"></span></a>		<span class="n">ext_link</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos" data-line="104"></span></a>		<span class="p">});</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos" data-line="105"></span></a><span class="kr">end</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos" data-line="106"></span></a>
</span><span id="L-107"><a href="#L-107"><span class="linenos" data-line="107"></span></a>
</span><span id="L-108"><a href="#L-108"><span class="linenos" data-line="108"></span></a><span class="cm">--[[--------------------------&lt; I N T E R N A L _ L I N K _ I D &gt;----------------------------------------------</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos" data-line="109"></span></a>
</span><span id="L-110"><a href="#L-110"><span class="linenos" data-line="110"></span></a><span class="cm">Formats a wiki-style internal link</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos" data-line="111"></span></a>
</span><span id="L-112"><a href="#L-112"><span class="linenos" data-line="112"></span></a><span class="cm">TODO: Does not currently need to support options.access, options.encode, auto-linking and COinS (as in external_link_id),</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos" data-line="113"></span></a><span class="cm">but may be needed in the future for :m:Interwiki_map custom-prefixes like :arxiv:, :bibcode:, :DOI:, :hdl:, :ISSN:,</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos" data-line="114"></span></a><span class="cm">:JSTOR:, :Openlibrary:, :PMID:, :RFC:.</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos" data-line="115"></span></a>
</span><span id="L-116"><a href="#L-116"><span class="linenos" data-line="116"></span></a><span class="cm">]]</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos" data-line="117"></span></a>
</span><span id="L-118"><a href="#L-118"><span class="linenos" data-line="118"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">internal_link_id</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos" data-line="119"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">mw</span><span class="p">.</span><span class="n">ustring</span><span class="p">.</span><span class="n">gsub</span> <span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;%d&#39;</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">date_names</span><span class="p">.</span><span class="n">local_digits</span><span class="p">);</span>	<span class="c1">-- translate &#39;local&#39; digits to Western 0-9</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos" data-line="120"></span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos" data-line="121"></span></a>	<span class="kr">return</span> <span class="nb">table.concat</span> <span class="p">(</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos" data-line="122"></span></a>		<span class="p">{</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos" data-line="123"></span></a>		<span class="n">make_wikilink</span> <span class="p">(</span><span class="n">link_label_make</span> <span class="p">(</span><span class="n">options</span><span class="p">),</span> <span class="n">options</span><span class="p">.</span><span class="n">label</span><span class="p">),</span>				<span class="c1">-- wiki-link the identifier label</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos" data-line="124"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">separator</span> <span class="ow">or</span> <span class="s1">&#39;&amp;nbsp;&#39;</span><span class="p">,</span>											<span class="c1">-- add the separator</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos" data-line="125"></span></a>		<span class="n">make_wikilink</span> <span class="p">(</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos" data-line="126"></span></a>			<span class="nb">table.concat</span> <span class="p">(</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos" data-line="127"></span></a>				<span class="p">{</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos" data-line="128"></span></a>				<span class="n">options</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos" data-line="129"></span></a>				<span class="n">id</span><span class="p">,</span>																<span class="c1">-- translated to Western digits</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos" data-line="130"></span></a>				<span class="n">options</span><span class="p">.</span><span class="n">suffix</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos" data-line="131"></span></a>				<span class="p">}),</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos" data-line="132"></span></a>			<span class="n">substitute</span> <span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">presentation</span><span class="p">[</span><span class="s1">&#39;bdi&#39;</span><span class="p">],</span> <span class="p">{</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">mw</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">nowiki</span> <span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">)})</span>	<span class="c1">-- bdi tags to prevent Latin script identifiers from being reversed at RTL language wikis</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos" data-line="133"></span></a>			<span class="p">);</span>																	<span class="c1">-- nowiki because MediaWiki still has magic links for ISBN and the like; TODO: is it really required?</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos" data-line="134"></span></a>		<span class="p">});</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos" data-line="135"></span></a><span class="kr">end</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos" data-line="136"></span></a>
</span><span id="L-137"><a href="#L-137"><span class="linenos" data-line="137"></span></a>
</span><span id="L-138"><a href="#L-138"><span class="linenos" data-line="138"></span></a><span class="cm">--[[--------------------------&lt; I S _ E M B A R G O E D &gt;------------------------------------------------------</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos" data-line="139"></span></a>
</span><span id="L-140"><a href="#L-140"><span class="linenos" data-line="140"></span></a><span class="cm">Determines if a PMC identifier&#39;s online version is embargoed. Compares the date in |pmc-embargo-date= against</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos" data-line="141"></span></a><span class="cm">today&#39;s date.  If embargo date is in the future, returns the content of |pmc-embargo-date=; otherwise, returns</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos" data-line="142"></span></a><span class="cm">an empty string because the embargo has expired or because |pmc-embargo-date= was not set in this cite.</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos" data-line="143"></span></a>
</span><span id="L-144"><a href="#L-144"><span class="linenos" data-line="144"></span></a><span class="cm">]]</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos" data-line="145"></span></a>
</span><span id="L-146"><a href="#L-146"><span class="linenos" data-line="146"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">is_embargoed</span> <span class="p">(</span><span class="n">embargo</span><span class="p">)</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos" data-line="147"></span></a>	<span class="kr">if</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">embargo</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos" data-line="148"></span></a>		<span class="kd">local</span> <span class="n">lang</span> <span class="o">=</span> <span class="n">mw</span><span class="p">.</span><span class="n">getContentLanguage</span><span class="p">();</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos" data-line="149"></span></a>		<span class="kd">local</span> <span class="n">good1</span><span class="p">,</span> <span class="n">embargo_date</span><span class="p">,</span> <span class="n">todays_date</span><span class="p">;</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos" data-line="150"></span></a>		<span class="n">good1</span><span class="p">,</span> <span class="n">embargo_date</span> <span class="o">=</span> <span class="nb">pcall</span> <span class="p">(</span><span class="n">lang</span><span class="p">.</span><span class="n">formatDate</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="n">embargo</span><span class="p">);</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos" data-line="151"></span></a>		<span class="n">todays_date</span> <span class="o">=</span> <span class="n">lang</span><span class="p">:</span><span class="n">formatDate</span> <span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">);</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos" data-line="152"></span></a>	
</span><span id="L-153"><a href="#L-153"><span class="linenos" data-line="153"></span></a>		<span class="kr">if</span> <span class="n">good1</span> <span class="kr">then</span>															<span class="c1">-- if embargo date is a good date</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos" data-line="154"></span></a>			<span class="kr">if</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="n">embargo_date</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="n">todays_date</span><span class="p">)</span> <span class="kr">then</span>			<span class="c1">-- is embargo date is in the future?</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos" data-line="155"></span></a>				<span class="kr">return</span> <span class="n">embargo</span><span class="p">;</span>													<span class="c1">-- still embargoed</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos" data-line="156"></span></a>			<span class="kr">else</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos" data-line="157"></span></a>				<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;maint_pmc_embargo&#39;</span><span class="p">);</span>								<span class="c1">-- embargo has expired; add main cat</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos" data-line="158"></span></a>				<span class="kr">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>														<span class="c1">-- unset because embargo has expired</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos" data-line="159"></span></a>			<span class="kr">end</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos" data-line="160"></span></a>		<span class="kr">end</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos" data-line="161"></span></a>	<span class="kr">end</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos" data-line="162"></span></a>	<span class="kr">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>																	<span class="c1">-- |pmc-embargo-date= not set return empty string</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos" data-line="163"></span></a><span class="kr">end</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos" data-line="164"></span></a>
</span><span id="L-165"><a href="#L-165"><span class="linenos" data-line="165"></span></a>
</span><span id="L-166"><a href="#L-166"><span class="linenos" data-line="166"></span></a><span class="cm">--[=[-------------------------&lt; I S _ V A L I D _ R X I V _ D A T E &gt;------------------------------------------</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos" data-line="167"></span></a>
</span><span id="L-168"><a href="#L-168"><span class="linenos" data-line="168"></span></a><span class="cm">for biorxiv, returns true if:</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos" data-line="169"></span></a><span class="cm">	2019-12-11T00:00Z &lt;= biorxiv_date &lt; today + 2 days</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos" data-line="170"></span></a><span class="cm">for medrxiv, returns true if:</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos" data-line="171"></span></a><span class="cm">	2020-01-01T00:00Z &lt;= medrxiv_date &lt; today + 2 days</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos" data-line="172"></span></a><span class="cm">	</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos" data-line="173"></span></a><span class="cm">The dated form of biorxiv identifier has a start date of 2019-12-11.  The Unix timestamp for that date is {{#time:U|2019-12-11}} = 1576022400</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos" data-line="174"></span></a><span class="cm">The medrxiv identifier has a start date of 2020-01-01.  The Unix timestamp for that date is {{#time:U|2020-01-01}} = 1577836800</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos" data-line="175"></span></a>
</span><span id="L-176"><a href="#L-176"><span class="linenos" data-line="176"></span></a><span class="cm">&lt;rxiv_date&gt; is the date provided in those |biorxiv= parameter values that are dated and in |medrxiv= parameter values at time 00:00:00 UTC</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos" data-line="177"></span></a><span class="cm">&lt;today&gt; is the current date at time 00:00:00 UTC plus 48 hours</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos" data-line="178"></span></a><span class="cm">	if today&#39;s date is 2023-01-01T00:00:00 then</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos" data-line="179"></span></a><span class="cm">		adding 24 hours gives 2023-01-02T00:00:00 – one second more than today</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos" data-line="180"></span></a><span class="cm">		adding 24 hours gives 2023-01-03T00:00:00 – one second more than tomorrow</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos" data-line="181"></span></a>
</span><span id="L-182"><a href="#L-182"><span class="linenos" data-line="182"></span></a><span class="cm">inputs:</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos" data-line="183"></span></a><span class="cm">	&lt;y&gt;, &lt;m&gt;, &lt;d&gt; – year, month, day parts of the date from the birxiv or medrxiv identifier</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos" data-line="184"></span></a><span class="cm">	&lt;select&gt; &#39;b&#39; for biorxiv, &#39;m&#39; for medrxiv; defaults to &#39;b&#39;</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos" data-line="185"></span></a>
</span><span id="L-186"><a href="#L-186"><span class="linenos" data-line="186"></span></a><span class="cm">]=]</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos" data-line="187"></span></a>
</span><span id="L-188"><a href="#L-188"><span class="linenos" data-line="188"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">is_valid_rxiv_date</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="nb">select</span><span class="p">)</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos" data-line="189"></span></a>	<span class="kr">if</span> <span class="mi">0</span> <span class="o">==</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">12</span> <span class="o">&lt;</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="kr">then</span>								<span class="c1">-- &lt;m&gt; must be a number 1–12</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos" data-line="190"></span></a>		<span class="kr">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos" data-line="191"></span></a>	<span class="kr">end</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos" data-line="192"></span></a>	<span class="kr">if</span> <span class="mi">0</span> <span class="o">==</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">31</span> <span class="o">&lt;</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="kr">then</span>								<span class="c1">-- &lt;d&gt; must be a number 1–31; TODO: account for month length and leap yer?</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos" data-line="193"></span></a>		<span class="kr">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos" data-line="194"></span></a>	<span class="kr">end</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos" data-line="195"></span></a>	
</span><span id="L-196"><a href="#L-196"><span class="linenos" data-line="196"></span></a>	<span class="kd">local</span> <span class="n">rxiv_date</span> <span class="o">=</span> <span class="nb">table.concat</span> <span class="p">({</span><span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span><span class="p">},</span> <span class="s1">&#39;-&#39;</span><span class="p">);</span>							<span class="c1">-- make ymd date string</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos" data-line="197"></span></a>	<span class="kd">local</span> <span class="n">good1</span><span class="p">,</span> <span class="n">good2</span><span class="p">;</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos" data-line="198"></span></a>	<span class="kd">local</span> <span class="n">rxiv_ts</span><span class="p">,</span> <span class="n">tomorrow_ts</span><span class="p">;</span>													<span class="c1">-- to hold Unix timestamps representing the dates</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos" data-line="199"></span></a>	<span class="kd">local</span> <span class="n">lang_object</span> <span class="o">=</span> <span class="n">mw</span><span class="p">.</span><span class="n">getContentLanguage</span><span class="p">();</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos" data-line="200"></span></a>
</span><span id="L-201"><a href="#L-201"><span class="linenos" data-line="201"></span></a>	<span class="n">good1</span><span class="p">,</span> <span class="n">rxiv_ts</span> <span class="o">=</span> <span class="nb">pcall</span> <span class="p">(</span><span class="n">lang_object</span><span class="p">.</span><span class="n">formatDate</span><span class="p">,</span> <span class="n">lang_object</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="n">rxiv_date</span><span class="p">);</span>		<span class="c1">-- convert rxiv_date value to Unix timestamp </span>
</span><span id="L-202"><a href="#L-202"><span class="linenos" data-line="202"></span></a>	<span class="n">good2</span><span class="p">,</span> <span class="n">tomorrow_ts</span> <span class="o">=</span> <span class="nb">pcall</span> <span class="p">(</span><span class="n">lang_object</span><span class="p">.</span><span class="n">formatDate</span><span class="p">,</span> <span class="n">lang_object</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;today + 2 days&#39;</span> <span class="p">);</span>	<span class="c1">-- today midnight + 2 days is one second more than all day tomorrow</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos" data-line="203"></span></a>	
</span><span id="L-204"><a href="#L-204"><span class="linenos" data-line="204"></span></a>	<span class="kr">if</span> <span class="n">good1</span> <span class="ow">and</span> <span class="n">good2</span> <span class="kr">then</span>														<span class="c1">-- lang.formatDate() returns a timestamp in the local script which tonumber() may not understand</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos" data-line="205"></span></a>		<span class="n">rxiv_ts</span> <span class="o">=</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="n">rxiv_ts</span><span class="p">)</span> <span class="ow">or</span> <span class="n">lang_object</span><span class="p">:</span><span class="n">parseFormattedNumber</span> <span class="p">(</span><span class="n">rxiv_ts</span><span class="p">);</span>	<span class="c1">-- convert to numbers for the comparison;</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos" data-line="206"></span></a>		<span class="n">tomorrow_ts</span> <span class="o">=</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="n">tomorrow_ts</span><span class="p">)</span> <span class="ow">or</span> <span class="n">lang_object</span><span class="p">:</span><span class="n">parseFormattedNumber</span> <span class="p">(</span><span class="n">tomorrow_ts</span><span class="p">);</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos" data-line="207"></span></a>	<span class="kr">else</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos" data-line="208"></span></a>		<span class="kr">return</span> <span class="kc">false</span><span class="p">;</span>															<span class="c1">-- one or both failed to convert to Unix timestamp</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos" data-line="209"></span></a>	<span class="kr">end</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos" data-line="210"></span></a>
</span><span id="L-211"><a href="#L-211"><span class="linenos" data-line="211"></span></a>	<span class="kd">local</span> <span class="n">limit_ts</span> <span class="o">=</span> <span class="p">((</span><span class="nb">select</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;m&#39;</span> <span class="o">==</span> <span class="nb">select</span><span class="p">))</span> <span class="ow">and</span> <span class="mi">1577836800</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1576022400</span><span class="p">;</span>	<span class="c1">-- choose the appropriate limit timesatmp</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos" data-line="212"></span></a>
</span><span id="L-213"><a href="#L-213"><span class="linenos" data-line="213"></span></a>	<span class="kr">return</span> <span class="p">((</span><span class="n">limit_ts</span> <span class="o">&lt;=</span> <span class="n">rxiv_ts</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rxiv_ts</span> <span class="o">&lt;</span> <span class="n">tomorrow_ts</span><span class="p">))</span>					<span class="c1">-- limit_ts &lt;= rxiv_date &lt; tomorrow&#39;s date</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos" data-line="214"></span></a><span class="kr">end</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos" data-line="215"></span></a>
</span><span id="L-216"><a href="#L-216"><span class="linenos" data-line="216"></span></a>
</span><span id="L-217"><a href="#L-217"><span class="linenos" data-line="217"></span></a><span class="cm">--[[--------------------------&lt; IS _ V A L I D _ I S X N &gt;-----------------------------------------------------</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos" data-line="218"></span></a>
</span><span id="L-219"><a href="#L-219"><span class="linenos" data-line="219"></span></a><span class="cm">ISBN-10 and ISSN validator code calculates checksum across all ISBN/ISSN digits including the check digit.</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos" data-line="220"></span></a><span class="cm">ISBN-13 is checked in isbn().</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos" data-line="221"></span></a>
</span><span id="L-222"><a href="#L-222"><span class="linenos" data-line="222"></span></a><span class="cm">If the number is valid the result will be 0. Before calling this function, ISBN/ISSN must be checked for length</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos" data-line="223"></span></a><span class="cm">and stripped of dashes, spaces and other non-ISxN characters.</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos" data-line="224"></span></a>
</span><span id="L-225"><a href="#L-225"><span class="linenos" data-line="225"></span></a><span class="cm">]]</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos" data-line="226"></span></a>
</span><span id="L-227"><a href="#L-227"><span class="linenos" data-line="227"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">is_valid_isxn</span> <span class="p">(</span><span class="n">isxn_str</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos" data-line="228"></span></a>	<span class="kd">local</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos" data-line="229"></span></a>	<span class="n">isxn_str</span> <span class="o">=</span> <span class="p">{</span> <span class="n">isxn_str</span><span class="p">:</span><span class="n">byte</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="p">};</span>										<span class="c1">-- make a table of byte values &#39;0&#39; → 0x30 .. &#39;9&#39; → 0x39, &#39;X&#39; → 0x58</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos" data-line="230"></span></a>	<span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>																<span class="c1">-- adjust to be a loop counter</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos" data-line="231"></span></a>	<span class="kr">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="kr">in</span> <span class="nb">ipairs</span> <span class="p">(</span><span class="n">isxn_str</span><span class="p">)</span> <span class="kr">do</span>											<span class="c1">-- loop through all of the bytes and calculate the checksum</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos" data-line="232"></span></a>		<span class="kr">if</span> <span class="n">v</span> <span class="o">==</span> <span class="nb">string.byte</span> <span class="p">(</span><span class="s2">&quot;X&quot;</span> <span class="p">)</span> <span class="kr">then</span>											<span class="c1">-- if checkdigit is X (compares the byte value of &#39;X&#39; which is 0x58)</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos" data-line="233"></span></a>			<span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>										<span class="c1">-- it represents 10 decimal</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos" data-line="234"></span></a>		<span class="kr">else</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos" data-line="235"></span></a>			<span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">+</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="nb">string.char</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">len</span><span class="o">-</span><span class="n">i</span><span class="p">);</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos" data-line="236"></span></a>		<span class="kr">end</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos" data-line="237"></span></a>	<span class="kr">end</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos" data-line="238"></span></a>	<span class="kr">return</span> <span class="n">temp</span> <span class="o">%</span> <span class="mi">11</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>														<span class="c1">-- returns true if calculation result is zero</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos" data-line="239"></span></a><span class="kr">end</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos" data-line="240"></span></a>
</span><span id="L-241"><a href="#L-241"><span class="linenos" data-line="241"></span></a>
</span><span id="L-242"><a href="#L-242"><span class="linenos" data-line="242"></span></a><span class="cm">--[[--------------------------&lt; IS _ V A L I D _ I S X N _ 1 3 &gt;-----------------------------------------------</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos" data-line="243"></span></a>
</span><span id="L-244"><a href="#L-244"><span class="linenos" data-line="244"></span></a><span class="cm">ISBN-13 and ISMN validator code calculates checksum across all 13 ISBN/ISMN digits including the check digit.</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos" data-line="245"></span></a><span class="cm">If the number is valid, the result will be 0. Before calling this function, ISBN-13/ISMN must be checked for length</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos" data-line="246"></span></a><span class="cm">and stripped of dashes, spaces and other non-ISxN-13 characters.</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos" data-line="247"></span></a>
</span><span id="L-248"><a href="#L-248"><span class="linenos" data-line="248"></span></a><span class="cm">]]</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos" data-line="249"></span></a>
</span><span id="L-250"><a href="#L-250"><span class="linenos" data-line="250"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">is_valid_isxn_13</span> <span class="p">(</span><span class="n">isxn_str</span><span class="p">)</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos" data-line="251"></span></a>	<span class="kd">local</span> <span class="n">temp</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos" data-line="252"></span></a>	
</span><span id="L-253"><a href="#L-253"><span class="linenos" data-line="253"></span></a>	<span class="n">isxn_str</span> <span class="o">=</span> <span class="p">{</span> <span class="n">isxn_str</span><span class="p">:</span><span class="n">byte</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span> <span class="p">};</span>										<span class="c1">-- make a table of byte values &#39;0&#39; → 0x30 .. &#39;9&#39; → 0x39</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos" data-line="254"></span></a>	<span class="kr">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="kr">in</span> <span class="nb">ipairs</span> <span class="p">(</span><span class="n">isxn_str</span><span class="p">)</span> <span class="kr">do</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos" data-line="255"></span></a>		<span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="nb">string.char</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="p">);</span>			<span class="c1">-- multiply odd index digits by 1, even index digits by 3 and sum; includes check digit</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos" data-line="256"></span></a>	<span class="kr">end</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos" data-line="257"></span></a>	<span class="kr">return</span> <span class="n">temp</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>														<span class="c1">-- sum modulo 10 is zero when ISBN-13/ISMN is correct</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos" data-line="258"></span></a><span class="kr">end</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos" data-line="259"></span></a>
</span><span id="L-260"><a href="#L-260"><span class="linenos" data-line="260"></span></a>
</span><span id="L-261"><a href="#L-261"><span class="linenos" data-line="261"></span></a><span class="cm">--[[--------------------------&lt; N O R M A L I Z E _ L C C N &gt;--------------------------------------------------</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos" data-line="262"></span></a>
</span><span id="L-263"><a href="#L-263"><span class="linenos" data-line="263"></span></a><span class="cm">LCCN normalization (https://www.loc.gov/marc/lccn-namespace.html#normalization)</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos" data-line="264"></span></a><span class="cm">1. Remove all blanks.</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos" data-line="265"></span></a><span class="cm">2. If there is a forward slash (/) in the string, remove it, and remove all characters to the right of the forward slash.</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos" data-line="266"></span></a><span class="cm">3. If there is a hyphen in the string:</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos" data-line="267"></span></a><span class="cm">	a. Remove it.</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos" data-line="268"></span></a><span class="cm">	b. Inspect the substring following (to the right of) the (removed) hyphen. Then (and assuming that steps 1 and 2 have been carried out):</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos" data-line="269"></span></a><span class="cm">		1. All these characters should be digits, and there should be six or less. (not done in this function)</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos" data-line="270"></span></a><span class="cm">		2. If the length of the substring is less than 6, left-fill the substring with zeroes until the length is six.</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos" data-line="271"></span></a>
</span><span id="L-272"><a href="#L-272"><span class="linenos" data-line="272"></span></a><span class="cm">Returns a normalized LCCN for lccn() to validate.  There is no error checking (step 3.b.1) performed in this function.</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos" data-line="273"></span></a>
</span><span id="L-274"><a href="#L-274"><span class="linenos" data-line="274"></span></a><span class="cm">]]</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos" data-line="275"></span></a>
</span><span id="L-276"><a href="#L-276"><span class="linenos" data-line="276"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">normalize_lccn</span> <span class="p">(</span><span class="n">lccn</span><span class="p">)</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos" data-line="277"></span></a>	<span class="n">lccn</span> <span class="o">=</span> <span class="n">lccn</span><span class="p">:</span><span class="n">gsub</span> <span class="p">(</span><span class="s2">&quot;%s&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>												<span class="c1">-- 1. strip whitespace</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos" data-line="278"></span></a>
</span><span id="L-279"><a href="#L-279"><span class="linenos" data-line="279"></span></a>	<span class="kr">if</span> <span class="kc">nil</span> <span class="o">~=</span> <span class="nb">string.find</span> <span class="p">(</span><span class="n">lccn</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos" data-line="280"></span></a>		<span class="n">lccn</span> <span class="o">=</span> <span class="n">lccn</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s2">&quot;(.-)/&quot;</span><span class="p">);</span>											<span class="c1">-- 2. remove forward slash and all character to the right of it</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos" data-line="281"></span></a>	<span class="kr">end</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos" data-line="282"></span></a>
</span><span id="L-283"><a href="#L-283"><span class="linenos" data-line="283"></span></a>	<span class="kd">local</span> <span class="n">prefix</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos" data-line="284"></span></a>	<span class="kd">local</span> <span class="n">suffix</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos" data-line="285"></span></a>	<span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">lccn</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s2">&quot;(.+)%-(.+)&quot;</span><span class="p">);</span>									<span class="c1">-- 3.a remove hyphen by splitting the string into prefix and suffix</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos" data-line="286"></span></a>
</span><span id="L-287"><a href="#L-287"><span class="linenos" data-line="287"></span></a>	<span class="kr">if</span> <span class="kc">nil</span> <span class="o">~=</span> <span class="n">suffix</span> <span class="kr">then</span>														<span class="c1">-- if there was a hyphen</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos" data-line="288"></span></a>		<span class="n">suffix</span> <span class="o">=</span> <span class="nb">string.rep</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="o">-</span><span class="nb">string.len</span> <span class="p">(</span><span class="n">suffix</span><span class="p">))</span> <span class="o">..</span> <span class="n">suffix</span><span class="p">;</span>				<span class="c1">-- 3.b.2 left fill the suffix with 0s if suffix length less than 6</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos" data-line="289"></span></a>		<span class="n">lccn</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">..</span><span class="n">suffix</span><span class="p">;</span>													<span class="c1">-- reassemble the LCCN</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos" data-line="290"></span></a>	<span class="kr">end</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos" data-line="291"></span></a>	
</span><span id="L-292"><a href="#L-292"><span class="linenos" data-line="292"></span></a>	<span class="kr">return</span> <span class="n">lccn</span><span class="p">;</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos" data-line="293"></span></a>	<span class="kr">end</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos" data-line="294"></span></a>
</span><span id="L-295"><a href="#L-295"><span class="linenos" data-line="295"></span></a>
</span><span id="L-296"><a href="#L-296"><span class="linenos" data-line="296"></span></a><span class="c1">--============================&lt;&lt; I D E N T I F I E R   F U N C T I O N S &gt;&gt;====================================</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos" data-line="297"></span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos" data-line="298"></span></a><span class="cm">--[[--------------------------&lt; A R X I V &gt;--------------------------------------------------------------------</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos" data-line="299"></span></a>
</span><span id="L-300"><a href="#L-300"><span class="linenos" data-line="300"></span></a><span class="cm">See: https://arxiv.org/help/arxiv_identifier</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos" data-line="301"></span></a>
</span><span id="L-302"><a href="#L-302"><span class="linenos" data-line="302"></span></a><span class="cm">format and error check arXiv identifier.  There are three valid forms of the identifier:</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos" data-line="303"></span></a><span class="cm">the first form, valid only between date codes 9107 and 0703, is:</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos" data-line="304"></span></a><span class="cm">	arXiv:&lt;archive&gt;.&lt;class&gt;/&lt;date code&gt;&lt;number&gt;&lt;version&gt;</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos" data-line="305"></span></a><span class="cm">where:</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos" data-line="306"></span></a><span class="cm">	&lt;archive&gt; is a string of alpha characters - may be hyphenated; no other punctuation</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos" data-line="307"></span></a><span class="cm">	&lt;class&gt; is a string of alpha characters - may be hyphenated; no other punctuation; not the same as |class= parameter which is not supported in this form</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos" data-line="308"></span></a><span class="cm">	&lt;date code&gt; is four digits in the form YYMM where YY is the last two digits of the four-digit year and MM is the month number January = 01</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos" data-line="309"></span></a><span class="cm">		first digit of YY for this form can only 9 and 0</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos" data-line="310"></span></a><span class="cm">	&lt;number&gt; is a three-digit number</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos" data-line="311"></span></a><span class="cm">	&lt;version&gt; is a 1 or more digit number preceded with a lowercase v; no spaces (undocumented)</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos" data-line="312"></span></a><span class="cm">	</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos" data-line="313"></span></a><span class="cm">the second form, valid from April 2007 through December 2014 is:</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos" data-line="314"></span></a><span class="cm">	arXiv:&lt;date code&gt;.&lt;number&gt;&lt;version&gt;</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos" data-line="315"></span></a><span class="cm">where:</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos" data-line="316"></span></a><span class="cm">	&lt;date code&gt; is four digits in the form YYMM where YY is the last two digits of the four-digit year and MM is the month number January = 01</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos" data-line="317"></span></a><span class="cm">	&lt;number&gt; is a four-digit number</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos" data-line="318"></span></a><span class="cm">	&lt;version&gt; is a 1 or more digit number preceded with a lowercase v; no spaces</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos" data-line="319"></span></a>
</span><span id="L-320"><a href="#L-320"><span class="linenos" data-line="320"></span></a><span class="cm">the third form, valid from January 2015 is:</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos" data-line="321"></span></a><span class="cm">	arXiv:&lt;date code&gt;.&lt;number&gt;&lt;version&gt;</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos" data-line="322"></span></a><span class="cm">where:</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos" data-line="323"></span></a><span class="cm">	&lt;date code&gt; and &lt;version&gt; are as defined for 0704-1412</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos" data-line="324"></span></a><span class="cm">	&lt;number&gt; is a five-digit number</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos" data-line="325"></span></a>
</span><span id="L-326"><a href="#L-326"><span class="linenos" data-line="326"></span></a><span class="cm">]]</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos" data-line="327"></span></a>
</span><span id="L-328"><a href="#L-328"><span class="linenos" data-line="328"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">arxiv</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos" data-line="329"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos" data-line="330"></span></a>	<span class="kd">local</span> <span class="n">class</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">Class</span><span class="p">;</span>												<span class="c1">-- TODO: lowercase?</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos" data-line="331"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos" data-line="332"></span></a>	<span class="kd">local</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">version</span><span class="p">;</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos" data-line="333"></span></a>	<span class="kd">local</span> <span class="n">err_msg</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>														<span class="c1">-- assume no error message</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos" data-line="334"></span></a>	<span class="kd">local</span> <span class="n">text</span><span class="p">;</span>																	<span class="c1">-- output text</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos" data-line="335"></span></a>	
</span><span id="L-336"><a href="#L-336"><span class="linenos" data-line="336"></span></a>	<span class="kr">if</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^%a[%a%.%-]+/[90]%d[01]%d%d%d%d$&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^%a[%a%.%-]+/[90]%d[01]%d%d%d%dv%d+$&quot;</span><span class="p">)</span> <span class="kr">then</span>	<span class="c1">-- test for the 9107-0703 format with or without version</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos" data-line="337"></span></a>		<span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^%a[%a%.%-]+/([90]%d)([01]%d)%d%d%d[v%d]*$&quot;</span><span class="p">);</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos" data-line="338"></span></a>		<span class="n">year</span> <span class="o">=</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="n">year</span><span class="p">);</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos" data-line="339"></span></a>		<span class="n">month</span> <span class="o">=</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="n">month</span><span class="p">);</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos" data-line="340"></span></a>		<span class="kr">if</span> <span class="p">((</span><span class="ow">not</span> <span class="p">(</span><span class="mi">90</span> <span class="o">&lt;</span> <span class="n">year</span> <span class="ow">or</span> <span class="mi">8</span> <span class="o">&gt;</span> <span class="n">year</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&gt;</span> <span class="n">month</span> <span class="ow">or</span> <span class="mi">12</span> <span class="o">&lt;</span> <span class="n">month</span><span class="p">))</span> <span class="ow">or</span>		<span class="c1">-- if invalid year or invalid month</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos" data-line="341"></span></a>			<span class="p">((</span><span class="mi">91</span> <span class="o">==</span> <span class="n">year</span> <span class="ow">and</span> <span class="mi">7</span> <span class="o">&gt;</span> <span class="n">month</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">7</span> <span class="o">==</span> <span class="n">year</span> <span class="ow">and</span> <span class="mi">3</span> <span class="o">&lt;</span> <span class="n">month</span><span class="p">))</span> <span class="kr">then</span>		<span class="c1">-- if years ok, are starting and ending months ok?</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos" data-line="342"></span></a>				<span class="n">err_msg</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>													<span class="c1">-- flag for error message</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos" data-line="343"></span></a>		<span class="kr">end</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos" data-line="344"></span></a>
</span><span id="L-345"><a href="#L-345"><span class="linenos" data-line="345"></span></a>	<span class="kr">elseif</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^%d%d[01]%d%.%d%d%d%d$&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^%d%d[01]%d%.%d%d%d%dv%d+$&quot;</span><span class="p">)</span> <span class="kr">then</span>	<span class="c1">-- test for the 0704-1412 with or without version</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos" data-line="346"></span></a>		<span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^(%d%d)([01]%d)%.%d%d%d%d[v%d]*$&quot;</span><span class="p">);</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos" data-line="347"></span></a>		<span class="n">year</span> <span class="o">=</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="n">year</span><span class="p">);</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos" data-line="348"></span></a>		<span class="n">month</span> <span class="o">=</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="n">month</span><span class="p">);</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos" data-line="349"></span></a>		<span class="kr">if</span> <span class="p">((</span><span class="mi">7</span> <span class="o">&gt;</span> <span class="n">year</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">14</span> <span class="o">&lt;</span> <span class="n">year</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&gt;</span> <span class="n">month</span> <span class="ow">or</span> <span class="mi">12</span> <span class="o">&lt;</span> <span class="n">month</span><span class="p">))</span> <span class="ow">or</span>			<span class="c1">-- is year invalid or is month invalid? (doesn&#39;t test for future years)</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos" data-line="350"></span></a>			<span class="p">((</span><span class="mi">7</span> <span class="o">==</span> <span class="n">year</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&gt;</span> <span class="n">month</span><span class="p">))</span> <span class="kr">then</span>									<span class="c1">-- when year is 07, is month invalid (before April)?</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos" data-line="351"></span></a>				<span class="n">err_msg</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>													<span class="c1">-- flag for error message</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos" data-line="352"></span></a>		<span class="kr">end</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos" data-line="353"></span></a>
</span><span id="L-354"><a href="#L-354"><span class="linenos" data-line="354"></span></a>	<span class="kr">elseif</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^%d%d[01]%d%.%d%d%d%d%d$&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^%d%d[01]%d%.%d%d%d%d%dv%d+$&quot;</span><span class="p">)</span> <span class="kr">then</span>	<span class="c1">-- test for the 1501- format with or without version</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos" data-line="355"></span></a>		<span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^(%d%d)([01]%d)%.%d%d%d%d%d[v%d]*$&quot;</span><span class="p">);</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos" data-line="356"></span></a>		<span class="n">year</span> <span class="o">=</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="n">year</span><span class="p">);</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos" data-line="357"></span></a>		<span class="n">month</span> <span class="o">=</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="n">month</span><span class="p">);</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos" data-line="358"></span></a>		<span class="kr">if</span> <span class="p">((</span><span class="mi">15</span> <span class="o">&gt;</span> <span class="n">year</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&gt;</span> <span class="n">month</span> <span class="ow">or</span> <span class="mi">12</span> <span class="o">&lt;</span> <span class="n">month</span><span class="p">))</span> <span class="kr">then</span>						<span class="c1">-- is year invalid or is month invalid? (doesn&#39;t test for future years)</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos" data-line="359"></span></a>			<span class="n">err_msg</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>														<span class="c1">-- flag for error message</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos" data-line="360"></span></a>		<span class="kr">end</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos" data-line="361"></span></a>
</span><span id="L-362"><a href="#L-362"><span class="linenos" data-line="362"></span></a>	<span class="kr">else</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos" data-line="363"></span></a>		<span class="n">err_msg</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>															<span class="c1">-- not a recognized format; flag for error message</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos" data-line="364"></span></a>	<span class="kr">end</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos" data-line="365"></span></a>
</span><span id="L-366"><a href="#L-366"><span class="linenos" data-line="366"></span></a>	<span class="kr">if</span> <span class="n">err_msg</span> <span class="kr">then</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos" data-line="367"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;ARXIV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>									<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos" data-line="368"></span></a>	<span class="kr">end</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos" data-line="369"></span></a>	
</span><span id="L-370"><a href="#L-370"><span class="linenos" data-line="370"></span></a>	<span class="kd">local</span> <span class="n">err_msg_t</span> <span class="o">=</span> <span class="p">{};</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos" data-line="371"></span></a>	<span class="kr">if</span> <span class="n">err_msg</span> <span class="kr">then</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos" data-line="372"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_arxiv&#39;</span><span class="p">);</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos" data-line="373"></span></a>	<span class="kr">end</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos" data-line="374"></span></a>
</span><span id="L-375"><a href="#L-375"><span class="linenos" data-line="375"></span></a>	<span class="n">text</span> <span class="o">=</span> <span class="n">external_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos" data-line="376"></span></a>			<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span> <span class="n">encode</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">encode</span><span class="p">,</span> <span class="n">access</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">access</span><span class="p">});</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos" data-line="377"></span></a>
</span><span id="L-378"><a href="#L-378"><span class="linenos" data-line="378"></span></a>	<span class="kr">if</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">class</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos" data-line="379"></span></a>		<span class="kr">if</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s1">&#39;^%d+&#39;</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos" data-line="380"></span></a>			<span class="n">text</span> <span class="o">=</span> <span class="nb">table.concat</span> <span class="p">({</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39; [[https://arxiv.org/archive/&#39;</span><span class="p">,</span> <span class="n">class</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">class</span><span class="p">,</span> <span class="s1">&#39;]]&#39;</span><span class="p">});</span>	<span class="c1">-- external link within square brackets, not wikilink</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos" data-line="381"></span></a>		<span class="kr">else</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos" data-line="382"></span></a>			<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_class_ignored&#39;</span><span class="p">);</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos" data-line="383"></span></a>		<span class="kr">end</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos" data-line="384"></span></a>	<span class="kr">end</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos" data-line="385"></span></a>
</span><span id="L-386"><a href="#L-386"><span class="linenos" data-line="386"></span></a>	<span class="kr">return</span> <span class="n">text</span><span class="p">;</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos" data-line="387"></span></a><span class="kr">end</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos" data-line="388"></span></a>
</span><span id="L-389"><a href="#L-389"><span class="linenos" data-line="389"></span></a>
</span><span id="L-390"><a href="#L-390"><span class="linenos" data-line="390"></span></a><span class="cm">--[[--------------------------&lt; B I B C O D E &gt;--------------------------------------------------------------------</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos" data-line="391"></span></a>
</span><span id="L-392"><a href="#L-392"><span class="linenos" data-line="392"></span></a><span class="cm">Validates (sort of) and formats a bibcode ID.</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos" data-line="393"></span></a>
</span><span id="L-394"><a href="#L-394"><span class="linenos" data-line="394"></span></a><span class="cm">Format for bibcodes is specified here: https://adsabs.harvard.edu/abs_doc/help_pages/data.html#bibcodes</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos" data-line="395"></span></a>
</span><span id="L-396"><a href="#L-396"><span class="linenos" data-line="396"></span></a><span class="cm">But, this: 2015arXiv151206696F is apparently valid so apparently, the only things that really matter are length, 19 characters</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos" data-line="397"></span></a><span class="cm">and first four digits must be a year.  This function makes these tests:</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos" data-line="398"></span></a><span class="cm">	length must be 19 characters</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos" data-line="399"></span></a><span class="cm">	characters in position</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos" data-line="400"></span></a><span class="cm">		1–4 must be digits and must represent a year in the range of 1000 – next year</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos" data-line="401"></span></a><span class="cm">		5 must be a letter</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos" data-line="402"></span></a><span class="cm">		6–8 must be letter, digit, ampersand, or dot (ampersand cannot directly precede a dot; &amp;. )</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos" data-line="403"></span></a><span class="cm">		9–18 must be letter, digit, or dot</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos" data-line="404"></span></a><span class="cm">		19 must be a letter or dot</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos" data-line="405"></span></a>
</span><span id="L-406"><a href="#L-406"><span class="linenos" data-line="406"></span></a><span class="cm">]]</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos" data-line="407"></span></a>
</span><span id="L-408"><a href="#L-408"><span class="linenos" data-line="408"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">bibcode</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos" data-line="409"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos" data-line="410"></span></a>	<span class="kd">local</span> <span class="n">access</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">access</span><span class="p">;</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos" data-line="411"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos" data-line="412"></span></a>	<span class="kd">local</span> <span class="n">ignore_invalid</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">accept</span><span class="p">;</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos" data-line="413"></span></a>	<span class="kd">local</span> <span class="n">err_type</span><span class="p">;</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos" data-line="414"></span></a>	<span class="kd">local</span> <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos" data-line="415"></span></a>	<span class="kd">local</span> <span class="n">year</span><span class="p">;</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos" data-line="416"></span></a>
</span><span id="L-417"><a href="#L-417"><span class="linenos" data-line="417"></span></a>	<span class="kd">local</span> <span class="n">text</span> <span class="o">=</span> <span class="n">external_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos" data-line="418"></span></a>		<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span> <span class="n">encode</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">encode</span><span class="p">,</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos" data-line="419"></span></a>		<span class="n">access</span> <span class="o">=</span> <span class="n">access</span><span class="p">});</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos" data-line="420"></span></a>	
</span><span id="L-421"><a href="#L-421"><span class="linenos" data-line="421"></span></a>	<span class="kr">if</span> <span class="mi">19</span> <span class="o">~=</span> <span class="n">id</span><span class="p">:</span><span class="n">len</span><span class="p">()</span> <span class="kr">then</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos" data-line="422"></span></a>		<span class="n">err_type</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="n">err_msg_supl</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos" data-line="423"></span></a>	<span class="kr">else</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos" data-line="424"></span></a>		<span class="n">year</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s2">&quot;^(%d%d%d%d)[%a][%w&amp;%.][%w&amp;%.][%w&amp;%.][%w.]+[%a%.]$&quot;</span><span class="p">);</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos" data-line="425"></span></a>		<span class="kr">if</span> <span class="ow">not</span> <span class="n">year</span> <span class="kr">then</span>														<span class="c1">-- if nil then no pattern match</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos" data-line="426"></span></a>			<span class="n">err_type</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="n">err_msg_supl</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>									<span class="c1">-- so value error</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos" data-line="427"></span></a>		<span class="kr">else</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos" data-line="428"></span></a>			<span class="kd">local</span> <span class="n">next_year</span> <span class="o">=</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="nb">os.date</span> <span class="p">(</span><span class="s1">&#39;%Y&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>					<span class="c1">-- get the current year as a number and add one for next year</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos" data-line="429"></span></a>			<span class="n">year</span> <span class="o">=</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="n">year</span><span class="p">);</span>												<span class="c1">-- convert year portion of bibcode to a number</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos" data-line="430"></span></a>			<span class="kr">if</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">&gt;</span> <span class="n">year</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span> <span class="o">&gt;</span> <span class="n">next_year</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos" data-line="431"></span></a>				<span class="n">err_type</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="n">err_msg_supl</span><span class="p">.</span><span class="n">year</span><span class="p">;</span>								<span class="c1">-- year out of bounds</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos" data-line="432"></span></a>			<span class="kr">end</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos" data-line="433"></span></a>			<span class="kr">if</span> <span class="n">id</span><span class="p">:</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;&amp;%.&#39;</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos" data-line="434"></span></a>				<span class="n">err_type</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="n">err_msg_supl</span><span class="p">.</span><span class="n">journal</span><span class="p">;</span>							<span class="c1">-- journal abbreviation must not have &#39;&amp;.&#39; (if it does it&#39;s missing a letter)</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos" data-line="435"></span></a>			<span class="kr">end</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos" data-line="436"></span></a>			<span class="kr">if</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s1">&#39;.........%.tmp%.&#39;</span><span class="p">)</span> <span class="kr">then</span>								<span class="c1">-- temporary bibcodes when positions 10–14 are &#39;.tmp.&#39;</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos" data-line="437"></span></a>				<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;maint_bibcode&#39;</span><span class="p">);</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos" data-line="438"></span></a>			<span class="kr">end</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos" data-line="439"></span></a>		<span class="kr">end</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos" data-line="440"></span></a>	<span class="kr">end</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos" data-line="441"></span></a>
</span><span id="L-442"><a href="#L-442"><span class="linenos" data-line="442"></span></a>	<span class="kr">if</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">err_type</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ignore_invalid</span> <span class="kr">then</span>							<span class="c1">-- if there was an error detected and accept-as-written markup not used</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos" data-line="443"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_bibcode&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">err_type</span><span class="p">});</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos" data-line="444"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;BIBCODE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>									<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos" data-line="445"></span></a>	<span class="kr">end</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos" data-line="446"></span></a>
</span><span id="L-447"><a href="#L-447"><span class="linenos" data-line="447"></span></a>	<span class="kr">return</span> <span class="n">text</span><span class="p">;</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos" data-line="448"></span></a><span class="kr">end</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos" data-line="449"></span></a>
</span><span id="L-450"><a href="#L-450"><span class="linenos" data-line="450"></span></a>
</span><span id="L-451"><a href="#L-451"><span class="linenos" data-line="451"></span></a><span class="cm">--[[--------------------------&lt; B I O R X I V &gt;-----------------------------------------------------------------</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos" data-line="452"></span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos" data-line="453"></span></a><span class="cm">Format bioRxiv ID and do simple error checking.  Before 2019-12-11, biorXiv IDs were 10.1101/ followed by exactly</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos" data-line="454"></span></a><span class="cm">6 digits.  After 2019-12-11, biorXiv IDs retained the six-digit identifier but prefixed that with a yyyy.mm.dd. </span>
</span><span id="L-455"><a href="#L-455"><span class="linenos" data-line="455"></span></a><span class="cm">date and suffixed with an optional version identifier.</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos" data-line="456"></span></a>
</span><span id="L-457"><a href="#L-457"><span class="linenos" data-line="457"></span></a><span class="cm">The bioRxiv ID is the string of characters:</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos" data-line="458"></span></a><span class="cm">	https://doi.org/10.1101/078733 -&gt; 10.1101/078733</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos" data-line="459"></span></a><span class="cm">or a date followed by a six-digit number followed by an optional version indicator &#39;v&#39; and one or more digits:</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos" data-line="460"></span></a><span class="cm">	https://www.biorxiv.org/content/10.1101/2019.12.11.123456v2 -&gt; 10.1101/2019.12.11.123456v2</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos" data-line="461"></span></a><span class="cm">	</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos" data-line="462"></span></a><span class="cm">see https://www.biorxiv.org/about-biorxiv</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos" data-line="463"></span></a>
</span><span id="L-464"><a href="#L-464"><span class="linenos" data-line="464"></span></a><span class="cm">]]</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos" data-line="465"></span></a>
</span><span id="L-466"><a href="#L-466"><span class="linenos" data-line="466"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">biorxiv</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos" data-line="467"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos" data-line="468"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos" data-line="469"></span></a>	<span class="kd">local</span> <span class="n">err_msg</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>														<span class="c1">-- flag; assume that there will be an error</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos" data-line="470"></span></a>	
</span><span id="L-471"><a href="#L-471"><span class="linenos" data-line="471"></span></a>	<span class="kd">local</span> <span class="n">patterns</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos" data-line="472"></span></a>		<span class="s1">&#39;^10%.1101/%d%d%d%d%d%d$&#39;</span><span class="p">,</span>												<span class="c1">-- simple 6-digit identifier (before 2019-12-11)</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos" data-line="473"></span></a>		<span class="s1">&#39;^10%.1101/(20%d%d)%.(%d%d)%.(%d%d)%.%d%d%d%d%d%dv%d+$&#39;</span><span class="p">,</span>				<span class="c1">-- y.m.d. date + 6-digit identifier + version (after 2019-12-11)</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos" data-line="474"></span></a>		<span class="s1">&#39;^10%.1101/(20%d%d)%.(%d%d)%.(%d%d)%.%d%d%d%d%d%d$&#39;</span><span class="p">,</span>					<span class="c1">-- y.m.d. date + 6-digit identifier (after 2019-12-11)</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos" data-line="475"></span></a>		<span class="p">}</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos" data-line="476"></span></a>	
</span><span id="L-477"><a href="#L-477"><span class="linenos" data-line="477"></span></a>	<span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">pattern</span> <span class="kr">in</span> <span class="nb">ipairs</span> <span class="p">(</span><span class="n">patterns</span><span class="p">)</span> <span class="kr">do</span>										<span class="c1">-- spin through the patterns looking for a match</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos" data-line="478"></span></a>		<span class="kr">if</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos" data-line="479"></span></a>			<span class="kd">local</span> <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="n">pattern</span><span class="p">);</span>									<span class="c1">-- found a match, attempt to get year, month and date from the identifier</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos" data-line="480"></span></a>
</span><span id="L-481"><a href="#L-481"><span class="linenos" data-line="481"></span></a>			<span class="kr">if</span> <span class="n">m</span> <span class="kr">then</span>															<span class="c1">-- m is nil when id is the six-digit form</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos" data-line="482"></span></a>				<span class="kr">if</span> <span class="ow">not</span> <span class="n">is_valid_rxiv_date</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="kr">then</span>					<span class="c1">-- validate the encoded date; &#39;b&#39; for biorxiv limit</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos" data-line="483"></span></a>					<span class="kr">break</span><span class="p">;</span>														<span class="c1">-- date fail; break out early so we don&#39;t unset the error message</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos" data-line="484"></span></a>				<span class="kr">end</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos" data-line="485"></span></a>			<span class="kr">end</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos" data-line="486"></span></a>			<span class="n">err_msg</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>														<span class="c1">-- we found a match so unset the error message</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos" data-line="487"></span></a>			<span class="kr">break</span><span class="p">;</span>																<span class="c1">-- and done</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos" data-line="488"></span></a>		<span class="kr">end</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos" data-line="489"></span></a>	<span class="kr">end</span>																			<span class="c1">-- err_cat remains set here when no match</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos" data-line="490"></span></a>
</span><span id="L-491"><a href="#L-491"><span class="linenos" data-line="491"></span></a>	<span class="kr">if</span> <span class="n">err_msg</span> <span class="kr">then</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos" data-line="492"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;BIORXIV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>									<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos" data-line="493"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_biorxiv&#39;</span><span class="p">);</span>										<span class="c1">-- and set the error message</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos" data-line="494"></span></a>	<span class="kr">end</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos" data-line="495"></span></a>	
</span><span id="L-496"><a href="#L-496"><span class="linenos" data-line="496"></span></a>	<span class="kr">return</span> <span class="n">external_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos" data-line="497"></span></a>			<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos" data-line="498"></span></a>			<span class="n">encode</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">encode</span><span class="p">,</span> <span class="n">access</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">access</span><span class="p">});</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos" data-line="499"></span></a><span class="kr">end</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos" data-line="500"></span></a>
</span><span id="L-501"><a href="#L-501"><span class="linenos" data-line="501"></span></a>
</span><span id="L-502"><a href="#L-502"><span class="linenos" data-line="502"></span></a><span class="cm">--[[--------------------------&lt; C I T E S E E R X &gt;------------------------------------------------------------</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos" data-line="503"></span></a>
</span><span id="L-504"><a href="#L-504"><span class="linenos" data-line="504"></span></a><span class="cm">CiteSeerX use their own notion of &quot;doi&quot; (not to be confused with the identifiers resolved via doi.org).</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos" data-line="505"></span></a>
</span><span id="L-506"><a href="#L-506"><span class="linenos" data-line="506"></span></a><span class="cm">The description of the structure of this identifier can be found at Help_talk:Citation_Style_1/Archive_26#CiteSeerX_id_structure</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos" data-line="507"></span></a>
</span><span id="L-508"><a href="#L-508"><span class="linenos" data-line="508"></span></a><span class="cm">]]</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos" data-line="509"></span></a>
</span><span id="L-510"><a href="#L-510"><span class="linenos" data-line="510"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">citeseerx</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos" data-line="511"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos" data-line="512"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos" data-line="513"></span></a>	<span class="kd">local</span> <span class="n">matched</span><span class="p">;</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos" data-line="514"></span></a>
</span><span id="L-515"><a href="#L-515"><span class="linenos" data-line="515"></span></a>	<span class="kd">local</span> <span class="n">text</span> <span class="o">=</span> <span class="n">external_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos" data-line="516"></span></a>		<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span> <span class="n">encode</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">encode</span><span class="p">,</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos" data-line="517"></span></a>		<span class="n">access</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">access</span><span class="p">});</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos" data-line="518"></span></a>	
</span><span id="L-519"><a href="#L-519"><span class="linenos" data-line="519"></span></a>	<span class="n">matched</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s2">&quot;^10%.1%.1%.[1-9]%d?%d?%d?%.[1-9]%d?%d?%d?$&quot;</span><span class="p">);</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos" data-line="520"></span></a>	<span class="kr">if</span> <span class="ow">not</span> <span class="n">matched</span> <span class="kr">then</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos" data-line="521"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_citeseerx&#39;</span> <span class="p">);</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos" data-line="522"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;CITESEERX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>								<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos" data-line="523"></span></a>	<span class="kr">end</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos" data-line="524"></span></a>
</span><span id="L-525"><a href="#L-525"><span class="linenos" data-line="525"></span></a>	<span class="kr">return</span> <span class="n">text</span><span class="p">;</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos" data-line="526"></span></a><span class="kr">end</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos" data-line="527"></span></a>
</span><span id="L-528"><a href="#L-528"><span class="linenos" data-line="528"></span></a>
</span><span id="L-529"><a href="#L-529"><span class="linenos" data-line="529"></span></a><span class="cm">--[[--------------------------&lt; D O I &gt;------------------------------------------------------------------------</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos" data-line="530"></span></a>
</span><span id="L-531"><a href="#L-531"><span class="linenos" data-line="531"></span></a><span class="cm">Formats a DOI and checks for DOI errors.</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos" data-line="532"></span></a>
</span><span id="L-533"><a href="#L-533"><span class="linenos" data-line="533"></span></a><span class="cm">DOI names contain two parts: prefix and suffix separated by a forward slash.</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos" data-line="534"></span></a><span class="cm">	Prefix: directory indicator &#39;10.&#39; followed by a registrant code</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos" data-line="535"></span></a><span class="cm">	Suffix: character string of any length chosen by the registrant</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos" data-line="536"></span></a>
</span><span id="L-537"><a href="#L-537"><span class="linenos" data-line="537"></span></a><span class="cm">This function checks a DOI name for: prefix/suffix.  If the DOI name contains spaces or endashes, or, if it ends</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos" data-line="538"></span></a><span class="cm">with a period or a comma, this function will emit a bad_doi error message.</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos" data-line="539"></span></a>
</span><span id="L-540"><a href="#L-540"><span class="linenos" data-line="540"></span></a><span class="cm">DOI names are case-insensitive and can incorporate any printable Unicode characters so the test for spaces, endash,</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos" data-line="541"></span></a><span class="cm">and terminal punctuation may not be technically correct but it appears, that in practice these characters are rarely</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos" data-line="542"></span></a><span class="cm">if ever used in DOI names.</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos" data-line="543"></span></a>
</span><span id="L-544"><a href="#L-544"><span class="linenos" data-line="544"></span></a><span class="cm">https://www.doi.org/doi_handbook/2_Numbering.html				-- 2.2 Syntax of a DOI name</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos" data-line="545"></span></a><span class="cm">https://www.doi.org/doi_handbook/2_Numbering.html#2.2.2			-- 2.2.2 DOI prefix</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos" data-line="546"></span></a>
</span><span id="L-547"><a href="#L-547"><span class="linenos" data-line="547"></span></a><span class="cm">]]</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos" data-line="548"></span></a>
</span><span id="L-549"><a href="#L-549"><span class="linenos" data-line="549"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">doi</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos" data-line="550"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos" data-line="551"></span></a>	<span class="kd">local</span> <span class="n">inactive</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">DoiBroken</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos" data-line="552"></span></a>	<span class="kd">local</span> <span class="n">access</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">access</span><span class="p">;</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos" data-line="553"></span></a>	<span class="kd">local</span> <span class="n">ignore_invalid</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">accept</span><span class="p">;</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos" data-line="554"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos" data-line="555"></span></a>	<span class="kd">local</span> <span class="n">err_flag</span><span class="p">;</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos" data-line="556"></span></a>
</span><span id="L-557"><a href="#L-557"><span class="linenos" data-line="557"></span></a>	<span class="kd">local</span> <span class="kr">function</span> <span class="nf">is_extended_free</span> <span class="p">(</span><span class="n">registrant</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>						<span class="c1">-- local function to check those few registrants that are mixed; identifiable by the doi suffix &lt;incipit&gt;</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos" data-line="558"></span></a>		<span class="kr">if</span> <span class="n">cfg</span><span class="p">.</span><span class="n">extended_registrants_t</span><span class="p">[</span><span class="n">registrant</span><span class="p">]</span> <span class="kr">then</span>							<span class="c1">-- if this registrant has known free-to-read extentions</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos" data-line="559"></span></a>			<span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">incipit</span> <span class="kr">in</span> <span class="nb">ipairs</span> <span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">extended_registrants_t</span><span class="p">[</span><span class="n">registrant</span><span class="p">])</span> <span class="kr">do</span>	<span class="c1">-- loop through the registrant&#39;s incipits</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos" data-line="560"></span></a>				<span class="kr">if</span> <span class="n">mw</span><span class="p">.</span><span class="n">ustring</span><span class="p">.</span><span class="n">find</span> <span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span> <span class="o">..</span> <span class="n">incipit</span><span class="p">)</span> <span class="kr">then</span>				<span class="c1">-- if found</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos" data-line="561"></span></a>					<span class="kr">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos" data-line="562"></span></a>				<span class="kr">end</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos" data-line="563"></span></a>			<span class="kr">end</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos" data-line="564"></span></a>		<span class="kr">end</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos" data-line="565"></span></a>	<span class="kr">end</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos" data-line="566"></span></a>
</span><span id="L-567"><a href="#L-567"><span class="linenos" data-line="567"></span></a>	<span class="kd">local</span> <span class="n">text</span><span class="p">;</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos" data-line="568"></span></a>	<span class="kr">if</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">inactive</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos" data-line="569"></span></a>		<span class="kd">local</span> <span class="n">inactive_year</span> <span class="o">=</span> <span class="n">inactive</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;%d%d%d%d&quot;</span><span class="p">);</span>						<span class="c1">-- try to get the year portion from the inactive date</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos" data-line="570"></span></a>		<span class="kd">local</span> <span class="n">inactive_month</span><span class="p">,</span> <span class="n">good</span><span class="p">;</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos" data-line="571"></span></a>
</span><span id="L-572"><a href="#L-572"><span class="linenos" data-line="572"></span></a>		<span class="kr">if</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">inactive_year</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos" data-line="573"></span></a>			<span class="kr">if</span> <span class="mi">4</span> <span class="o">&lt;</span> <span class="n">inactive</span><span class="p">:</span><span class="n">len</span><span class="p">()</span> <span class="kr">then</span>											<span class="c1">-- inactive date has more than just a year (could be anything)</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos" data-line="574"></span></a>				<span class="kd">local</span> <span class="n">lang_obj</span> <span class="o">=</span> <span class="n">mw</span><span class="p">.</span><span class="n">getContentLanguage</span><span class="p">();</span>						<span class="c1">-- get a language object for this wiki</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos" data-line="575"></span></a>				<span class="n">good</span><span class="p">,</span> <span class="n">inactive_month</span> <span class="o">=</span> <span class="nb">pcall</span> <span class="p">(</span><span class="n">lang_obj</span><span class="p">.</span><span class="n">formatDate</span><span class="p">,</span> <span class="n">lang_obj</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="n">inactive</span><span class="p">);</span>	<span class="c1">-- try to get the month name from the inactive date</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos" data-line="576"></span></a>				<span class="kr">if</span> <span class="ow">not</span> <span class="n">good</span> <span class="kr">then</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos" data-line="577"></span></a>					<span class="n">inactive_month</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>										<span class="c1">-- something went wrong so make sure this is unset</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos" data-line="578"></span></a>				<span class="kr">end</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos" data-line="579"></span></a>			<span class="kr">end</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos" data-line="580"></span></a>		<span class="kr">end</span>																		<span class="c1">-- otherwise, |doi-broken-date= has something but it isn&#39;t a date</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos" data-line="581"></span></a>		
</span><span id="L-582"><a href="#L-582"><span class="linenos" data-line="582"></span></a>		<span class="kr">if</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">inactive_year</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">inactive_month</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos" data-line="583"></span></a>			<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;maint_doi_inactive_dated&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">inactive_year</span><span class="p">,</span> <span class="n">inactive_month</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">});</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos" data-line="584"></span></a>		<span class="kr">elseif</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">inactive_year</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos" data-line="585"></span></a>			<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;maint_doi_inactive_dated&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">inactive_year</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">});</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos" data-line="586"></span></a>		<span class="kr">else</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos" data-line="587"></span></a>			<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;maint_doi_inactive&#39;</span><span class="p">);</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos" data-line="588"></span></a>		<span class="kr">end</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos" data-line="589"></span></a>		<span class="n">inactive</span> <span class="o">=</span> <span class="s2">&quot; (&quot;</span> <span class="o">..</span> <span class="n">cfg</span><span class="p">.</span><span class="n">messages</span><span class="p">[</span><span class="s1">&#39;inactive&#39;</span><span class="p">]</span> <span class="o">..</span> <span class="s1">&#39; &#39;</span> <span class="o">..</span> <span class="n">inactive</span> <span class="o">..</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos" data-line="590"></span></a>	<span class="kr">end</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos" data-line="591"></span></a>
</span><span id="L-592"><a href="#L-592"><span class="linenos" data-line="592"></span></a>	<span class="kd">local</span> <span class="n">suffix</span><span class="p">;</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos" data-line="593"></span></a>	<span class="kd">local</span> <span class="n">registrant</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">mw</span><span class="p">.</span><span class="n">ustring</span><span class="p">.</span><span class="n">match</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;^10%.([^/]+)/([^%s–]-[^%.,])$&#39;</span><span class="p">);</span>	<span class="c1">-- registrant and suffix set when DOI has the proper basic form</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos" data-line="594"></span></a>
</span><span id="L-595"><a href="#L-595"><span class="linenos" data-line="595"></span></a>	<span class="kd">local</span> <span class="n">registrant_err_patterns</span> <span class="o">=</span> <span class="p">{</span>											<span class="c1">-- these patterns are for code ranges that are not supported </span>
</span><span id="L-596"><a href="#L-596"><span class="linenos" data-line="596"></span></a>		<span class="s1">&#39;^[^1-3]%d%d%d%d%.%d+$&#39;</span><span class="p">,</span>												<span class="c1">-- 5 digits with subcode (0xxxx, 40000+); accepts: 10000–39999</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos" data-line="597"></span></a>		<span class="s1">&#39;^[^1-7]%d%d%d%d$&#39;</span><span class="p">,</span>														<span class="c1">-- 5 digits without subcode (0xxxx, 60000+); accepts: 10000–69999</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos" data-line="598"></span></a>		<span class="s1">&#39;^[^1-9]%d%d%d%.%d+$&#39;</span><span class="p">,</span>												<span class="c1">-- 4 digits with subcode (0xxx); accepts: 1000–9999</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos" data-line="599"></span></a>		<span class="s1">&#39;^[^1-9]%d%d%d$&#39;</span><span class="p">,</span>														<span class="c1">-- 4 digits without subcode (0xxx); accepts: 1000–9999</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos" data-line="600"></span></a>		<span class="s1">&#39;^%d%d%d%d%d%d+&#39;</span><span class="p">,</span>														<span class="c1">-- 6 or more digits</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos" data-line="601"></span></a>		<span class="s1">&#39;^%d%d?%d?$&#39;</span><span class="p">,</span>															<span class="c1">-- less than 4 digits without subcode (3 digits with subcode is legitimate)</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos" data-line="602"></span></a>		<span class="s1">&#39;^%d%d?%.[%d%.]+&#39;</span><span class="p">,</span>														<span class="c1">-- 1 or 2 digits with subcode</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos" data-line="603"></span></a>		<span class="s1">&#39;^5555$&#39;</span><span class="p">,</span>																<span class="c1">-- test registrant will never resolve</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos" data-line="604"></span></a>		<span class="s1">&#39;[^%d%.]&#39;</span><span class="p">,</span>																<span class="c1">-- any character that isn&#39;t a digit or a dot</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos" data-line="605"></span></a>		<span class="p">}</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos" data-line="606"></span></a>
</span><span id="L-607"><a href="#L-607"><span class="linenos" data-line="607"></span></a>	<span class="kr">if</span> <span class="ow">not</span> <span class="n">ignore_invalid</span> <span class="kr">then</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos" data-line="608"></span></a>		<span class="kr">if</span> <span class="n">registrant</span> <span class="kr">then</span>														<span class="c1">-- when DOI has proper form</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos" data-line="609"></span></a>			<span class="kr">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pattern</span> <span class="kr">in</span> <span class="nb">ipairs</span> <span class="p">(</span><span class="n">registrant_err_patterns</span><span class="p">)</span> <span class="kr">do</span>				<span class="c1">-- spin through error patterns</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos" data-line="610"></span></a>				<span class="kr">if</span> <span class="n">registrant</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="kr">then</span>								<span class="c1">-- to validate registrant codes</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos" data-line="611"></span></a>					<span class="n">err_flag</span> <span class="o">=</span> <span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_doi&#39;</span><span class="p">);</span>						<span class="c1">-- when found, mark this DOI as bad</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos" data-line="612"></span></a>					<span class="kr">break</span><span class="p">;</span>														<span class="c1">-- and done</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos" data-line="613"></span></a>				<span class="kr">end</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos" data-line="614"></span></a>			<span class="kr">end</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos" data-line="615"></span></a>		<span class="kr">else</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos" data-line="616"></span></a>			<span class="n">err_flag</span> <span class="o">=</span> <span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_doi&#39;</span><span class="p">);</span>								<span class="c1">-- invalid directory or malformed</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos" data-line="617"></span></a>		<span class="kr">end</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos" data-line="618"></span></a>	<span class="kr">else</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos" data-line="619"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;maint_doi_ignore&#39;</span><span class="p">);</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos" data-line="620"></span></a>	<span class="kr">end</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos" data-line="621"></span></a>
</span><span id="L-622"><a href="#L-622"><span class="linenos" data-line="622"></span></a>	<span class="kr">if</span> <span class="n">err_flag</span> <span class="kr">then</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos" data-line="623"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;DOI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>										<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos" data-line="624"></span></a>	<span class="kr">else</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos" data-line="625"></span></a>		<span class="kr">if</span> <span class="ow">not</span> <span class="n">access</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">known_free_doi_registrants_t</span><span class="p">[</span><span class="n">registrant</span><span class="p">]</span> <span class="ow">or</span> <span class="n">is_extended_free</span> <span class="p">(</span><span class="n">registrant</span><span class="p">,</span> <span class="n">suffix</span><span class="p">))</span> <span class="kr">then</span>		<span class="c1">-- |doi-access=free not set and &lt;registrant&gt; is known to be free</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos" data-line="626"></span></a>			<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;maint_doi_unflagged_free&#39;</span><span class="p">);</span>							<span class="c1">-- set a maint cat</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos" data-line="627"></span></a>		<span class="kr">end</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos" data-line="628"></span></a>	<span class="kr">end</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos" data-line="629"></span></a>	
</span><span id="L-630"><a href="#L-630"><span class="linenos" data-line="630"></span></a>	<span class="n">text</span> <span class="o">=</span> <span class="n">external_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos" data-line="631"></span></a>		<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span> <span class="n">encode</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">encode</span><span class="p">,</span> <span class="n">access</span> <span class="o">=</span> <span class="n">access</span><span class="p">,</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos" data-line="632"></span></a>		<span class="n">auto_link</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="n">err_flag</span> <span class="ow">or</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">inactive</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ignore_invalid</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;doi&#39;</span> <span class="ow">or</span> <span class="kc">nil</span> <span class="c1">-- do not auto-link when |doi-broken-date= has a value or when there is a DOI error or (to play it safe, after all, auto-linking is not essential) when invalid DOIs are ignored</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos" data-line="633"></span></a>		<span class="p">})</span> <span class="o">..</span> <span class="p">(</span><span class="n">inactive</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos" data-line="634"></span></a>
</span><span id="L-635"><a href="#L-635"><span class="linenos" data-line="635"></span></a>	<span class="kr">return</span> <span class="n">text</span><span class="p">;</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos" data-line="636"></span></a><span class="kr">end</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos" data-line="637"></span></a>
</span><span id="L-638"><a href="#L-638"><span class="linenos" data-line="638"></span></a>
</span><span id="L-639"><a href="#L-639"><span class="linenos" data-line="639"></span></a><span class="cm">--[[--------------------------&lt; H D L &gt;------------------------------------------------------------------------</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos" data-line="640"></span></a>
</span><span id="L-641"><a href="#L-641"><span class="linenos" data-line="641"></span></a><span class="cm">Formats an HDL with minor error checking.</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos" data-line="642"></span></a>
</span><span id="L-643"><a href="#L-643"><span class="linenos" data-line="643"></span></a><span class="cm">HDL names contain two parts: prefix and suffix separated by a forward slash.</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos" data-line="644"></span></a><span class="cm">	Prefix: character string using any character in the UCS-2 character set except &#39;/&#39;</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos" data-line="645"></span></a><span class="cm">	Suffix: character string of any length using any character in the UCS-2 character set chosen by the registrant</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos" data-line="646"></span></a>
</span><span id="L-647"><a href="#L-647"><span class="linenos" data-line="647"></span></a><span class="cm">This function checks a HDL name for: prefix/suffix.  If the HDL name contains spaces, endashes, or, if it ends</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos" data-line="648"></span></a><span class="cm">with a period or a comma, this function will emit a bad_hdl error message.</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos" data-line="649"></span></a>
</span><span id="L-650"><a href="#L-650"><span class="linenos" data-line="650"></span></a><span class="cm">HDL names are case-insensitive and can incorporate any printable Unicode characters so the test for endashes and</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos" data-line="651"></span></a><span class="cm">terminal punctuation may not be technically correct but it appears, that in practice these characters are rarely</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos" data-line="652"></span></a><span class="cm">if ever used in HDLs.</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos" data-line="653"></span></a>
</span><span id="L-654"><a href="#L-654"><span class="linenos" data-line="654"></span></a><span class="cm">Query string parameters are named here: https://www.handle.net/proxy_servlet.html.  query strings are not displayed</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos" data-line="655"></span></a><span class="cm">but since &#39;?&#39; is an allowed character in an HDL, &#39;?&#39; followed by one of the query parameters is the only way we</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos" data-line="656"></span></a><span class="cm">have to detect the query string so that it isn&#39;t URL-encoded with the rest of the identifier.</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos" data-line="657"></span></a>
</span><span id="L-658"><a href="#L-658"><span class="linenos" data-line="658"></span></a><span class="cm">]]</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos" data-line="659"></span></a>
</span><span id="L-660"><a href="#L-660"><span class="linenos" data-line="660"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">hdl</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos" data-line="661"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos" data-line="662"></span></a>	<span class="kd">local</span> <span class="n">access</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">access</span><span class="p">;</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos" data-line="663"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos" data-line="664"></span></a>	<span class="kd">local</span> <span class="n">query_params</span> <span class="o">=</span> <span class="p">{</span>														<span class="c1">-- list of known query parameters from https://www.handle.net/proxy_servlet.html</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos" data-line="665"></span></a>		<span class="s1">&#39;noredirect&#39;</span><span class="p">,</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos" data-line="666"></span></a>		<span class="s1">&#39;ignore_aliases&#39;</span><span class="p">,</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos" data-line="667"></span></a>		<span class="s1">&#39;auth&#39;</span><span class="p">,</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos" data-line="668"></span></a>		<span class="s1">&#39;cert&#39;</span><span class="p">,</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos" data-line="669"></span></a>		<span class="s1">&#39;index&#39;</span><span class="p">,</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos" data-line="670"></span></a>		<span class="s1">&#39;type&#39;</span><span class="p">,</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos" data-line="671"></span></a>		<span class="s1">&#39;urlappend&#39;</span><span class="p">,</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos" data-line="672"></span></a>		<span class="s1">&#39;locatt&#39;</span><span class="p">,</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos" data-line="673"></span></a>		<span class="s1">&#39;action&#39;</span><span class="p">,</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos" data-line="674"></span></a>		<span class="p">}</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos" data-line="675"></span></a>	
</span><span id="L-676"><a href="#L-676"><span class="linenos" data-line="676"></span></a>	<span class="kd">local</span> <span class="n">hdl</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">param</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s1">&#39;(.-)(%?(%a+).+)$&#39;</span><span class="p">);</span>					<span class="c1">-- look for query string</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos" data-line="677"></span></a>	<span class="kd">local</span> <span class="n">found</span><span class="p">;</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos" data-line="678"></span></a>
</span><span id="L-679"><a href="#L-679"><span class="linenos" data-line="679"></span></a>	<span class="kr">if</span> <span class="n">hdl</span> <span class="kr">then</span>																	<span class="c1">-- when there are query strings, this is the handle identifier portion</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos" data-line="680"></span></a>		<span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">q</span> <span class="kr">in</span> <span class="nb">ipairs</span> <span class="p">(</span><span class="n">query_params</span><span class="p">)</span> <span class="kr">do</span>									<span class="c1">-- spin through the list of query parameters</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos" data-line="681"></span></a>			<span class="kr">if</span> <span class="n">param</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s1">&#39;^&#39;</span> <span class="o">..</span> <span class="n">q</span><span class="p">)</span> <span class="kr">then</span>										<span class="c1">-- if the query string begins with one of the parameters</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos" data-line="682"></span></a>				<span class="n">found</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>													<span class="c1">-- announce a find</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos" data-line="683"></span></a>				<span class="kr">break</span><span class="p">;</span>															<span class="c1">-- and stop looking</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos" data-line="684"></span></a>			<span class="kr">end</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos" data-line="685"></span></a>		<span class="kr">end</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos" data-line="686"></span></a>	<span class="kr">end</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos" data-line="687"></span></a>
</span><span id="L-688"><a href="#L-688"><span class="linenos" data-line="688"></span></a>	<span class="kr">if</span> <span class="n">found</span> <span class="kr">then</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos" data-line="689"></span></a>		<span class="n">id</span> <span class="o">=</span> <span class="n">hdl</span><span class="p">;</span>																<span class="c1">-- found so replace id with the handle portion; this will be URL-encoded, suffix will not</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos" data-line="690"></span></a>	<span class="kr">else</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos" data-line="691"></span></a>		<span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>															<span class="c1">-- make sure suffix is empty string for concatenation else</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos" data-line="692"></span></a>	<span class="kr">end</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos" data-line="693"></span></a>
</span><span id="L-694"><a href="#L-694"><span class="linenos" data-line="694"></span></a>	<span class="kd">local</span> <span class="n">text</span> <span class="o">=</span> <span class="n">external_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos" data-line="695"></span></a>			<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span> <span class="n">encode</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">encode</span><span class="p">,</span> <span class="n">access</span> <span class="o">=</span> <span class="n">access</span><span class="p">})</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos" data-line="696"></span></a>
</span><span id="L-697"><a href="#L-697"><span class="linenos" data-line="697"></span></a>	<span class="kr">if</span> <span class="kc">nil</span> <span class="o">==</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^[^%s–]-/[^%s–]-[^%.,]$&quot;</span><span class="p">)</span> <span class="kr">then</span>							<span class="c1">-- HDL must contain a forward slash, must not contain spaces, endashes, and must not end with period or comma</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos" data-line="698"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_hdl&#39;</span> <span class="p">);</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos" data-line="699"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;HDL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>										<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos" data-line="700"></span></a>	<span class="kr">end</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos" data-line="701"></span></a>
</span><span id="L-702"><a href="#L-702"><span class="linenos" data-line="702"></span></a>	<span class="kr">return</span> <span class="n">text</span><span class="p">;</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos" data-line="703"></span></a><span class="kr">end</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos" data-line="704"></span></a>
</span><span id="L-705"><a href="#L-705"><span class="linenos" data-line="705"></span></a>
</span><span id="L-706"><a href="#L-706"><span class="linenos" data-line="706"></span></a><span class="cm">--[[--------------------------&lt; I S B N &gt;----------------------------------------------------------------------</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos" data-line="707"></span></a>
</span><span id="L-708"><a href="#L-708"><span class="linenos" data-line="708"></span></a><span class="cm">Determines whether an ISBN string is valid</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos" data-line="709"></span></a>
</span><span id="L-710"><a href="#L-710"><span class="linenos" data-line="710"></span></a><span class="cm">]]</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos" data-line="711"></span></a>
</span><span id="L-712"><a href="#L-712"><span class="linenos" data-line="712"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">isbn</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos" data-line="713"></span></a>	<span class="kd">local</span> <span class="n">isbn_str</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos" data-line="714"></span></a>	<span class="kd">local</span> <span class="n">ignore_invalid</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">accept</span><span class="p">;</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos" data-line="715"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos" data-line="716"></span></a>
</span><span id="L-717"><a href="#L-717"><span class="linenos" data-line="717"></span></a>	<span class="kd">local</span> <span class="kr">function</span> <span class="nf">return_result</span> <span class="p">(</span><span class="n">check</span><span class="p">,</span> <span class="n">err_type</span><span class="p">)</span>								<span class="c1">-- local function to handle the various returns</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos" data-line="718"></span></a>		<span class="kd">local</span> <span class="n">ISBN</span> <span class="o">=</span> <span class="n">internal_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos" data-line="719"></span></a>						<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">isbn_str</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">});</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos" data-line="720"></span></a>		<span class="kr">if</span> <span class="n">ignore_invalid</span> <span class="kr">then</span>													<span class="c1">-- if ignoring ISBN errors</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos" data-line="721"></span></a>			<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;maint_isbn_ignore&#39;</span><span class="p">);</span>									<span class="c1">-- add a maint category even when there is no error</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos" data-line="722"></span></a>		<span class="kr">else</span>																	<span class="c1">-- here when not ignoring</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos" data-line="723"></span></a>			<span class="kr">if</span> <span class="ow">not</span> <span class="n">check</span> <span class="kr">then</span>													<span class="c1">-- and there is an error</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos" data-line="724"></span></a>				<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;ISBN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>								<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos" data-line="725"></span></a>				<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_isbn&#39;</span><span class="p">,</span> <span class="n">err_type</span><span class="p">);</span>							<span class="c1">-- set an error message</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos" data-line="726"></span></a>				<span class="kr">return</span> <span class="n">ISBN</span><span class="p">;</span>										 			<span class="c1">-- return id text</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos" data-line="727"></span></a>			<span class="kr">end</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos" data-line="728"></span></a>		<span class="kr">end</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos" data-line="729"></span></a>		<span class="kr">return</span> <span class="n">ISBN</span><span class="p">;</span>															<span class="c1">-- return id text</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos" data-line="730"></span></a>	<span class="kr">end</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos" data-line="731"></span></a>
</span><span id="L-732"><a href="#L-732"><span class="linenos" data-line="732"></span></a>	<span class="kr">if</span> <span class="kc">nil</span> <span class="o">~=</span> <span class="n">isbn_str</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s1">&#39;[^%s-0-9X]&#39;</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos" data-line="733"></span></a>		<span class="kr">return</span> <span class="n">return_result</span> <span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">err_msg_supl</span><span class="p">.</span><span class="n">char</span><span class="p">);</span>					<span class="c1">-- fail if isbn_str contains anything but digits, hyphens, or the uppercase X</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos" data-line="734"></span></a>	<span class="kr">end</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos" data-line="735"></span></a>
</span><span id="L-736"><a href="#L-736"><span class="linenos" data-line="736"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">isbn_str</span><span class="p">:</span><span class="n">gsub</span> <span class="p">(</span><span class="s1">&#39;[%s-]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>										<span class="c1">-- remove hyphens and whitespace</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos" data-line="737"></span></a>
</span><span id="L-738"><a href="#L-738"><span class="linenos" data-line="738"></span></a>	<span class="kd">local</span> <span class="n">len</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">len</span><span class="p">();</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos" data-line="739"></span></a> 
</span><span id="L-740"><a href="#L-740"><span class="linenos" data-line="740"></span></a>	<span class="kr">if</span> <span class="n">len</span> <span class="o">~=</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">len</span> <span class="o">~=</span> <span class="mi">13</span> <span class="kr">then</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos" data-line="741"></span></a>		<span class="kr">return</span> <span class="n">return_result</span> <span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">err_msg_supl</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>					<span class="c1">-- fail if incorrect length</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos" data-line="742"></span></a>	<span class="kr">end</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos" data-line="743"></span></a>
</span><span id="L-744"><a href="#L-744"><span class="linenos" data-line="744"></span></a>	<span class="kr">if</span> <span class="n">len</span> <span class="o">==</span> <span class="mi">10</span> <span class="kr">then</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos" data-line="745"></span></a>		<span class="kr">if</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s1">&#39;^%d*X?$&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">nil</span> <span class="kr">then</span>										<span class="c1">-- fail if isbn_str has &#39;X&#39; anywhere but last position</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos" data-line="746"></span></a>			<span class="kr">return</span> <span class="n">return_result</span> <span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">err_msg_supl</span><span class="p">.</span><span class="n">form</span><span class="p">);</span>									
</span><span id="L-747"><a href="#L-747"><span class="linenos" data-line="747"></span></a>		<span class="kr">end</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos" data-line="748"></span></a>		<span class="kr">if</span> <span class="ow">not</span> <span class="n">is_valid_isxn</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="kr">then</span>										<span class="c1">-- test isbn-10 for numerical validity</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos" data-line="749"></span></a>			<span class="kr">return</span> <span class="n">return_result</span> <span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">err_msg_supl</span><span class="p">.</span><span class="n">check</span><span class="p">);</span>				<span class="c1">-- fail if isbn-10 is not numerically valid</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos" data-line="750"></span></a>		<span class="kr">end</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos" data-line="751"></span></a>		<span class="kr">if</span> <span class="n">id</span><span class="p">:</span><span class="n">find</span> <span class="p">(</span><span class="s1">&#39;^63[01]&#39;</span><span class="p">)</span> <span class="kr">then</span>												<span class="c1">-- 630xxxxxxx and 631xxxxxxx are (apparently) not valid isbn group ids but are used by amazon as numeric identifiers (asin)</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos" data-line="752"></span></a>			<span class="kr">return</span> <span class="n">return_result</span> <span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">err_msg_supl</span><span class="p">.</span><span class="n">group</span><span class="p">);</span>				<span class="c1">-- fail if isbn-10 begins with 630/1</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos" data-line="753"></span></a>		<span class="kr">end</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos" data-line="754"></span></a>		<span class="kr">return</span> <span class="n">return_result</span> <span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">err_msg_supl</span><span class="p">.</span><span class="n">check</span><span class="p">);</span>					<span class="c1">-- pass if isbn-10 is numerically valid</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos" data-line="755"></span></a>	<span class="kr">else</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos" data-line="756"></span></a>		<span class="kr">if</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s1">&#39;^%d+$&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">nil</span> <span class="kr">then</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos" data-line="757"></span></a>			<span class="kr">return</span> <span class="n">return_result</span> <span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">err_msg_supl</span><span class="p">.</span><span class="n">char</span><span class="p">);</span>				<span class="c1">-- fail if ISBN-13 is not all digits</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos" data-line="758"></span></a>		<span class="kr">end</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos" data-line="759"></span></a>		<span class="kr">if</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s1">&#39;^97[89]%d*$&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">nil</span> <span class="kr">then</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos" data-line="760"></span></a>			<span class="kr">return</span> <span class="n">return_result</span> <span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">err_msg_supl</span><span class="p">.</span><span class="n">prefix</span><span class="p">);</span>				<span class="c1">-- fail when ISBN-13 does not begin with 978 or 979</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos" data-line="761"></span></a>		<span class="kr">end</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos" data-line="762"></span></a>		<span class="kr">if</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s1">&#39;^9790&#39;</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos" data-line="763"></span></a>			<span class="kr">return</span> <span class="n">return_result</span> <span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">err_msg_supl</span><span class="p">.</span><span class="n">group</span><span class="p">);</span>				<span class="c1">-- group identifier &#39;0&#39; is reserved to ISMN</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos" data-line="764"></span></a>		<span class="kr">end</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos" data-line="765"></span></a>		<span class="kr">return</span> <span class="n">return_result</span> <span class="p">(</span><span class="n">is_valid_isxn_13</span> <span class="p">(</span><span class="n">id</span><span class="p">),</span> <span class="n">cfg</span><span class="p">.</span><span class="n">err_msg_supl</span><span class="p">.</span><span class="n">check</span><span class="p">);</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos" data-line="766"></span></a>	<span class="kr">end</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos" data-line="767"></span></a><span class="kr">end</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos" data-line="768"></span></a>
</span><span id="L-769"><a href="#L-769"><span class="linenos" data-line="769"></span></a>
</span><span id="L-770"><a href="#L-770"><span class="linenos" data-line="770"></span></a><span class="cm">--[[--------------------------&lt; A S I N &gt;----------------------------------------------------------------------</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos" data-line="771"></span></a>
</span><span id="L-772"><a href="#L-772"><span class="linenos" data-line="772"></span></a><span class="cm">Formats a link to Amazon.  Do simple error checking: ASIN must be mix of 10 numeric or uppercase alpha</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos" data-line="773"></span></a><span class="cm">characters.  If a mix, first character must be uppercase alpha; if all numeric, ASINs must be 10-digit</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos" data-line="774"></span></a><span class="cm">ISBN. If 10-digit ISBN, add a maintenance category so a bot or AWB script can replace |asin= with |isbn=.</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos" data-line="775"></span></a><span class="cm">Error message if not 10 characters, if not ISBN-10, if mixed and first character is a digit.</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos" data-line="776"></span></a>
</span><span id="L-777"><a href="#L-777"><span class="linenos" data-line="777"></span></a><span class="cm">|asin=630....... and |asin=631....... are (apparently) not a legitimate ISBN though it checksums as one; these</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos" data-line="778"></span></a><span class="cm">do not cause this function to emit the maint_asin message</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos" data-line="779"></span></a>
</span><span id="L-780"><a href="#L-780"><span class="linenos" data-line="780"></span></a><span class="cm">This function is positioned here because it calls isbn()</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos" data-line="781"></span></a>
</span><span id="L-782"><a href="#L-782"><span class="linenos" data-line="782"></span></a><span class="cm">]]</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos" data-line="783"></span></a>
</span><span id="L-784"><a href="#L-784"><span class="linenos" data-line="784"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">asin</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos" data-line="785"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos" data-line="786"></span></a>	<span class="kd">local</span> <span class="n">domain</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">ASINTLD</span><span class="p">;</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos" data-line="787"></span></a>	
</span><span id="L-788"><a href="#L-788"><span class="linenos" data-line="788"></span></a>	<span class="kd">local</span> <span class="n">err_flag</span><span class="p">;</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos" data-line="789"></span></a>
</span><span id="L-790"><a href="#L-790"><span class="linenos" data-line="790"></span></a>	<span class="kr">if</span> <span class="ow">not</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^[%d%u][%d%u][%d%u][%d%u][%d%u][%d%u][%d%u][%d%u][%d%u][%d%u]$&quot;</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos" data-line="791"></span></a>		<span class="n">err_flag</span> <span class="o">=</span> <span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_asin&#39;</span><span class="p">);</span>								<span class="c1">-- ASIN is not a mix of 10 uppercase alpha and numeric characters</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos" data-line="792"></span></a>	<span class="kr">else</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos" data-line="793"></span></a>		<span class="kr">if</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^%d%d%d%d%d%d%d%d%d[%dX]$&quot;</span><span class="p">)</span> <span class="kr">then</span>							<span class="c1">-- if 10-digit numeric (or 9 digits with terminal X)</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos" data-line="794"></span></a>			<span class="kr">if</span> <span class="n">is_valid_isxn</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="kr">then</span>										<span class="c1">-- see if ASIN value is or validates as ISBN-10</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos" data-line="795"></span></a>				<span class="kr">if</span> <span class="ow">not</span> <span class="n">id</span><span class="p">:</span><span class="n">find</span> <span class="p">(</span><span class="s1">&#39;^63[01]&#39;</span><span class="p">)</span> <span class="kr">then</span>									<span class="c1">-- 630xxxxxxx and 631xxxxxxx are (apparently) not a valid isbn prefixes but are used by amazon as a numeric identifier</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos" data-line="796"></span></a>					<span class="n">err_flag</span> <span class="o">=</span> <span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_asin&#39;</span><span class="p">);</span>					<span class="c1">-- ASIN has ISBN-10 form but begins with something other than 630/1 so probably an isbn </span>
</span><span id="L-797"><a href="#L-797"><span class="linenos" data-line="797"></span></a>				<span class="kr">end</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos" data-line="798"></span></a>			<span class="kr">elseif</span> <span class="ow">not</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">err_flag</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos" data-line="799"></span></a>				<span class="n">err_flag</span> <span class="o">=</span> <span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_asin&#39;</span><span class="p">);</span>						<span class="c1">-- ASIN is not ISBN-10</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos" data-line="800"></span></a>			<span class="kr">end</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos" data-line="801"></span></a>		<span class="kr">elseif</span> <span class="ow">not</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^%u[%d%u]+$&quot;</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos" data-line="802"></span></a>			<span class="n">err_flag</span> <span class="o">=</span> <span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_asin&#39;</span><span class="p">);</span>							<span class="c1">-- asin doesn&#39;t begin with uppercase alpha</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos" data-line="803"></span></a>		<span class="kr">end</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos" data-line="804"></span></a>	<span class="kr">end</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos" data-line="805"></span></a>	<span class="kr">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">domain</span><span class="p">))</span> <span class="ow">or</span> <span class="n">in_array</span> <span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;us&#39;</span><span class="p">})</span> <span class="kr">then</span>					<span class="c1">-- default: United States</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos" data-line="806"></span></a>		<span class="n">domain</span> <span class="o">=</span> <span class="s2">&quot;com&quot;</span><span class="p">;</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos" data-line="807"></span></a>	<span class="kr">elseif</span> <span class="n">in_array</span> <span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;jp&#39;</span><span class="p">,</span> <span class="s1">&#39;uk&#39;</span><span class="p">})</span> <span class="kr">then</span>									<span class="c1">-- Japan, United Kingdom</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos" data-line="808"></span></a>		<span class="n">domain</span> <span class="o">=</span> <span class="s2">&quot;co.&quot;</span> <span class="o">..</span> <span class="n">domain</span><span class="p">;</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos" data-line="809"></span></a>	<span class="kr">elseif</span> <span class="n">in_array</span> <span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;z.cn&#39;</span><span class="p">})</span> <span class="kr">then</span> 									<span class="c1">-- China</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos" data-line="810"></span></a>		<span class="n">domain</span> <span class="o">=</span> <span class="s2">&quot;cn&quot;</span><span class="p">;</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos" data-line="811"></span></a>	<span class="kr">elseif</span> <span class="n">in_array</span> <span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;au&#39;</span><span class="p">,</span> <span class="s1">&#39;br&#39;</span><span class="p">,</span> <span class="s1">&#39;mx&#39;</span><span class="p">,</span> <span class="s1">&#39;sg&#39;</span><span class="p">,</span> <span class="s1">&#39;tr&#39;</span><span class="p">})</span> <span class="kr">then</span>				<span class="c1">-- Australia, Brazil, Mexico, Singapore, Turkey</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos" data-line="812"></span></a>		<span class="n">domain</span> <span class="o">=</span> <span class="s2">&quot;com.&quot;</span> <span class="o">..</span> <span class="n">domain</span><span class="p">;</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos" data-line="813"></span></a>	<span class="kr">elseif</span> <span class="ow">not</span> <span class="n">in_array</span> <span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;ae&#39;</span><span class="p">,</span> <span class="s1">&#39;ca&#39;</span><span class="p">,</span> <span class="s1">&#39;cn&#39;</span><span class="p">,</span> <span class="s1">&#39;de&#39;</span><span class="p">,</span> <span class="s1">&#39;es&#39;</span><span class="p">,</span> <span class="s1">&#39;fr&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;it&#39;</span><span class="p">,</span> <span class="s1">&#39;nl&#39;</span><span class="p">,</span> <span class="s1">&#39;pl&#39;</span><span class="p">,</span> <span class="s1">&#39;sa&#39;</span><span class="p">,</span> <span class="s1">&#39;se&#39;</span><span class="p">,</span> <span class="s1">&#39;co.jp&#39;</span><span class="p">,</span> <span class="s1">&#39;co.uk&#39;</span><span class="p">,</span> <span class="s1">&#39;com&#39;</span><span class="p">,</span> <span class="s1">&#39;com.au&#39;</span><span class="p">,</span> <span class="s1">&#39;com.br&#39;</span><span class="p">,</span> <span class="s1">&#39;com.mx&#39;</span><span class="p">,</span> <span class="s1">&#39;com.sg&#39;</span><span class="p">,</span> <span class="s1">&#39;com.tr&#39;</span><span class="p">})</span> <span class="kr">then</span> <span class="c1">-- Arabic Emirates, Canada, China, Germany, Spain, France, Indonesia, Italy, Netherlands, Poland, Saudi Arabia, Sweden (as of 2021-03 Austria (.at), Liechtenstein (.li) and Switzerland (.ch) still redirect to the German site (.de) with special settings, so don&#39;t maintain local ASINs for them)</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos" data-line="814"></span></a>		<span class="n">err_flag</span> <span class="o">=</span> <span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_asin_tld&#39;</span><span class="p">);</span>							<span class="c1">-- unsupported asin-tld value</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos" data-line="815"></span></a>	<span class="kr">end</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos" data-line="816"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos" data-line="817"></span></a>
</span><span id="L-818"><a href="#L-818"><span class="linenos" data-line="818"></span></a>	<span class="kr">if</span> <span class="ow">not</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">err_flag</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos" data-line="819"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;ASIN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span> <span class="o">..</span> <span class="n">domain</span> <span class="o">..</span> <span class="s2">&quot;/dp/&quot;</span> <span class="o">..</span> <span class="n">id</span><span class="p">;</span>	<span class="c1">-- asin for coins</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos" data-line="820"></span></a>	<span class="kr">else</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos" data-line="821"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;ASIN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>										<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos" data-line="822"></span></a>	<span class="kr">end</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos" data-line="823"></span></a>	
</span><span id="L-824"><a href="#L-824"><span class="linenos" data-line="824"></span></a>	<span class="kr">return</span> <span class="n">external_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos" data-line="825"></span></a>		<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span> <span class="o">..</span> <span class="n">domain</span> <span class="o">..</span> <span class="s2">&quot;/dp/&quot;</span><span class="p">,</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos" data-line="826"></span></a>		<span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span> <span class="n">encode</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">encode</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">})</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos" data-line="827"></span></a><span class="kr">end</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos" data-line="828"></span></a>
</span><span id="L-829"><a href="#L-829"><span class="linenos" data-line="829"></span></a>
</span><span id="L-830"><a href="#L-830"><span class="linenos" data-line="830"></span></a><span class="cm">--[[--------------------------&lt; I S M N &gt;----------------------------------------------------------------------</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos" data-line="831"></span></a>
</span><span id="L-832"><a href="#L-832"><span class="linenos" data-line="832"></span></a><span class="cm">Determines whether an ISMN string is valid.  Similar to ISBN-13, ISMN is 13 digits beginning 979-0-... and uses the</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos" data-line="833"></span></a><span class="cm">same check digit calculations.  See https://www.ismn-international.org/download/Web_ISMN_Users_Manual_2008-6.pdf</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos" data-line="834"></span></a><span class="cm">section 2, pages 9–12.</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos" data-line="835"></span></a>
</span><span id="L-836"><a href="#L-836"><span class="linenos" data-line="836"></span></a><span class="cm">ismn value not made part of COinS metadata because we don&#39;t have a url or isn&#39;t a COinS-defined identifier (rft.xxx)</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos" data-line="837"></span></a><span class="cm">or an identifier registered at info-uri.info (info:)</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos" data-line="838"></span></a>
</span><span id="L-839"><a href="#L-839"><span class="linenos" data-line="839"></span></a><span class="cm">]]</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos" data-line="840"></span></a>
</span><span id="L-841"><a href="#L-841"><span class="linenos" data-line="841"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">ismn</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos" data-line="842"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos" data-line="843"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos" data-line="844"></span></a>	<span class="kd">local</span> <span class="n">text</span><span class="p">;</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos" data-line="845"></span></a>	<span class="kd">local</span> <span class="n">valid_ismn</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos" data-line="846"></span></a>	<span class="kd">local</span> <span class="n">id_copy</span><span class="p">;</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos" data-line="847"></span></a>
</span><span id="L-848"><a href="#L-848"><span class="linenos" data-line="848"></span></a>	<span class="n">id_copy</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>																<span class="c1">-- save a copy because this testing is destructive</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos" data-line="849"></span></a>	<span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">gsub</span> <span class="p">(</span><span class="s1">&#39;[%s-]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>													<span class="c1">-- remove hyphens and white space</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos" data-line="850"></span></a>
</span><span id="L-851"><a href="#L-851"><span class="linenos" data-line="851"></span></a>	<span class="kr">if</span> <span class="mi">13</span> <span class="o">~=</span> <span class="n">id</span><span class="p">:</span><span class="n">len</span><span class="p">()</span> <span class="ow">or</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s2">&quot;^9790%d*$&quot;</span> <span class="p">)</span> <span class="o">==</span> <span class="kc">nil</span> <span class="kr">then</span>					<span class="c1">-- ISMN must be 13 digits and begin with 9790</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos" data-line="852"></span></a>		<span class="n">valid_ismn</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos" data-line="853"></span></a>	<span class="kr">else</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos" data-line="854"></span></a>		<span class="n">valid_ismn</span><span class="o">=</span><span class="n">is_valid_isxn_13</span> <span class="p">(</span><span class="n">id</span><span class="p">);</span>										<span class="c1">-- validate ISMN</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos" data-line="855"></span></a>	<span class="kr">end</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos" data-line="856"></span></a>
</span><span id="L-857"><a href="#L-857"><span class="linenos" data-line="857"></span></a>	<span class="c1">--	text = internal_link_id ({link = handler.link, label = handler.label, q = handler.q, redirect = handler.redirect,		-- use this (or external version) when there is some place to link to</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos" data-line="858"></span></a>	<span class="c1">--		prefix = handler.prefix, id = id_copy, separator = handler.separator, encode = handler.encode})</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos" data-line="859"></span></a>
</span><span id="L-860"><a href="#L-860"><span class="linenos" data-line="860"></span></a>	<span class="n">text</span> <span class="o">=</span> <span class="nb">table.concat</span> <span class="p">(</span>														<span class="c1">-- because no place to link to yet</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos" data-line="861"></span></a>		<span class="p">{</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos" data-line="862"></span></a>		<span class="n">make_wikilink</span> <span class="p">(</span><span class="n">link_label_make</span> <span class="p">(</span><span class="n">handler</span><span class="p">),</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">),</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos" data-line="863"></span></a>		<span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos" data-line="864"></span></a>		<span class="n">id_copy</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos" data-line="865"></span></a>		<span class="p">});</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos" data-line="866"></span></a>
</span><span id="L-867"><a href="#L-867"><span class="linenos" data-line="867"></span></a>	<span class="kr">if</span> <span class="kc">false</span> <span class="o">==</span> <span class="n">valid_ismn</span> <span class="kr">then</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos" data-line="868"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;ISMN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>										<span class="c1">-- when error, unset so not included in COinS; not really necessary here because ismn not made part of COinS</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos" data-line="869"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_ismn&#39;</span><span class="p">);</span>											<span class="c1">-- create an error message if the ISMN is invalid</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos" data-line="870"></span></a>	<span class="kr">end</span> 
</span><span id="L-871"><a href="#L-871"><span class="linenos" data-line="871"></span></a>	
</span><span id="L-872"><a href="#L-872"><span class="linenos" data-line="872"></span></a>	<span class="kr">return</span> <span class="n">text</span><span class="p">;</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos" data-line="873"></span></a><span class="kr">end</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos" data-line="874"></span></a>
</span><span id="L-875"><a href="#L-875"><span class="linenos" data-line="875"></span></a>
</span><span id="L-876"><a href="#L-876"><span class="linenos" data-line="876"></span></a><span class="cm">--[[--------------------------&lt; I S S N &gt;----------------------------------------------------------------------</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos" data-line="877"></span></a>
</span><span id="L-878"><a href="#L-878"><span class="linenos" data-line="878"></span></a><span class="cm">Validate and format an ISSN.  This code fixes the case where an editor has included an ISSN in the citation but</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos" data-line="879"></span></a><span class="cm">has separated the two groups of four digits with a space.  When that condition occurred, the resulting link looked</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos" data-line="880"></span></a><span class="cm">like this:</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos" data-line="881"></span></a>
</span><span id="L-882"><a href="#L-882"><span class="linenos" data-line="882"></span></a><span class="cm">	|issn=0819 4327 gives: [https://www.worldcat.org/issn/0819 4327 0819 4327]	-- can&#39;t have spaces in an external link</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos" data-line="883"></span></a><span class="cm">	</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos" data-line="884"></span></a><span class="cm">This code now prevents that by inserting a hyphen at the ISSN midpoint.  It also validates the ISSN for length</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos" data-line="885"></span></a><span class="cm">and makes sure that the checkdigit agrees with the calculated value.  Incorrect length (8 digits), characters</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos" data-line="886"></span></a><span class="cm">other than 0-9 and X, or checkdigit / calculated value mismatch will all cause a check ISSN error message.  The</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos" data-line="887"></span></a><span class="cm">ISSN is always displayed with a hyphen, even if the ISSN was given as a single group of 8 digits.</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos" data-line="888"></span></a>
</span><span id="L-889"><a href="#L-889"><span class="linenos" data-line="889"></span></a><span class="cm">]]</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos" data-line="890"></span></a>
</span><span id="L-891"><a href="#L-891"><span class="linenos" data-line="891"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">issn</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos" data-line="892"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos" data-line="893"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos" data-line="894"></span></a>	<span class="kd">local</span> <span class="n">ignore_invalid</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">accept</span><span class="p">;</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos" data-line="895"></span></a>
</span><span id="L-896"><a href="#L-896"><span class="linenos" data-line="896"></span></a>	<span class="kd">local</span> <span class="n">issn_copy</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>														<span class="c1">-- save a copy of unadulterated ISSN; use this version for display if ISSN does not validate</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos" data-line="897"></span></a>	<span class="kd">local</span> <span class="n">text</span><span class="p">;</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos" data-line="898"></span></a>	<span class="kd">local</span> <span class="n">valid_issn</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos" data-line="899"></span></a>
</span><span id="L-900"><a href="#L-900"><span class="linenos" data-line="900"></span></a>	<span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">gsub</span> <span class="p">(</span><span class="s1">&#39;[%s-]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>													<span class="c1">-- remove hyphens and whitespace</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos" data-line="901"></span></a>
</span><span id="L-902"><a href="#L-902"><span class="linenos" data-line="902"></span></a>	<span class="kr">if</span> <span class="mi">8</span> <span class="o">~=</span> <span class="n">id</span><span class="p">:</span><span class="n">len</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">nil</span> <span class="o">==</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s2">&quot;^%d*X?$&quot;</span> <span class="p">)</span> <span class="kr">then</span>						<span class="c1">-- validate the ISSN: 8 digits long, containing only 0-9 or X in the last position</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos" data-line="903"></span></a>		<span class="n">valid_issn</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>														<span class="c1">-- wrong length or improper character</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos" data-line="904"></span></a>	<span class="kr">else</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos" data-line="905"></span></a>		<span class="n">valid_issn</span> <span class="o">=</span> <span class="n">is_valid_isxn</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>										<span class="c1">-- validate ISSN</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos" data-line="906"></span></a>	<span class="kr">end</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos" data-line="907"></span></a>
</span><span id="L-908"><a href="#L-908"><span class="linenos" data-line="908"></span></a>	<span class="kr">if</span> <span class="kc">true</span> <span class="o">==</span> <span class="n">valid_issn</span> <span class="kr">then</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos" data-line="909"></span></a>		<span class="n">id</span> <span class="o">=</span> <span class="nb">string.sub</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span> <span class="p">)</span> <span class="o">..</span> <span class="s2">&quot;-&quot;</span> <span class="o">..</span> <span class="nb">string.sub</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="mi">5</span> <span class="p">);</span>				<span class="c1">-- if valid, display correctly formatted version</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos" data-line="910"></span></a>	<span class="kr">else</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos" data-line="911"></span></a>		<span class="n">id</span> <span class="o">=</span> <span class="n">issn_copy</span><span class="p">;</span>															<span class="c1">-- if not valid, show the invalid ISSN with error message</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos" data-line="912"></span></a>	<span class="kr">end</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos" data-line="913"></span></a>
</span><span id="L-914"><a href="#L-914"><span class="linenos" data-line="914"></span></a>	<span class="n">text</span> <span class="o">=</span> <span class="n">external_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos" data-line="915"></span></a>		<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span> <span class="n">encode</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">encode</span><span class="p">})</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos" data-line="916"></span></a>
</span><span id="L-917"><a href="#L-917"><span class="linenos" data-line="917"></span></a>	<span class="kr">if</span> <span class="n">ignore_invalid</span> <span class="kr">then</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos" data-line="918"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;maint_issn_ignore&#39;</span><span class="p">);</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos" data-line="919"></span></a>	<span class="kr">else</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos" data-line="920"></span></a>		<span class="kr">if</span> <span class="kc">false</span> <span class="o">==</span> <span class="n">valid_issn</span> <span class="kr">then</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos" data-line="921"></span></a>			<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;ISSN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>									<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos" data-line="922"></span></a>			<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_issn&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">hkey</span> <span class="o">==</span> <span class="s1">&#39;EISSN&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;e&#39;</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>	<span class="c1">-- create an error message if the ISSN is invalid</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos" data-line="923"></span></a>		<span class="kr">end</span> 
</span><span id="L-924"><a href="#L-924"><span class="linenos" data-line="924"></span></a>	<span class="kr">end</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos" data-line="925"></span></a>	
</span><span id="L-926"><a href="#L-926"><span class="linenos" data-line="926"></span></a>	<span class="kr">return</span> <span class="n">text</span><span class="p">;</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos" data-line="927"></span></a><span class="kr">end</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos" data-line="928"></span></a>
</span><span id="L-929"><a href="#L-929"><span class="linenos" data-line="929"></span></a>
</span><span id="L-930"><a href="#L-930"><span class="linenos" data-line="930"></span></a><span class="cm">--[[--------------------------&lt; J F M &gt;-----------------------------------------------------------------------</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos" data-line="931"></span></a>
</span><span id="L-932"><a href="#L-932"><span class="linenos" data-line="932"></span></a><span class="cm">A numerical identifier in the form nn.nnnn.nn</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos" data-line="933"></span></a>
</span><span id="L-934"><a href="#L-934"><span class="linenos" data-line="934"></span></a><span class="cm">]]</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos" data-line="935"></span></a>
</span><span id="L-936"><a href="#L-936"><span class="linenos" data-line="936"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">jfm</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos" data-line="937"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos" data-line="938"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos" data-line="939"></span></a>	<span class="kd">local</span> <span class="n">id_num</span><span class="p">;</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos" data-line="940"></span></a>
</span><span id="L-941"><a href="#L-941"><span class="linenos" data-line="941"></span></a>	<span class="n">id_num</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s1">&#39;^[Jj][Ff][Mm](.*)$&#39;</span><span class="p">);</span>									<span class="c1">-- identifier with jfm prefix; extract identifier</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos" data-line="942"></span></a>
</span><span id="L-943"><a href="#L-943"><span class="linenos" data-line="943"></span></a>	<span class="kr">if</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">id_num</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos" data-line="944"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;maint_jfm_format&#39;</span><span class="p">);</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos" data-line="945"></span></a>	<span class="kr">else</span>																		<span class="c1">-- plain number without JFM prefix</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos" data-line="946"></span></a>		<span class="n">id_num</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>															<span class="c1">-- if here id does not have prefix</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos" data-line="947"></span></a>	<span class="kr">end</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos" data-line="948"></span></a>
</span><span id="L-949"><a href="#L-949"><span class="linenos" data-line="949"></span></a>	<span class="kr">if</span> <span class="n">id_num</span> <span class="ow">and</span> <span class="n">id_num</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;^%d%d%.%d%d%d%d%.%d%d$&#39;</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos" data-line="950"></span></a>		<span class="n">id</span> <span class="o">=</span> <span class="n">id_num</span><span class="p">;</span>															<span class="c1">-- jfm matches pattern</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos" data-line="951"></span></a>	<span class="kr">else</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos" data-line="952"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_jfm&#39;</span> <span class="p">);</span>											<span class="c1">-- set an error message</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos" data-line="953"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;JFM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>										<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos" data-line="954"></span></a>	<span class="kr">end</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos" data-line="955"></span></a>	
</span><span id="L-956"><a href="#L-956"><span class="linenos" data-line="956"></span></a>	<span class="kr">return</span> <span class="n">external_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos" data-line="957"></span></a>			<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span> <span class="n">encode</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">encode</span><span class="p">});</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos" data-line="958"></span></a><span class="kr">end</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos" data-line="959"></span></a>
</span><span id="L-960"><a href="#L-960"><span class="linenos" data-line="960"></span></a>
</span><span id="L-961"><a href="#L-961"><span class="linenos" data-line="961"></span></a><span class="cm">--[[--------------------------&lt; J S T O R &gt;--------------------------------------------------------------------</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos" data-line="962"></span></a>
</span><span id="L-963"><a href="#L-963"><span class="linenos" data-line="963"></span></a><span class="cm">Format a JSTOR with some error checking</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos" data-line="964"></span></a>
</span><span id="L-965"><a href="#L-965"><span class="linenos" data-line="965"></span></a><span class="cm">]]</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos" data-line="966"></span></a>
</span><span id="L-967"><a href="#L-967"><span class="linenos" data-line="967"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">jstor</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos" data-line="968"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos" data-line="969"></span></a>	<span class="kd">local</span> <span class="n">access</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">access</span><span class="p">;</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos" data-line="970"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos" data-line="971"></span></a>
</span><span id="L-972"><a href="#L-972"><span class="linenos" data-line="972"></span></a>	<span class="kr">if</span> <span class="n">id</span><span class="p">:</span><span class="n">find</span> <span class="p">(</span><span class="s1">&#39;[Jj][Ss][Tt][Oo][Rr]&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">id</span><span class="p">:</span><span class="n">find</span> <span class="p">(</span><span class="s1">&#39;^https?://&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">id</span><span class="p">:</span><span class="n">find</span> <span class="p">(</span><span class="s1">&#39;%s&#39;</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos" data-line="973"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_jstor&#39;</span><span class="p">);</span>											<span class="c1">-- set an error message</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos" data-line="974"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;JSTOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>									<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos" data-line="975"></span></a>	<span class="kr">end</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos" data-line="976"></span></a>	
</span><span id="L-977"><a href="#L-977"><span class="linenos" data-line="977"></span></a>	<span class="kr">return</span> <span class="n">external_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos" data-line="978"></span></a>		<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span> <span class="n">encode</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">encode</span><span class="p">,</span> <span class="n">access</span> <span class="o">=</span> <span class="n">access</span><span class="p">});</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos" data-line="979"></span></a><span class="kr">end</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos" data-line="980"></span></a>
</span><span id="L-981"><a href="#L-981"><span class="linenos" data-line="981"></span></a>
</span><span id="L-982"><a href="#L-982"><span class="linenos" data-line="982"></span></a><span class="cm">--[[--------------------------&lt; L C C N &gt;----------------------------------------------------------------------</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos" data-line="983"></span></a>
</span><span id="L-984"><a href="#L-984"><span class="linenos" data-line="984"></span></a><span class="cm">Format LCCN link and do simple error checking.  LCCN is a character string 8-12 characters long. The length of</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos" data-line="985"></span></a><span class="cm">the LCCN dictates the character type of the first 1-3 characters; the rightmost eight are always digits.</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos" data-line="986"></span></a><span class="cm">https://oclc-research.github.io/infoURI-Frozen/info-uri.info/info:lccn/reg.html</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos" data-line="987"></span></a>
</span><span id="L-988"><a href="#L-988"><span class="linenos" data-line="988"></span></a><span class="cm">length = 8 then all digits</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos" data-line="989"></span></a><span class="cm">length = 9 then lccn[1] is lowercase alpha</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos" data-line="990"></span></a><span class="cm">length = 10 then lccn[1] and lccn[2] are both lowercase alpha or both digits</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos" data-line="991"></span></a><span class="cm">length = 11 then lccn[1] is lower case alpha, lccn[2] and lccn[3] are both lowercase alpha or both digits</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos" data-line="992"></span></a><span class="cm">length = 12 then lccn[1] and lccn[2] are both lowercase alpha</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos" data-line="993"></span></a>
</span><span id="L-994"><a href="#L-994"><span class="linenos" data-line="994"></span></a><span class="cm">]]</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos" data-line="995"></span></a>
</span><span id="L-996"><a href="#L-996"><span class="linenos" data-line="996"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">lccn</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos" data-line="997"></span></a>	<span class="kd">local</span> <span class="n">lccn</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos" data-line="998"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos" data-line="999"></span></a>	<span class="kd">local</span> <span class="n">err_flag</span><span class="p">;</span>																<span class="c1">-- presume that LCCN is valid</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos" data-line="1000"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">lccn</span><span class="p">;</span>															<span class="c1">-- local copy of the LCCN</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos" data-line="1001"></span></a>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos" data-line="1002"></span></a>	<span class="n">id</span> <span class="o">=</span> <span class="n">normalize_lccn</span> <span class="p">(</span><span class="n">id</span><span class="p">);</span>													<span class="c1">-- get canonical form (no whitespace, hyphens, forward slashes)</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos" data-line="1003"></span></a>	<span class="kd">local</span> <span class="n">len</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">len</span><span class="p">();</span>														<span class="c1">-- get the length of the LCCN</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos" data-line="1004"></span></a>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos" data-line="1005"></span></a>	<span class="kr">if</span> <span class="mi">8</span> <span class="o">==</span> <span class="n">len</span> <span class="kr">then</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos" data-line="1006"></span></a>		<span class="kr">if</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;[^%d]&quot;</span><span class="p">)</span> <span class="kr">then</span>												<span class="c1">-- if LCCN has anything but digits (nil if only digits)</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos" data-line="1007"></span></a>			<span class="n">err_flag</span> <span class="o">=</span> <span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_lccn&#39;</span><span class="p">);</span>							<span class="c1">-- set an error message</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos" data-line="1008"></span></a>		<span class="kr">end</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos" data-line="1009"></span></a>	<span class="kr">elseif</span> <span class="mi">9</span> <span class="o">==</span> <span class="n">len</span> <span class="kr">then</span>														<span class="c1">-- LCCN should be adddddddd</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos" data-line="1010"></span></a>		<span class="kr">if</span> <span class="kc">nil</span> <span class="o">==</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;%l%d%d%d%d%d%d%d%d&quot;</span><span class="p">)</span> <span class="kr">then</span>							<span class="c1">-- does it match our pattern?</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos" data-line="1011"></span></a>			<span class="n">err_flag</span> <span class="o">=</span> <span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_lccn&#39;</span><span class="p">);</span>							<span class="c1">-- set an error message</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos" data-line="1012"></span></a>		<span class="kr">end</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos" data-line="1013"></span></a>	<span class="kr">elseif</span> <span class="mi">10</span> <span class="o">==</span> <span class="n">len</span> <span class="kr">then</span>														<span class="c1">-- LCCN should be aadddddddd or dddddddddd</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos" data-line="1014"></span></a>		<span class="kr">if</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;[^%d]&quot;</span><span class="p">)</span> <span class="kr">then</span>												<span class="c1">-- if LCCN has anything but digits (nil if only digits) ...</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos" data-line="1015"></span></a>			<span class="kr">if</span> <span class="kc">nil</span> <span class="o">==</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^%l%l%d%d%d%d%d%d%d%d&quot;</span><span class="p">)</span> <span class="kr">then</span>					<span class="c1">-- ... see if it matches our pattern</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos" data-line="1016"></span></a>				<span class="n">err_flag</span> <span class="o">=</span> <span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_lccn&#39;</span><span class="p">);</span>						<span class="c1">-- no match, set an error message</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos" data-line="1017"></span></a>			<span class="kr">end</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos" data-line="1018"></span></a>		<span class="kr">end</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos" data-line="1019"></span></a>	<span class="kr">elseif</span> <span class="mi">11</span> <span class="o">==</span> <span class="n">len</span> <span class="kr">then</span>														<span class="c1">-- LCCN should be aaadddddddd or adddddddddd</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos" data-line="1020"></span></a>		<span class="kr">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^%l%l%l%d%d%d%d%d%d%d%d&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^%l%d%d%d%d%d%d%d%d%d%d&quot;</span><span class="p">))</span> <span class="kr">then</span>	<span class="c1">-- see if it matches one of our patterns</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos" data-line="1021"></span></a>			<span class="n">err_flag</span> <span class="o">=</span> <span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_lccn&#39;</span><span class="p">);</span>							<span class="c1">-- no match, set an error message</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos" data-line="1022"></span></a>		<span class="kr">end</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos" data-line="1023"></span></a>	<span class="kr">elseif</span> <span class="mi">12</span> <span class="o">==</span> <span class="n">len</span> <span class="kr">then</span>														<span class="c1">-- LCCN should be aadddddddddd</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos" data-line="1024"></span></a>		<span class="kr">if</span> <span class="ow">not</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^%l%l%d%d%d%d%d%d%d%d%d%d&quot;</span><span class="p">)</span> <span class="kr">then</span>						<span class="c1">-- see if it matches our pattern</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos" data-line="1025"></span></a>			<span class="n">err_flag</span> <span class="o">=</span> <span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_lccn&#39;</span><span class="p">);</span>							<span class="c1">-- no match, set an error message</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos" data-line="1026"></span></a>		<span class="kr">end</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos" data-line="1027"></span></a>	<span class="kr">else</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos" data-line="1028"></span></a>		<span class="n">err_flag</span> <span class="o">=</span> <span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_lccn&#39;</span><span class="p">);</span>								<span class="c1">-- wrong length, set an error message</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos" data-line="1029"></span></a>	<span class="kr">end</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos" data-line="1030"></span></a>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos" data-line="1031"></span></a>	<span class="kr">if</span> <span class="ow">not</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">err_flag</span><span class="p">)</span> <span class="ow">and</span> <span class="kc">nil</span> <span class="o">~=</span> <span class="n">lccn</span><span class="p">:</span><span class="n">find</span> <span class="p">(</span><span class="s1">&#39;%s&#39;</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos" data-line="1032"></span></a>		<span class="n">err_flag</span> <span class="o">=</span> <span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_lccn&#39;</span><span class="p">);</span>								<span class="c1">-- lccn contains a space, set an error message</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos" data-line="1033"></span></a>	<span class="kr">end</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos" data-line="1034"></span></a>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos" data-line="1035"></span></a>	<span class="kr">if</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">err_flag</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos" data-line="1036"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;LCCN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>										<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos" data-line="1037"></span></a>	<span class="kr">end</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos" data-line="1038"></span></a>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos" data-line="1039"></span></a>	<span class="kr">return</span> <span class="n">external_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos" data-line="1040"></span></a>			<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">lccn</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span> <span class="n">encode</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">encode</span><span class="p">});</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos" data-line="1041"></span></a><span class="kr">end</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos" data-line="1042"></span></a>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos" data-line="1043"></span></a>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos" data-line="1044"></span></a><span class="cm">--[[--------------------------&lt; M E D R X I V &gt;-----------------------------------------------------------------</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos" data-line="1045"></span></a>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos" data-line="1046"></span></a><span class="cm">Format medRxiv ID and do simple error checking.  Similar to later bioRxiv IDs, medRxiv IDs are prefixed with a</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos" data-line="1047"></span></a><span class="cm">yyyy.mm.dd. date and suffixed with an optional version identifier.  Ealiest date accepted is 2020.01.01</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos" data-line="1048"></span></a>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos" data-line="1049"></span></a><span class="cm">The medRxiv ID is a date followed by an eight-digit number followed by an optional version indicator &#39;v&#39; and one or more digits:</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos" data-line="1050"></span></a><span class="cm">	https://www.medrxiv.org/content/10.1101/2020.11.16.20232009v2 -&gt; 10.1101/2020.11.16.20232009v2</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos" data-line="1051"></span></a>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos" data-line="1052"></span></a><span class="cm">]]</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos" data-line="1053"></span></a>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos" data-line="1054"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">medrxiv</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos" data-line="1055"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos" data-line="1056"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos" data-line="1057"></span></a>	<span class="kd">local</span> <span class="n">err_msg_flag</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>													<span class="c1">-- flag; assume that there will be an error</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos" data-line="1058"></span></a>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos" data-line="1059"></span></a>	<span class="kd">local</span> <span class="n">patterns</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos" data-line="1060"></span></a>		<span class="s1">&#39;%d%d%d%d%d%d%d%d$&#39;</span><span class="p">,</span>													<span class="c1">-- simple 8-digit identifier; these should be relatively rare</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos" data-line="1061"></span></a>		<span class="s1">&#39;^10%.1101/(20%d%d)%.(%d%d)%.(%d%d)%.%d%d%d%d%d%d%d%dv%d+$&#39;</span><span class="p">,</span>			<span class="c1">-- y.m.d. date + 8-digit identifier + version (2020-01-01 and later)</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos" data-line="1062"></span></a>		<span class="s1">&#39;^10%.1101/(20%d%d)%.(%d%d)%.(%d%d)%.%d%d%d%d%d%d%d%d$&#39;</span><span class="p">,</span>				<span class="c1">-- y.m.d. date + 8-digit identifier (2020-01-01 and later)</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos" data-line="1063"></span></a>		<span class="p">}</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos" data-line="1064"></span></a>	
</span><span id="L-1065"><a href="#L-1065"><span class="linenos" data-line="1065"></span></a>	<span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">pattern</span> <span class="kr">in</span> <span class="nb">ipairs</span> <span class="p">(</span><span class="n">patterns</span><span class="p">)</span> <span class="kr">do</span>										<span class="c1">-- spin through the patterns looking for a match</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos" data-line="1066"></span></a>		<span class="kr">if</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos" data-line="1067"></span></a>			<span class="kd">local</span> <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="n">pattern</span><span class="p">);</span>									<span class="c1">-- found a match, attempt to get year, month and date from the identifier</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos" data-line="1068"></span></a>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos" data-line="1069"></span></a>			<span class="kr">if</span> <span class="n">m</span> <span class="kr">then</span>															<span class="c1">-- m is nil when id is the 8-digit form</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos" data-line="1070"></span></a>				<span class="kr">if</span> <span class="ow">not</span> <span class="n">is_valid_rxiv_date</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="kr">then</span>					<span class="c1">-- validate the encoded date; &#39;b&#39; for medrxiv limit</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos" data-line="1071"></span></a>					<span class="kr">break</span><span class="p">;</span>														<span class="c1">-- date fail; break out early so we don&#39;t unset the error message</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos" data-line="1072"></span></a>				<span class="kr">end</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos" data-line="1073"></span></a>			<span class="kr">end</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos" data-line="1074"></span></a>			<span class="n">err_msg_flag</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>													<span class="c1">-- we found a match so unset the error message</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos" data-line="1075"></span></a>			<span class="kr">break</span><span class="p">;</span>																<span class="c1">-- and done</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos" data-line="1076"></span></a>		<span class="kr">end</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos" data-line="1077"></span></a>	<span class="kr">end</span>																			<span class="c1">-- &lt;err_msg_flag&gt; remains set here when no match</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos" data-line="1078"></span></a>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos" data-line="1079"></span></a>	<span class="kr">if</span> <span class="n">err_msg_flag</span> <span class="kr">then</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos" data-line="1080"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;MEDRXIV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>									<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos" data-line="1081"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_medrxiv&#39;</span><span class="p">);</span>										<span class="c1">-- and set the error message</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos" data-line="1082"></span></a>	<span class="kr">end</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos" data-line="1083"></span></a>	
</span><span id="L-1084"><a href="#L-1084"><span class="linenos" data-line="1084"></span></a>	<span class="kr">return</span> <span class="n">external_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos" data-line="1085"></span></a>			<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos" data-line="1086"></span></a>			<span class="n">encode</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">encode</span><span class="p">,</span> <span class="n">access</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">access</span><span class="p">});</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos" data-line="1087"></span></a><span class="kr">end</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos" data-line="1088"></span></a>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos" data-line="1089"></span></a>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos" data-line="1090"></span></a><span class="cm">--[[--------------------------&lt; M R &gt;--------------------------------------------------------------------------</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos" data-line="1091"></span></a>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos" data-line="1092"></span></a><span class="cm">A seven digit number; if not seven digits, zero-fill leading digits to make seven digits.</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos" data-line="1093"></span></a>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos" data-line="1094"></span></a><span class="cm">]]</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos" data-line="1095"></span></a>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos" data-line="1096"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">mr</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos" data-line="1097"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos" data-line="1098"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos" data-line="1099"></span></a>	<span class="kd">local</span> <span class="n">id_num</span><span class="p">;</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos" data-line="1100"></span></a>	<span class="kd">local</span> <span class="n">id_len</span><span class="p">;</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos" data-line="1101"></span></a>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos" data-line="1102"></span></a>	<span class="n">id_num</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s1">&#39;^[Mm][Rr](%d+)$&#39;</span><span class="p">);</span>										<span class="c1">-- identifier with mr prefix</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos" data-line="1103"></span></a>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos" data-line="1104"></span></a>	<span class="kr">if</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">id_num</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos" data-line="1105"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;maint_mr_format&#39;</span><span class="p">);</span>										<span class="c1">-- add maint cat</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos" data-line="1106"></span></a>	<span class="kr">else</span>																		<span class="c1">-- plain number without mr prefix</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos" data-line="1107"></span></a>		<span class="n">id_num</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s1">&#39;^%d+$&#39;</span><span class="p">);</span>											<span class="c1">-- if here id is all digits</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos" data-line="1108"></span></a>	<span class="kr">end</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos" data-line="1109"></span></a>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos" data-line="1110"></span></a>	<span class="n">id_len</span> <span class="o">=</span> <span class="n">id_num</span> <span class="ow">and</span> <span class="n">id_num</span><span class="p">:</span><span class="n">len</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">;</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos" data-line="1111"></span></a>	<span class="kr">if</span> <span class="p">(</span><span class="mi">7</span> <span class="o">&gt;=</span> <span class="n">id_len</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mi">0</span> <span class="o">~=</span> <span class="n">id_len</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos" data-line="1112"></span></a>		<span class="n">id</span> <span class="o">=</span> <span class="nb">string.rep</span> <span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="o">-</span><span class="n">id_len</span><span class="p">)</span> <span class="o">..</span> <span class="n">id_num</span><span class="p">;</span>								<span class="c1">-- zero-fill leading digits</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos" data-line="1113"></span></a>	<span class="kr">else</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos" data-line="1114"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_mr&#39;</span><span class="p">);</span>												<span class="c1">-- set an error message</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos" data-line="1115"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;MR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>										<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos" data-line="1116"></span></a>	<span class="kr">end</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos" data-line="1117"></span></a>	
</span><span id="L-1118"><a href="#L-1118"><span class="linenos" data-line="1118"></span></a>	<span class="kr">return</span> <span class="n">external_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos" data-line="1119"></span></a>			<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span> <span class="n">encode</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">encode</span><span class="p">});</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos" data-line="1120"></span></a><span class="kr">end</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos" data-line="1121"></span></a>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos" data-line="1122"></span></a>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos" data-line="1123"></span></a><span class="cm">--[[--------------------------&lt; O C L C &gt;----------------------------------------------------------------------</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos" data-line="1124"></span></a>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos" data-line="1125"></span></a><span class="cm">Validate and format an OCLC ID.  https://www.oclc.org/batchload/controlnumber.en.html {{dead link}}</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos" data-line="1126"></span></a><span class="cm">archived at: https://web.archive.org/web/20161228233804/https://www.oclc.org/batchload/controlnumber.en.html</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos" data-line="1127"></span></a>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos" data-line="1128"></span></a><span class="cm">]]</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos" data-line="1129"></span></a>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos" data-line="1130"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">oclc</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos" data-line="1131"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos" data-line="1132"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos" data-line="1133"></span></a>	<span class="kd">local</span> <span class="n">number</span><span class="p">;</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos" data-line="1134"></span></a>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos" data-line="1135"></span></a>	<span class="kr">if</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;^ocm%d%d%d%d%d%d%d%d$&#39;</span><span class="p">)</span> <span class="kr">then</span>									<span class="c1">-- ocm prefix and 8 digits; 001 field (12 characters)</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos" data-line="1136"></span></a>		<span class="n">number</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;ocm(%d+)&#39;</span><span class="p">);</span>											<span class="c1">-- get the number</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos" data-line="1137"></span></a>	<span class="kr">elseif</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;^ocn%d%d%d%d%d%d%d%d%d$&#39;</span><span class="p">)</span> <span class="kr">then</span>								<span class="c1">-- ocn prefix and 9 digits; 001 field (12 characters)</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos" data-line="1138"></span></a>		<span class="n">number</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;ocn(%d+)&#39;</span><span class="p">);</span>											<span class="c1">-- get the number</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos" data-line="1139"></span></a>	<span class="kr">elseif</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;^on%d%d%d%d%d%d%d%d%d%d+$&#39;</span><span class="p">)</span> <span class="kr">then</span>							<span class="c1">-- on prefix and 10 or more digits; 001 field (12 characters)</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos" data-line="1140"></span></a>		<span class="n">number</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;^on(%d%d%d%d%d%d%d%d%d%d+)$&#39;</span><span class="p">);</span>						<span class="c1">-- get the number</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos" data-line="1141"></span></a>	<span class="kr">elseif</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;^%(OCoLC%)[1-9]%d*$&#39;</span><span class="p">)</span> <span class="kr">then</span>									<span class="c1">-- (OCoLC) prefix and variable number digits; no leading zeros; 035 field</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos" data-line="1142"></span></a>		<span class="n">number</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;%(OCoLC%)([1-9]%d*)&#39;</span><span class="p">);</span>								<span class="c1">-- get the number</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos" data-line="1143"></span></a>		<span class="kr">if</span> <span class="mi">9</span> <span class="o">&lt;</span> <span class="n">number</span><span class="p">:</span><span class="n">len</span><span class="p">()</span> <span class="kr">then</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos" data-line="1144"></span></a>			<span class="n">number</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>														<span class="c1">-- constrain to 1 to 9 digits; change this when OCLC issues 10-digit numbers</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos" data-line="1145"></span></a>		<span class="kr">end</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos" data-line="1146"></span></a>	<span class="kr">elseif</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;^%d+$&#39;</span><span class="p">)</span> <span class="kr">then</span>												<span class="c1">-- no prefix</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos" data-line="1147"></span></a>		<span class="n">number</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>															<span class="c1">-- get the number</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos" data-line="1148"></span></a>		<span class="kr">if</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">handler</span><span class="p">.</span><span class="n">id_limit</span> <span class="kr">then</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos" data-line="1149"></span></a>			<span class="n">number</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>														<span class="c1">-- unset when id value exceeds the limit</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos" data-line="1150"></span></a>		<span class="kr">end</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos" data-line="1151"></span></a>	<span class="kr">end</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos" data-line="1152"></span></a>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos" data-line="1153"></span></a>	<span class="kr">if</span> <span class="n">number</span> <span class="kr">then</span>																<span class="c1">-- proper format</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos" data-line="1154"></span></a>		<span class="n">id</span> <span class="o">=</span> <span class="n">number</span><span class="p">;</span>															<span class="c1">-- exclude prefix, if any, from external link</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos" data-line="1155"></span></a>	<span class="kr">else</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos" data-line="1156"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_oclc&#39;</span><span class="p">)</span>											<span class="c1">-- add an error message if the id is malformed</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos" data-line="1157"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;OCLC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>										<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos" data-line="1158"></span></a>	<span class="kr">end</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos" data-line="1159"></span></a>	
</span><span id="L-1160"><a href="#L-1160"><span class="linenos" data-line="1160"></span></a>	<span class="kr">return</span> <span class="n">external_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos" data-line="1161"></span></a>		<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span> <span class="n">encode</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">encode</span><span class="p">});</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos" data-line="1162"></span></a><span class="kr">end</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos" data-line="1163"></span></a>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos" data-line="1164"></span></a>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos" data-line="1165"></span></a><span class="cm">--[[--------------------------&lt; O P E N L I B R A R Y &gt;--------------------------------------------------------</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos" data-line="1166"></span></a>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos" data-line="1167"></span></a><span class="cm">Formats an OpenLibrary link, and checks for associated errors.</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos" data-line="1168"></span></a>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos" data-line="1169"></span></a><span class="cm">]]</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos" data-line="1170"></span></a>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos" data-line="1171"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">openlibrary</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos" data-line="1172"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos" data-line="1173"></span></a>	<span class="kd">local</span> <span class="n">access</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">access</span><span class="p">;</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos" data-line="1174"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos" data-line="1175"></span></a>	<span class="kd">local</span> <span class="n">ident</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">gsub</span><span class="p">(</span><span class="s1">&#39;^OL&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^(%d+([AMW]))$&quot;</span><span class="p">);</span>				<span class="c1">-- strip optional OL prefix followed immediately by digits followed by &#39;A&#39;, &#39;M&#39;, or &#39;W&#39;;</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos" data-line="1176"></span></a>	<span class="kd">local</span> <span class="n">err_flag</span><span class="p">;</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos" data-line="1177"></span></a>	<span class="kd">local</span> <span class="n">prefix</span> <span class="o">=</span> <span class="p">{</span>															<span class="c1">-- these are appended to the handler.prefix according to code</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos" data-line="1178"></span></a>		<span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;authors/OL&#39;</span><span class="p">,</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos" data-line="1179"></span></a>		<span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;books/OL&#39;</span><span class="p">,</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos" data-line="1180"></span></a>		<span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;works/OL&#39;</span><span class="p">,</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos" data-line="1181"></span></a>		<span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;OL&#39;</span>																<span class="c1">-- not a code; spoof when &#39;code&#39; in id is invalid</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos" data-line="1182"></span></a>		<span class="p">};</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos" data-line="1183"></span></a>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos" data-line="1184"></span></a>	<span class="kr">if</span> <span class="ow">not</span> <span class="n">ident</span> <span class="kr">then</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos" data-line="1185"></span></a>		<span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span><span class="p">;</span>																<span class="c1">-- no code or id completely invalid</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos" data-line="1186"></span></a>		<span class="n">ident</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>																<span class="c1">-- copy id to ident so that we display the flawed identifier</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos" data-line="1187"></span></a>		<span class="n">err_flag</span> <span class="o">=</span> <span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_ol&#39;</span><span class="p">);</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos" data-line="1188"></span></a>	<span class="kr">end</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos" data-line="1189"></span></a>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos" data-line="1190"></span></a>	<span class="kr">if</span> <span class="ow">not</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">err_flag</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos" data-line="1191"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;OL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span> <span class="o">..</span> <span class="n">prefix</span><span class="p">[</span><span class="n">code</span><span class="p">]</span> <span class="o">..</span> <span class="n">ident</span><span class="p">;</span>	<span class="c1">-- experiment for ol coins</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos" data-line="1192"></span></a>	<span class="kr">else</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos" data-line="1193"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;OL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>										<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos" data-line="1194"></span></a>	<span class="kr">end</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos" data-line="1195"></span></a>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos" data-line="1196"></span></a>	<span class="kr">return</span> <span class="n">external_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos" data-line="1197"></span></a>		<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span> <span class="o">..</span> <span class="n">prefix</span><span class="p">[</span><span class="n">code</span><span class="p">],</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos" data-line="1198"></span></a>		<span class="n">id</span> <span class="o">=</span> <span class="n">ident</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span> <span class="n">encode</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">encode</span><span class="p">,</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos" data-line="1199"></span></a>		<span class="n">access</span> <span class="o">=</span> <span class="n">access</span><span class="p">});</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos" data-line="1200"></span></a><span class="kr">end</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos" data-line="1201"></span></a>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos" data-line="1202"></span></a>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos" data-line="1203"></span></a><span class="cm">--[[--------------------------&lt; O S T I &gt;----------------------------------------------------------------------</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos" data-line="1204"></span></a>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos" data-line="1205"></span></a><span class="cm">Format OSTI and do simple error checking. OSTIs are sequential numbers beginning at 1 and counting up.  This</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos" data-line="1206"></span></a><span class="cm">code checks the OSTI to see that it contains only digits and is less than test_limit specified in the configuration;</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos" data-line="1207"></span></a><span class="cm">the value in test_limit will need to be updated periodically as more OSTIs are issued.</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos" data-line="1208"></span></a>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos" data-line="1209"></span></a><span class="cm">NB. 1018 is the lowest OSTI number found in the wild (so far) and resolving OK on the OSTI site</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos" data-line="1210"></span></a>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos" data-line="1211"></span></a><span class="cm">]]</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos" data-line="1212"></span></a>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos" data-line="1213"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">osti</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos" data-line="1214"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos" data-line="1215"></span></a>	<span class="kd">local</span> <span class="n">access</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">access</span><span class="p">;</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos" data-line="1216"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos" data-line="1217"></span></a>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos" data-line="1218"></span></a>	<span class="kr">if</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;[^%d]&quot;</span><span class="p">)</span> <span class="kr">then</span>													<span class="c1">-- if OSTI has anything but digits</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos" data-line="1219"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_osti&#39;</span><span class="p">);</span>											<span class="c1">-- set an error message</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos" data-line="1220"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;OSTI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>										<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos" data-line="1221"></span></a>	<span class="kr">else</span>																		<span class="c1">-- OSTI is only digits</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos" data-line="1222"></span></a>		<span class="kd">local</span> <span class="n">id_num</span> <span class="o">=</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="n">id</span><span class="p">);</span>											<span class="c1">-- convert id to a number for range testing</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos" data-line="1223"></span></a>		<span class="kr">if</span> <span class="mi">1018</span> <span class="o">&gt;</span> <span class="n">id_num</span> <span class="ow">or</span> <span class="n">handler</span><span class="p">.</span><span class="n">id_limit</span> <span class="o">&lt;</span> <span class="n">id_num</span> <span class="kr">then</span>						<span class="c1">-- if OSTI is outside test limit boundaries</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos" data-line="1224"></span></a>			<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_osti&#39;</span><span class="p">);</span>										<span class="c1">-- set an error message</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos" data-line="1225"></span></a>			<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;OSTI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>									<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos" data-line="1226"></span></a>		<span class="kr">end</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos" data-line="1227"></span></a>	<span class="kr">end</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos" data-line="1228"></span></a>	
</span><span id="L-1229"><a href="#L-1229"><span class="linenos" data-line="1229"></span></a>	<span class="kr">return</span> <span class="n">external_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos" data-line="1230"></span></a>			<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span> <span class="n">encode</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">encode</span><span class="p">,</span> <span class="n">access</span> <span class="o">=</span> <span class="n">access</span><span class="p">});</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos" data-line="1231"></span></a><span class="kr">end</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos" data-line="1232"></span></a>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos" data-line="1233"></span></a>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos" data-line="1234"></span></a><span class="cm">--[[--------------------------&lt; P M C &gt;------------------------------------------------------------------------</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos" data-line="1235"></span></a>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos" data-line="1236"></span></a><span class="cm">Format a PMC, do simple error checking, and check for embargoed articles.</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos" data-line="1237"></span></a>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos" data-line="1238"></span></a><span class="cm">The embargo parameter takes a date for a value. If the embargo date is in the future the PMC identifier will not</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos" data-line="1239"></span></a><span class="cm">be linked to the article.  If the embargo date is today or in the past, or if it is empty or omitted, then the</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos" data-line="1240"></span></a><span class="cm">PMC identifier is linked to the article through the link at cfg.id_handlers[&#39;PMC&#39;].prefix.</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos" data-line="1241"></span></a>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos" data-line="1242"></span></a><span class="cm">PMC embargo date testing is done in function is_embargoed () which is called earlier because when the citation</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos" data-line="1243"></span></a><span class="cm">has |pmc=&lt;value&gt; but does not have a |url= then |title= is linked with the PMC link.  Function is_embargoed ()</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos" data-line="1244"></span></a><span class="cm">returns the embargo date if the PMC article is still embargoed, otherwise it returns an empty string.</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos" data-line="1245"></span></a>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos" data-line="1246"></span></a><span class="cm">PMCs are sequential numbers beginning at 1 and counting up.  This code checks the PMC to see that it contains only digits and is less</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos" data-line="1247"></span></a><span class="cm">than test_limit; the value in local variable test_limit will need to be updated periodically as more PMCs are issued.</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos" data-line="1248"></span></a>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos" data-line="1249"></span></a><span class="cm">]]</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos" data-line="1250"></span></a>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos" data-line="1251"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">pmc</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos" data-line="1252"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos" data-line="1253"></span></a>	<span class="kd">local</span> <span class="n">embargo</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">Embargo</span><span class="p">;</span>											<span class="c1">-- TODO: lowercase?</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos" data-line="1254"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos" data-line="1255"></span></a>	<span class="kd">local</span> <span class="n">err_flag</span><span class="p">;</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos" data-line="1256"></span></a>	<span class="kd">local</span> <span class="n">id_num</span><span class="p">;</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos" data-line="1257"></span></a>	<span class="kd">local</span> <span class="n">text</span><span class="p">;</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos" data-line="1258"></span></a>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos" data-line="1259"></span></a>	<span class="n">id_num</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s1">&#39;^[Pp][Mm][Cc](%d+)$&#39;</span><span class="p">);</span>									<span class="c1">-- identifier with PMC prefix</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos" data-line="1260"></span></a>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos" data-line="1261"></span></a>	<span class="kr">if</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">id_num</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos" data-line="1262"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;maint_pmc_format&#39;</span><span class="p">);</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos" data-line="1263"></span></a>	<span class="kr">else</span>																		<span class="c1">-- plain number without PMC prefix</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos" data-line="1264"></span></a>		<span class="n">id_num</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s1">&#39;^%d+$&#39;</span><span class="p">);</span>											<span class="c1">-- if here id is all digits</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos" data-line="1265"></span></a>	<span class="kr">end</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos" data-line="1266"></span></a>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos" data-line="1267"></span></a>	<span class="kr">if</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">id_num</span><span class="p">)</span> <span class="kr">then</span>														<span class="c1">-- id_num has a value so test it</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos" data-line="1268"></span></a>		<span class="n">id_num</span> <span class="o">=</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="n">id_num</span><span class="p">);</span>												<span class="c1">-- convert id_num to a number for range testing</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos" data-line="1269"></span></a>		<span class="kr">if</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">id_num</span> <span class="ow">or</span> <span class="n">handler</span><span class="p">.</span><span class="n">id_limit</span> <span class="o">&lt;</span> <span class="n">id_num</span> <span class="kr">then</span>							<span class="c1">-- if PMC is outside test limit boundaries</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos" data-line="1270"></span></a>			<span class="n">err_flag</span> <span class="o">=</span> <span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_pmc&#39;</span><span class="p">);</span>								<span class="c1">-- set an error message</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos" data-line="1271"></span></a>		<span class="kr">else</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos" data-line="1272"></span></a>			<span class="n">id</span> <span class="o">=</span> <span class="nb">tostring</span> <span class="p">(</span><span class="n">id_num</span><span class="p">);</span>												<span class="c1">-- make sure id is a string</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos" data-line="1273"></span></a>		<span class="kr">end</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos" data-line="1274"></span></a>	<span class="kr">else</span>																		<span class="c1">-- when id format incorrect</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos" data-line="1275"></span></a>		<span class="n">err_flag</span> <span class="o">=</span> <span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_pmc&#39;</span><span class="p">);</span>									<span class="c1">-- set an error message</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos" data-line="1276"></span></a>	<span class="kr">end</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos" data-line="1277"></span></a>	
</span><span id="L-1278"><a href="#L-1278"><span class="linenos" data-line="1278"></span></a>	<span class="kr">if</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">embargo</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">is_embargoed</span> <span class="p">(</span><span class="n">embargo</span><span class="p">))</span> <span class="kr">then</span>				<span class="c1">-- is PMC is still embargoed?</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos" data-line="1279"></span></a>		<span class="n">text</span> <span class="o">=</span> <span class="nb">table.concat</span> <span class="p">(</span>													<span class="c1">-- still embargoed so no external link</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos" data-line="1280"></span></a>			<span class="p">{</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos" data-line="1281"></span></a>			<span class="n">make_wikilink</span> <span class="p">(</span><span class="n">link_label_make</span> <span class="p">(</span><span class="n">handler</span><span class="p">),</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">),</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos" data-line="1282"></span></a>			<span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos" data-line="1283"></span></a>			<span class="n">id</span><span class="p">,</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos" data-line="1284"></span></a>			<span class="p">});</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos" data-line="1285"></span></a>	<span class="kr">else</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos" data-line="1286"></span></a>		<span class="n">text</span> <span class="o">=</span> <span class="n">external_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>	<span class="c1">-- no embargo date or embargo has expired, ok to link to article</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos" data-line="1287"></span></a>			<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span> <span class="n">encode</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">encode</span><span class="p">,</span> <span class="n">access</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">access</span><span class="p">,</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos" data-line="1288"></span></a>			<span class="n">auto_link</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">err_flag</span> <span class="ow">and</span> <span class="s1">&#39;pmc&#39;</span> <span class="ow">or</span> <span class="kc">nil</span>							<span class="c1">-- do not auto-link when PMC has error</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos" data-line="1289"></span></a>			<span class="p">});</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos" data-line="1290"></span></a>	<span class="kr">end</span>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos" data-line="1291"></span></a>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos" data-line="1292"></span></a>	<span class="kr">if</span> <span class="n">err_flag</span> <span class="kr">then</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos" data-line="1293"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;PMC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>										<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos" data-line="1294"></span></a>	<span class="kr">end</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos" data-line="1295"></span></a>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos" data-line="1296"></span></a>	<span class="kr">return</span> <span class="n">text</span><span class="p">;</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos" data-line="1297"></span></a><span class="kr">end</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos" data-line="1298"></span></a>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos" data-line="1299"></span></a>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos" data-line="1300"></span></a><span class="cm">--[[--------------------------&lt; P M I D &gt;----------------------------------------------------------------------</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos" data-line="1301"></span></a>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos" data-line="1302"></span></a><span class="cm">Format PMID and do simple error checking.  PMIDs are sequential numbers beginning at 1 and counting up.  This</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos" data-line="1303"></span></a><span class="cm">code checks the PMID to see that it contains only digits and is less than test_limit; the value in local variable</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos" data-line="1304"></span></a><span class="cm">test_limit will need to be updated periodically as more PMIDs are issued.</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos" data-line="1305"></span></a>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos" data-line="1306"></span></a><span class="cm">]]</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos" data-line="1307"></span></a>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos" data-line="1308"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">pmid</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos" data-line="1309"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos" data-line="1310"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos" data-line="1311"></span></a>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos" data-line="1312"></span></a>	<span class="kr">if</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;[^%d]&quot;</span><span class="p">)</span> <span class="kr">then</span>													<span class="c1">-- if PMID has anything but digits</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos" data-line="1313"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_pmid&#39;</span><span class="p">);</span>											<span class="c1">-- set an error message</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos" data-line="1314"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;PMID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>										<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos" data-line="1315"></span></a>	<span class="kr">else</span>																		<span class="c1">-- PMID is only digits</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos" data-line="1316"></span></a>		<span class="kd">local</span> <span class="n">id_num</span> <span class="o">=</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="n">id</span><span class="p">);</span>											<span class="c1">-- convert id to a number for range testing</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos" data-line="1317"></span></a>		<span class="kr">if</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">id_num</span> <span class="ow">or</span> <span class="n">handler</span><span class="p">.</span><span class="n">id_limit</span> <span class="o">&lt;</span> <span class="n">id_num</span> <span class="kr">then</span>							<span class="c1">-- if PMID is outside test limit boundaries</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos" data-line="1318"></span></a>			<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_pmid&#39;</span><span class="p">);</span>										<span class="c1">-- set an error message</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos" data-line="1319"></span></a>			<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;PMID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>									<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos" data-line="1320"></span></a>		<span class="kr">end</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos" data-line="1321"></span></a>	<span class="kr">end</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos" data-line="1322"></span></a>	
</span><span id="L-1323"><a href="#L-1323"><span class="linenos" data-line="1323"></span></a>	<span class="kr">return</span> <span class="n">external_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos" data-line="1324"></span></a>			<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span> <span class="n">encode</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">encode</span><span class="p">});</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos" data-line="1325"></span></a><span class="kr">end</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos" data-line="1326"></span></a>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos" data-line="1327"></span></a>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos" data-line="1328"></span></a><span class="cm">--[[--------------------------&lt; R F C &gt;------------------------------------------------------------------------</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos" data-line="1329"></span></a>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos" data-line="1330"></span></a><span class="cm">Format RFC and do simple error checking. RFCs are sequential numbers beginning at 1 and counting up.  This</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos" data-line="1331"></span></a><span class="cm">code checks the RFC to see that it contains only digits and is less than test_limit specified in the configuration;</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos" data-line="1332"></span></a><span class="cm">the value in test_limit will need to be updated periodically as more RFCs are issued.</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos" data-line="1333"></span></a>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos" data-line="1334"></span></a><span class="cm">An index of all RFCs is here: https://tools.ietf.org/rfc/</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos" data-line="1335"></span></a>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos" data-line="1336"></span></a><span class="cm">]]</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos" data-line="1337"></span></a>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos" data-line="1338"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">rfc</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos" data-line="1339"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos" data-line="1340"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos" data-line="1341"></span></a>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos" data-line="1342"></span></a>	<span class="kr">if</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;[^%d]&quot;</span><span class="p">)</span> <span class="kr">then</span>													<span class="c1">-- if RFC has anything but digits</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos" data-line="1343"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_rfc&#39;</span><span class="p">);</span>											<span class="c1">-- set an error message</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos" data-line="1344"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;RFC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>										<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos" data-line="1345"></span></a>	<span class="kr">else</span>																		<span class="c1">-- RFC is only digits</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos" data-line="1346"></span></a>		<span class="kd">local</span> <span class="n">id_num</span> <span class="o">=</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="n">id</span><span class="p">);</span>											<span class="c1">-- convert id to a number for range testing</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos" data-line="1347"></span></a>		<span class="kr">if</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">id_num</span> <span class="ow">or</span> <span class="n">handler</span><span class="p">.</span><span class="n">id_limit</span> <span class="o">&lt;</span> <span class="n">id_num</span> <span class="kr">then</span>							<span class="c1">-- if RFC is outside test limit boundaries</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos" data-line="1348"></span></a>			<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_rfc&#39;</span><span class="p">);</span>										<span class="c1">-- set an error message</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos" data-line="1349"></span></a>			<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;RFC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>									<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos" data-line="1350"></span></a>		<span class="kr">end</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos" data-line="1351"></span></a>	<span class="kr">end</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos" data-line="1352"></span></a>	
</span><span id="L-1353"><a href="#L-1353"><span class="linenos" data-line="1353"></span></a>	<span class="kr">return</span> <span class="n">external_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos" data-line="1354"></span></a>			<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span> <span class="n">encode</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">encode</span><span class="p">,</span> <span class="n">access</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">access</span><span class="p">});</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos" data-line="1355"></span></a><span class="kr">end</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos" data-line="1356"></span></a>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos" data-line="1357"></span></a>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos" data-line="1358"></span></a><span class="cm">--[[--------------------------&lt; S 2 C I D &gt;--------------------------------------------------------------------</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos" data-line="1359"></span></a>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos" data-line="1360"></span></a><span class="cm">Format an S2CID, do simple error checking</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos" data-line="1361"></span></a>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos" data-line="1362"></span></a><span class="cm">S2CIDs are sequential numbers beginning at 1 and counting up.  This code checks the S2CID to see that it is only</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos" data-line="1363"></span></a><span class="cm">digits and is less than test_limit; the value in local variable test_limit will need to be updated periodically</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos" data-line="1364"></span></a><span class="cm">as more S2CIDs are issued.</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos" data-line="1365"></span></a>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos" data-line="1366"></span></a><span class="cm">]]</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos" data-line="1367"></span></a>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos" data-line="1368"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">s2cid</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos" data-line="1369"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos" data-line="1370"></span></a>	<span class="kd">local</span> <span class="n">access</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">access</span><span class="p">;</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos" data-line="1371"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos" data-line="1372"></span></a>	<span class="kd">local</span> <span class="n">id_num</span><span class="p">;</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos" data-line="1373"></span></a>	<span class="kd">local</span> <span class="n">text</span><span class="p">;</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos" data-line="1374"></span></a>	
</span><span id="L-1375"><a href="#L-1375"><span class="linenos" data-line="1375"></span></a>	<span class="n">id_num</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s1">&#39;^[1-9]%d*$&#39;</span><span class="p">);</span>											<span class="c1">-- id must be all digits; must not begin with 0; no open access flag</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos" data-line="1376"></span></a>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos" data-line="1377"></span></a> 	<span class="kr">if</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">id_num</span><span class="p">)</span> <span class="kr">then</span>														<span class="c1">-- id_num has a value so test it</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos" data-line="1378"></span></a>		<span class="n">id_num</span> <span class="o">=</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="n">id_num</span><span class="p">);</span>												<span class="c1">-- convert id_num to a number for range testing</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos" data-line="1379"></span></a>		<span class="kr">if</span> <span class="n">handler</span><span class="p">.</span><span class="n">id_limit</span> <span class="o">&lt;</span> <span class="n">id_num</span> <span class="kr">then</span>										<span class="c1">-- if S2CID is outside test limit boundaries</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos" data-line="1380"></span></a>			<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_s2cid&#39;</span><span class="p">);</span>										<span class="c1">-- set an error message</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos" data-line="1381"></span></a>			<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;S2CID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>								<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos" data-line="1382"></span></a>		<span class="kr">end</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos" data-line="1383"></span></a>	<span class="kr">else</span>																		<span class="c1">-- when id format incorrect</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos" data-line="1384"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_s2cid&#39;</span><span class="p">);</span>											<span class="c1">-- set an error message</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos" data-line="1385"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;S2CID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>									<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos" data-line="1386"></span></a>	<span class="kr">end</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos" data-line="1387"></span></a>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos" data-line="1388"></span></a>	<span class="n">text</span> <span class="o">=</span> <span class="n">external_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos" data-line="1389"></span></a>		<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span> <span class="n">encode</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">encode</span><span class="p">,</span> <span class="n">access</span> <span class="o">=</span> <span class="n">access</span><span class="p">});</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos" data-line="1390"></span></a>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos" data-line="1391"></span></a>	<span class="kr">return</span> <span class="n">text</span><span class="p">;</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos" data-line="1392"></span></a><span class="kr">end</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos" data-line="1393"></span></a>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos" data-line="1394"></span></a>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos" data-line="1395"></span></a><span class="cm">--[[--------------------------&lt; S B N &gt;------------------------------------------------------------------------</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos" data-line="1396"></span></a>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos" data-line="1397"></span></a><span class="cm">9-digit form of ISBN-10; uses same check-digit validation when SBN is prefixed with an additional &#39;0&#39; to make 10 digits</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos" data-line="1398"></span></a>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos" data-line="1399"></span></a><span class="cm">sbn value not made part of COinS metadata because we don&#39;t have a url or isn&#39;t a COinS-defined identifier (rft.xxx)</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos" data-line="1400"></span></a><span class="cm">or an identifier registered at info-uri.info (info:)</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos" data-line="1401"></span></a>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos" data-line="1402"></span></a><span class="cm">]]</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos" data-line="1403"></span></a>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos" data-line="1404"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">sbn</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos" data-line="1405"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos" data-line="1406"></span></a>	<span class="kd">local</span> <span class="n">ignore_invalid</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">accept</span><span class="p">;</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos" data-line="1407"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos" data-line="1408"></span></a>	<span class="kd">local</span> <span class="kr">function</span> <span class="nf">return_result</span> <span class="p">(</span><span class="n">check</span><span class="p">,</span> <span class="n">err_type</span><span class="p">)</span>								<span class="c1">-- local function to handle the various returns</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos" data-line="1409"></span></a>		<span class="kd">local</span> <span class="n">SBN</span> <span class="o">=</span> <span class="n">internal_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos" data-line="1410"></span></a>						<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">});</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos" data-line="1411"></span></a>		<span class="kr">if</span> <span class="ow">not</span> <span class="n">ignore_invalid</span> <span class="kr">then</span>												<span class="c1">-- if not ignoring SBN errors</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos" data-line="1412"></span></a>			<span class="kr">if</span> <span class="ow">not</span> <span class="n">check</span> <span class="kr">then</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos" data-line="1413"></span></a>				<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;SBN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>								<span class="c1">-- when error, unset so not included in COinS; not really necessary here because sbn not made part of COinS</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos" data-line="1414"></span></a>				<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_sbn&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">err_type</span><span class="p">});</span>						<span class="c1">-- display an error message</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos" data-line="1415"></span></a>				<span class="kr">return</span> <span class="n">SBN</span><span class="p">;</span> 
</span><span id="L-1416"><a href="#L-1416"><span class="linenos" data-line="1416"></span></a>			<span class="kr">end</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos" data-line="1417"></span></a>		<span class="kr">else</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos" data-line="1418"></span></a>			<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;maint_isbn_ignore&#39;</span><span class="p">);</span>									<span class="c1">-- add a maint category even when there is no error (ToDo: Possibly switch to separate message for SBNs only)</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos" data-line="1419"></span></a>		<span class="kr">end</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos" data-line="1420"></span></a>		<span class="kr">return</span> <span class="n">SBN</span><span class="p">;</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos" data-line="1421"></span></a>	<span class="kr">end</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos" data-line="1422"></span></a>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos" data-line="1423"></span></a>	<span class="kr">if</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s1">&#39;[^%s-0-9X]&#39;</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos" data-line="1424"></span></a>		<span class="kr">return</span> <span class="n">return_result</span> <span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">err_msg_supl</span><span class="p">.</span><span class="n">char</span><span class="p">);</span>					<span class="c1">-- fail if SBN contains anything but digits, hyphens, or the uppercase X</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos" data-line="1425"></span></a>	<span class="kr">end</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos" data-line="1426"></span></a>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos" data-line="1427"></span></a>	<span class="kd">local</span> <span class="n">ident</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">gsub</span> <span class="p">(</span><span class="s1">&#39;[%s-]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>										<span class="c1">-- remove hyphens and whitespace; they interfere with the rest of the tests</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos" data-line="1428"></span></a>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos" data-line="1429"></span></a>	<span class="kr">if</span>  <span class="mi">9</span> <span class="o">~=</span> <span class="n">ident</span><span class="p">:</span><span class="n">len</span><span class="p">()</span> <span class="kr">then</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos" data-line="1430"></span></a>		<span class="kr">return</span> <span class="n">return_result</span> <span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">err_msg_supl</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>					<span class="c1">-- fail if incorrect length</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos" data-line="1431"></span></a>	<span class="kr">end</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos" data-line="1432"></span></a>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos" data-line="1433"></span></a>	<span class="kr">if</span> <span class="n">ident</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s1">&#39;^%d*X?$&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">nil</span> <span class="kr">then</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos" data-line="1434"></span></a>		<span class="kr">return</span> <span class="n">return_result</span> <span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">err_msg_supl</span><span class="p">.</span><span class="n">form</span><span class="p">);</span>					<span class="c1">-- fail if SBN has &#39;X&#39; anywhere but last position</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos" data-line="1435"></span></a>	<span class="kr">end</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos" data-line="1436"></span></a>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos" data-line="1437"></span></a>	<span class="kr">return</span> <span class="n">return_result</span> <span class="p">(</span><span class="n">is_valid_isxn</span> <span class="p">(</span><span class="s1">&#39;0&#39;</span> <span class="o">..</span> <span class="n">ident</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">cfg</span><span class="p">.</span><span class="n">err_msg_supl</span><span class="p">.</span><span class="n">check</span><span class="p">);</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos" data-line="1438"></span></a><span class="kr">end</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos" data-line="1439"></span></a>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos" data-line="1440"></span></a>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos" data-line="1441"></span></a><span class="cm">--[[--------------------------&lt; S S R N &gt;----------------------------------------------------------------------</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos" data-line="1442"></span></a>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos" data-line="1443"></span></a><span class="cm">Format an SSRN, do simple error checking</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos" data-line="1444"></span></a>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos" data-line="1445"></span></a><span class="cm">SSRNs are sequential numbers beginning at 100? and counting up.  This code checks the SSRN to see that it is</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos" data-line="1446"></span></a><span class="cm">only digits and is greater than 99 and less than test_limit; the value in local variable test_limit will need</span>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos" data-line="1447"></span></a><span class="cm">to be updated periodically as more SSRNs are issued.</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos" data-line="1448"></span></a>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos" data-line="1449"></span></a><span class="cm">]]</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos" data-line="1450"></span></a>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos" data-line="1451"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">ssrn</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos" data-line="1452"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos" data-line="1453"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos" data-line="1454"></span></a>	<span class="kd">local</span> <span class="n">id_num</span><span class="p">;</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos" data-line="1455"></span></a>	<span class="kd">local</span> <span class="n">text</span><span class="p">;</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos" data-line="1456"></span></a>	
</span><span id="L-1457"><a href="#L-1457"><span class="linenos" data-line="1457"></span></a>	<span class="n">id_num</span> <span class="o">=</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span> <span class="p">(</span><span class="s1">&#39;^%d+$&#39;</span><span class="p">);</span>												<span class="c1">-- id must be all digits</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos" data-line="1458"></span></a>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos" data-line="1459"></span></a>	<span class="kr">if</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">id_num</span><span class="p">)</span> <span class="kr">then</span>														<span class="c1">-- id_num has a value so test it</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos" data-line="1460"></span></a>		<span class="n">id_num</span> <span class="o">=</span> <span class="nb">tonumber</span> <span class="p">(</span><span class="n">id_num</span><span class="p">);</span>												<span class="c1">-- convert id_num to a number for range testing</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos" data-line="1461"></span></a>		<span class="kr">if</span> <span class="mi">100</span> <span class="o">&gt;</span> <span class="n">id_num</span> <span class="ow">or</span> <span class="n">handler</span><span class="p">.</span><span class="n">id_limit</span> <span class="o">&lt;</span> <span class="n">id_num</span> <span class="kr">then</span>						<span class="c1">-- if SSRN is outside test limit boundaries</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos" data-line="1462"></span></a>			<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_ssrn&#39;</span><span class="p">);</span>										<span class="c1">-- set an error message</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos" data-line="1463"></span></a>			<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;SSRN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>									<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos" data-line="1464"></span></a>		<span class="kr">end</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos" data-line="1465"></span></a>	<span class="kr">else</span>																		<span class="c1">-- when id format incorrect</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos" data-line="1466"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_ssrn&#39;</span><span class="p">);</span>											<span class="c1">-- set an error message</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos" data-line="1467"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;SSRN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>										<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos" data-line="1468"></span></a>	<span class="kr">end</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos" data-line="1469"></span></a>	
</span><span id="L-1470"><a href="#L-1470"><span class="linenos" data-line="1470"></span></a>	<span class="n">text</span> <span class="o">=</span> <span class="n">external_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos" data-line="1471"></span></a>		<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span> <span class="n">encode</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">encode</span><span class="p">,</span> <span class="n">access</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">access</span><span class="p">});</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos" data-line="1472"></span></a>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos" data-line="1473"></span></a>	<span class="kr">return</span> <span class="n">text</span><span class="p">;</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos" data-line="1474"></span></a><span class="kr">end</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos" data-line="1475"></span></a>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos" data-line="1476"></span></a>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos" data-line="1477"></span></a><span class="cm">--[[--------------------------&lt; U S E N E T _ I D &gt;------------------------------------------------------------</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos" data-line="1478"></span></a>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos" data-line="1479"></span></a><span class="cm">Validate and format a usenet message id.  Simple error checking, looks for &#39;id-left@id-right&#39; not enclosed in</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos" data-line="1480"></span></a><span class="cm">&#39;&lt;&#39; and/or &#39;&gt;&#39; angle brackets.</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos" data-line="1481"></span></a>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos" data-line="1482"></span></a><span class="cm">]]</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos" data-line="1483"></span></a>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos" data-line="1484"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">usenet_id</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos" data-line="1485"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos" data-line="1486"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos" data-line="1487"></span></a>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos" data-line="1488"></span></a>	<span class="kd">local</span> <span class="n">text</span> <span class="o">=</span> <span class="n">external_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos" data-line="1489"></span></a>		<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span> <span class="n">encode</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">encode</span><span class="p">})</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos" data-line="1490"></span></a> 
</span><span id="L-1491"><a href="#L-1491"><span class="linenos" data-line="1491"></span></a>	<span class="kr">if</span> <span class="ow">not</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;^.+@.+$&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;^[^&lt;].*[^&gt;]$&#39;</span><span class="p">)</span> <span class="kr">then</span>				<span class="c1">-- doesn&#39;t have &#39;@&#39; or has one or first or last character is &#39;&lt; or &#39;&gt;&#39;</span>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos" data-line="1492"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_usenet_id&#39;</span><span class="p">)</span>										<span class="c1">-- add an error message if the message id is invalid</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos" data-line="1493"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;USENETID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>									<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos" data-line="1494"></span></a>	<span class="kr">end</span> 
</span><span id="L-1495"><a href="#L-1495"><span class="linenos" data-line="1495"></span></a>	
</span><span id="L-1496"><a href="#L-1496"><span class="linenos" data-line="1496"></span></a>	<span class="kr">return</span> <span class="n">text</span><span class="p">;</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos" data-line="1497"></span></a><span class="kr">end</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos" data-line="1498"></span></a>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos" data-line="1499"></span></a>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos" data-line="1500"></span></a><span class="cm">--[[--------------------------&lt; Z B L &gt;-----------------------------------------------------------------------</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos" data-line="1501"></span></a>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos" data-line="1502"></span></a><span class="cm">A numerical identifier in the form nnnn.nnnnn - leading zeros in the first quartet optional</span>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos" data-line="1503"></span></a>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos" data-line="1504"></span></a><span class="cm">format described here: http://emis.mi.sanu.ac.rs/ZMATH/zmath/en/help/search/</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos" data-line="1505"></span></a>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos" data-line="1506"></span></a><span class="cm">temporary format is apparently eight digits.  Anything else is an error</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos" data-line="1507"></span></a>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos" data-line="1508"></span></a><span class="cm">]]</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos" data-line="1509"></span></a>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos" data-line="1510"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">zbl</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos" data-line="1511"></span></a>	<span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos" data-line="1512"></span></a>	<span class="kd">local</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">handler</span><span class="p">;</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos" data-line="1513"></span></a>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos" data-line="1514"></span></a>	<span class="kr">if</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;^%d%d%d%d%d%d%d%d$&#39;</span><span class="p">)</span> <span class="kr">then</span>										<span class="c1">-- is this identifier using temporary format?</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos" data-line="1515"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;maint_zbl&#39;</span><span class="p">);</span>												<span class="c1">-- yes, add maint cat</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos" data-line="1516"></span></a>	<span class="kr">elseif</span> <span class="ow">not</span> <span class="n">id</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;^%d?%d?%d?%d%.%d%d%d%d%d$&#39;</span><span class="p">)</span> <span class="kr">then</span>						<span class="c1">-- not temporary, is it normal format?</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos" data-line="1517"></span></a>		<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_bad_zbl&#39;</span><span class="p">);</span>											<span class="c1">-- no, set an error message</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos" data-line="1518"></span></a>		<span class="n">options</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="s1">&#39;ZBL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>										<span class="c1">-- when error, unset so not included in COinS</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos" data-line="1519"></span></a>	<span class="kr">end</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos" data-line="1520"></span></a>	
</span><span id="L-1521"><a href="#L-1521"><span class="linenos" data-line="1521"></span></a>	<span class="kr">return</span> <span class="n">external_link_id</span> <span class="p">({</span><span class="n">link</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">q</span><span class="p">,</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">redirect</span><span class="p">,</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos" data-line="1522"></span></a>			<span class="n">prefix</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">separator</span><span class="p">,</span> <span class="n">encode</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">encode</span><span class="p">});</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos" data-line="1523"></span></a><span class="kr">end</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos" data-line="1524"></span></a>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos" data-line="1525"></span></a>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos" data-line="1526"></span></a><span class="c1">--============================&lt;&lt; I N T E R F A C E   F U N C T I O N S &gt;&gt;==========================================</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos" data-line="1527"></span></a>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos" data-line="1528"></span></a><span class="cm">--[[--------------------------&lt; E X T R A C T _ I D S &gt;------------------------------------------------------------</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos" data-line="1529"></span></a>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos" data-line="1530"></span></a><span class="cm">Populates ID table from arguments using configuration settings. Loops through cfg.id_handlers and searches args for</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos" data-line="1531"></span></a><span class="cm">any of the parameters listed in each cfg.id_handlers[&#39;...&#39;].parameters.  If found, adds the parameter and value to</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos" data-line="1532"></span></a><span class="cm">the identifier list.  Emits redundant error message if more than one alias exists in args</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos" data-line="1533"></span></a>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos" data-line="1534"></span></a><span class="cm">]]</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos" data-line="1535"></span></a>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos" data-line="1536"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">extract_ids</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos" data-line="1537"></span></a>	<span class="kd">local</span> <span class="n">id_list</span> <span class="o">=</span> <span class="p">{};</span>															<span class="c1">-- list of identifiers found in args</span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos" data-line="1538"></span></a>	<span class="kr">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="kr">in</span> <span class="nb">pairs</span> <span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">id_handlers</span><span class="p">)</span> <span class="kr">do</span>										<span class="c1">-- k is uppercase identifier name as index to cfg.id_handlers; e.g. cfg.id_handlers[&#39;ISBN&#39;], v is a table</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos" data-line="1539"></span></a>		<span class="n">v</span> <span class="o">=</span> <span class="n">select_one</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span> <span class="s1">&#39;err_redundant_parameters&#39;</span> <span class="p">);</span>		<span class="c1">-- v.parameters is a table of aliases for k; here we pick one from args if present</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos" data-line="1540"></span></a>		<span class="kr">if</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="kr">then</span> <span class="n">id_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span> <span class="kr">end</span>									<span class="c1">-- if found in args, add identifier to our list</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos" data-line="1541"></span></a>	<span class="kr">end</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos" data-line="1542"></span></a>	<span class="kr">return</span> <span class="n">id_list</span><span class="p">;</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos" data-line="1543"></span></a><span class="kr">end</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos" data-line="1544"></span></a>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos" data-line="1545"></span></a>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos" data-line="1546"></span></a><span class="cm">--[[--------------------------&lt; E X T R A C T _ I D _ A C C E S S _ L E V E L S &gt;--------------------------------------</span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos" data-line="1547"></span></a>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos" data-line="1548"></span></a><span class="cm">Fetches custom id access levels from arguments using configuration settings. Parameters which have a predefined access</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos" data-line="1549"></span></a><span class="cm">level (e.g. arxiv) do not use this function as they are directly rendered as free without using an additional parameter.</span>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos" data-line="1550"></span></a>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos" data-line="1551"></span></a><span class="cm">returns a table of k/v pairs where k is same as the identifier&#39;s key in cfg.id_handlers and v is the assigned (valid) keyword</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos" data-line="1552"></span></a>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos" data-line="1553"></span></a><span class="cm">access-level values must match the case used in cfg.keywords_lists[&#39;id-access&#39;] (lowercase unless there is some special reason for something else)</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos" data-line="1554"></span></a>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos" data-line="1555"></span></a><span class="cm">]]</span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos" data-line="1556"></span></a>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos" data-line="1557"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">extract_id_access_levels</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">id_list</span><span class="p">)</span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos" data-line="1558"></span></a>	<span class="kd">local</span> <span class="n">id_accesses_list</span> <span class="o">=</span> <span class="p">{};</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos" data-line="1559"></span></a>	<span class="kr">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="kr">in</span> <span class="nb">pairs</span> <span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">id_handlers</span><span class="p">)</span> <span class="kr">do</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos" data-line="1560"></span></a>		<span class="kd">local</span> <span class="n">access_param</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">custom_access</span><span class="p">;</span>									<span class="c1">-- name of identifier&#39;s access-level parameter</span>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos" data-line="1561"></span></a>		<span class="kr">if</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">access_param</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos" data-line="1562"></span></a>			<span class="kd">local</span> <span class="n">access_level</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">access_param</span><span class="p">];</span>							<span class="c1">-- get the assigned value if there is one</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos" data-line="1563"></span></a>			<span class="kr">if</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">access_level</span><span class="p">)</span> <span class="kr">then</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos" data-line="1564"></span></a>				<span class="kr">if</span> <span class="ow">not</span> <span class="n">in_array</span> <span class="p">(</span><span class="n">access_level</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">keywords_lists</span><span class="p">[</span><span class="s1">&#39;id-access&#39;</span><span class="p">])</span> <span class="kr">then</span>	<span class="c1">-- exact match required</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos" data-line="1565"></span></a>					<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_invalid_param_val&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">access_param</span><span class="p">,</span> <span class="n">access_level</span><span class="p">});</span>	
</span><span id="L-1566"><a href="#L-1566"><span class="linenos" data-line="1566"></span></a>					<span class="n">access_level</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>											<span class="c1">-- invalid so unset</span>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos" data-line="1567"></span></a>				<span class="kr">end</span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos" data-line="1568"></span></a>				<span class="kr">if</span> <span class="ow">not</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">id_list</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="kr">then</span>									<span class="c1">-- identifier access-level must have a matching identifier</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos" data-line="1569"></span></a>					<span class="n">set_message</span> <span class="p">(</span><span class="s1">&#39;err_param_access_requires_param&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">lower</span><span class="p">()});</span>	<span class="c1">-- parameter name is uppercase in cfg.id_handlers (k); lowercase for error message</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos" data-line="1570"></span></a>				<span class="kr">end</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos" data-line="1571"></span></a>				<span class="n">id_accesses_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="n">keywords_xlate</span><span class="p">[</span><span class="n">access_level</span><span class="p">];</span>			<span class="c1">-- get translated keyword</span>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos" data-line="1572"></span></a>			<span class="kr">end</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos" data-line="1573"></span></a>		<span class="kr">end</span>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos" data-line="1574"></span></a>	<span class="kr">end</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos" data-line="1575"></span></a>	<span class="kr">return</span> <span class="n">id_accesses_list</span><span class="p">;</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos" data-line="1576"></span></a><span class="kr">end</span>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos" data-line="1577"></span></a>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos" data-line="1578"></span></a>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos" data-line="1579"></span></a><span class="cm">--[[--------------------------&lt; B U I L D _ I D _ L I S T &gt;----------------------------------------------------</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos" data-line="1580"></span></a>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos" data-line="1581"></span></a><span class="cm">render the identifiers into a sorted sequence table</span>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos" data-line="1582"></span></a>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos" data-line="1583"></span></a><span class="cm">&lt;ID_list_coins_t&gt; is a table of k/v pairs where k is same as key in cfg.id_handlers and v is the assigned value</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos" data-line="1584"></span></a><span class="cm">&lt;options_t&gt; is a table of various k/v option pairs provided in the call to new_build_id_list();</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos" data-line="1585"></span></a><span class="cm">	modified by	this function and passed to all identifier rendering functions</span>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos" data-line="1586"></span></a><span class="cm">&lt;access_levels_t&gt; is a table of k/v pairs where k is same as key in cfg.id_handlers and v is the assigned value (if valid)</span>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos" data-line="1587"></span></a>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos" data-line="1588"></span></a><span class="cm">returns a sequence table of sorted (by hkey - &#39;handler&#39; key) rendered identifier strings</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos" data-line="1589"></span></a>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos" data-line="1590"></span></a><span class="cm">]]</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos" data-line="1591"></span></a>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos" data-line="1592"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">build_id_list</span> <span class="p">(</span><span class="n">ID_list_coins_t</span><span class="p">,</span> <span class="n">options_t</span><span class="p">,</span> <span class="n">access_levels_t</span><span class="p">)</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos" data-line="1593"></span></a>	<span class="kd">local</span> <span class="n">ID_list_t</span> <span class="o">=</span> <span class="p">{};</span>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos" data-line="1594"></span></a>	<span class="kd">local</span> <span class="n">accept</span><span class="p">;</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos" data-line="1595"></span></a>	<span class="kd">local</span> <span class="n">func_map</span> <span class="o">=</span> <span class="p">{</span>															<span class="c1">--function map points to functions associated with hkey identifier</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos" data-line="1596"></span></a>		<span class="p">[</span><span class="s1">&#39;ARXIV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arxiv</span><span class="p">,</span>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos" data-line="1597"></span></a>		<span class="p">[</span><span class="s1">&#39;ASIN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asin</span><span class="p">,</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos" data-line="1598"></span></a>		<span class="p">[</span><span class="s1">&#39;BIBCODE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bibcode</span><span class="p">,</span>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos" data-line="1599"></span></a>		<span class="p">[</span><span class="s1">&#39;BIORXIV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">biorxiv</span><span class="p">,</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos" data-line="1600"></span></a>		<span class="p">[</span><span class="s1">&#39;CITESEERX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">citeseerx</span><span class="p">,</span>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos" data-line="1601"></span></a>		<span class="p">[</span><span class="s1">&#39;DOI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">doi</span><span class="p">,</span>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos" data-line="1602"></span></a>		<span class="p">[</span><span class="s1">&#39;EISSN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">issn</span><span class="p">,</span>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos" data-line="1603"></span></a>		<span class="p">[</span><span class="s1">&#39;HDL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdl</span><span class="p">,</span>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos" data-line="1604"></span></a>		<span class="p">[</span><span class="s1">&#39;ISBN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isbn</span><span class="p">,</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos" data-line="1605"></span></a>		<span class="p">[</span><span class="s1">&#39;ISMN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ismn</span><span class="p">,</span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos" data-line="1606"></span></a>		<span class="p">[</span><span class="s1">&#39;ISSN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">issn</span><span class="p">,</span>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos" data-line="1607"></span></a>		<span class="p">[</span><span class="s1">&#39;JFM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jfm</span><span class="p">,</span>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos" data-line="1608"></span></a>		<span class="p">[</span><span class="s1">&#39;JSTOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jstor</span><span class="p">,</span>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos" data-line="1609"></span></a>		<span class="p">[</span><span class="s1">&#39;LCCN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lccn</span><span class="p">,</span>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos" data-line="1610"></span></a>		<span class="p">[</span><span class="s1">&#39;MEDRXIV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">medrxiv</span><span class="p">,</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos" data-line="1611"></span></a>		<span class="p">[</span><span class="s1">&#39;MR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mr</span><span class="p">,</span>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos" data-line="1612"></span></a>		<span class="p">[</span><span class="s1">&#39;OCLC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oclc</span><span class="p">,</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos" data-line="1613"></span></a>		<span class="p">[</span><span class="s1">&#39;OL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">openlibrary</span><span class="p">,</span>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos" data-line="1614"></span></a>		<span class="p">[</span><span class="s1">&#39;OSTI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">osti</span><span class="p">,</span>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos" data-line="1615"></span></a>		<span class="p">[</span><span class="s1">&#39;PMC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmc</span><span class="p">,</span>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos" data-line="1616"></span></a>		<span class="p">[</span><span class="s1">&#39;PMID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmid</span><span class="p">,</span>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos" data-line="1617"></span></a>		<span class="p">[</span><span class="s1">&#39;RFC&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">rfc</span><span class="p">,</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos" data-line="1618"></span></a>		<span class="p">[</span><span class="s1">&#39;S2CID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s2cid</span><span class="p">,</span>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos" data-line="1619"></span></a>		<span class="p">[</span><span class="s1">&#39;SBN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbn</span><span class="p">,</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos" data-line="1620"></span></a>		<span class="p">[</span><span class="s1">&#39;SSRN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ssrn</span><span class="p">,</span>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos" data-line="1621"></span></a>		<span class="p">[</span><span class="s1">&#39;USENETID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">usenet_id</span><span class="p">,</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos" data-line="1622"></span></a>		<span class="p">[</span><span class="s1">&#39;ZBL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zbl</span><span class="p">,</span>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos" data-line="1623"></span></a>		<span class="p">}</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos" data-line="1624"></span></a>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos" data-line="1625"></span></a>	<span class="kr">for</span> <span class="n">hkey</span><span class="p">,</span> <span class="n">v</span> <span class="kr">in</span> <span class="nb">pairs</span> <span class="p">(</span><span class="n">ID_list_coins_t</span><span class="p">)</span> <span class="kr">do</span>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos" data-line="1626"></span></a>		<span class="n">v</span><span class="p">,</span> <span class="n">accept</span> <span class="o">=</span> <span class="n">has_accept_as_written</span> <span class="p">(</span><span class="n">v</span><span class="p">);</span>									<span class="c1">-- remove accept-as-written markup if present; accept is boolean true when markup removed; false else</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos" data-line="1627"></span></a>																				<span class="c1">-- every function gets the options table with value v and accept boolean</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos" data-line="1628"></span></a>		<span class="n">options_t</span><span class="p">.</span><span class="n">hkey</span> <span class="o">=</span> <span class="n">hkey</span><span class="p">;</span>													<span class="c1">-- ~/Configuration handler key</span>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos" data-line="1629"></span></a>		<span class="n">options_t</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>														<span class="c1">-- add that identifier value to the options table</span>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos" data-line="1630"></span></a>		<span class="n">options_t</span><span class="p">.</span><span class="n">accept</span> <span class="o">=</span> <span class="n">accept</span><span class="p">;</span>												<span class="c1">-- add the accept boolean flag</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos" data-line="1631"></span></a>		<span class="n">options_t</span><span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">access_levels_t</span><span class="p">[</span><span class="n">hkey</span><span class="p">];</span>								<span class="c1">-- add the access level for those that have an |&lt;identifier-access= parameter</span>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos" data-line="1632"></span></a>		<span class="n">options_t</span><span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="n">id_handlers</span><span class="p">[</span><span class="n">hkey</span><span class="p">];</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos" data-line="1633"></span></a>		<span class="n">options_t</span><span class="p">.</span><span class="n">coins_list_t</span> <span class="o">=</span> <span class="n">ID_list_coins_t</span><span class="p">;</span>								<span class="c1">-- pointer to ID_list_coins_t; for |asin= and |ol=; also to keep erroneous values out of the citation&#39;s metadata</span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos" data-line="1634"></span></a>		<span class="n">options_t</span><span class="p">.</span><span class="n">coins_list_t</span><span class="p">[</span><span class="n">hkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>										<span class="c1">-- id value without accept-as-written markup for metadata</span>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos" data-line="1635"></span></a>		
</span><span id="L-1636"><a href="#L-1636"><span class="linenos" data-line="1636"></span></a>		<span class="kr">if</span> <span class="n">options_t</span><span class="p">.</span><span class="n">handler</span><span class="p">.</span><span class="n">access</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">in_array</span> <span class="p">(</span><span class="n">options_t</span><span class="p">.</span><span class="n">handler</span><span class="p">.</span><span class="n">access</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">keywords_lists</span><span class="p">[</span><span class="s1">&#39;id-access&#39;</span><span class="p">])</span> <span class="kr">then</span>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos" data-line="1637"></span></a>			<span class="nb">error</span> <span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">messages</span><span class="p">[</span><span class="s1">&#39;unknown_ID_access&#39;</span><span class="p">]</span> <span class="o">..</span> <span class="n">options_t</span><span class="p">.</span><span class="n">handler</span><span class="p">.</span><span class="n">access</span><span class="p">);</span>	<span class="c1">-- here when handler access key set to a value not listed in list of allowed id access keywords</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos" data-line="1638"></span></a>		<span class="kr">end</span>
</span><span id="L-1639"><a href="#L-1639"><span class="linenos" data-line="1639"></span></a>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos" data-line="1640"></span></a>		<span class="kr">if</span> <span class="n">func_map</span><span class="p">[</span><span class="n">hkey</span><span class="p">]</span> <span class="kr">then</span>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos" data-line="1641"></span></a>			<span class="kd">local</span> <span class="n">id_text</span> <span class="o">=</span> <span class="n">func_map</span><span class="p">[</span><span class="n">hkey</span><span class="p">]</span> <span class="p">(</span><span class="n">options_t</span><span class="p">);</span>							<span class="c1">-- call the function to get identifier text and any error message</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos" data-line="1642"></span></a>			<span class="nb">table.insert</span> <span class="p">(</span><span class="n">ID_list_t</span><span class="p">,</span> <span class="p">{</span><span class="n">hkey</span><span class="p">,</span> <span class="n">id_text</span><span class="p">});</span>							<span class="c1">-- add identifier text to the output sequence table</span>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos" data-line="1643"></span></a>		<span class="kr">else</span>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos" data-line="1644"></span></a>			<span class="nb">error</span> <span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">messages</span><span class="p">[</span><span class="s1">&#39;unknown_ID_key&#39;</span><span class="p">]</span> <span class="o">..</span> <span class="n">hkey</span><span class="p">);</span>						<span class="c1">-- here when func_map doesn&#39;t have a function for hkey</span>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos" data-line="1645"></span></a>		<span class="kr">end</span>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos" data-line="1646"></span></a>	<span class="kr">end</span>
</span><span id="L-1647"><a href="#L-1647"><span class="linenos" data-line="1647"></span></a>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos" data-line="1648"></span></a>	<span class="kd">local</span> <span class="kr">function</span> <span class="nf">comp</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>													<span class="c1">-- used by following table.sort()</span>
</span><span id="L-1649"><a href="#L-1649"><span class="linenos" data-line="1649"></span></a>		<span class="kr">return</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">lower</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">lower</span><span class="p">();</span>										<span class="c1">-- sort by hkey</span>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos" data-line="1650"></span></a>	<span class="kr">end</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos" data-line="1651"></span></a>
</span><span id="L-1652"><a href="#L-1652"><span class="linenos" data-line="1652"></span></a>	<span class="nb">table.sort</span> <span class="p">(</span><span class="n">ID_list_t</span><span class="p">,</span> <span class="n">comp</span><span class="p">);</span>												<span class="c1">-- sequence table of tables sort	</span>
</span><span id="L-1653"><a href="#L-1653"><span class="linenos" data-line="1653"></span></a>	<span class="kr">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="kr">in</span> <span class="nb">ipairs</span> <span class="p">(</span><span class="n">ID_list_t</span><span class="p">)</span> <span class="kr">do</span>											<span class="c1">-- convert sequence table of tables to simple sequence table of strings</span>
</span><span id="L-1654"><a href="#L-1654"><span class="linenos" data-line="1654"></span></a>		<span class="n">ID_list_t</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>													<span class="c1">-- v[2] is the identifier rendering from the call to the various functions in func_map{}</span>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos" data-line="1655"></span></a>	<span class="kr">end</span>
</span><span id="L-1656"><a href="#L-1656"><span class="linenos" data-line="1656"></span></a>	
</span><span id="L-1657"><a href="#L-1657"><span class="linenos" data-line="1657"></span></a>	<span class="kr">return</span> <span class="n">ID_list_t</span><span class="p">;</span>
</span><span id="L-1658"><a href="#L-1658"><span class="linenos" data-line="1658"></span></a><span class="kr">end</span>
</span><span id="L-1659"><a href="#L-1659"><span class="linenos" data-line="1659"></span></a>
</span><span id="L-1660"><a href="#L-1660"><span class="linenos" data-line="1660"></span></a>
</span><span id="L-1661"><a href="#L-1661"><span class="linenos" data-line="1661"></span></a><span class="cm">--[[--------------------------&lt; O P T I O N S _ C H E C K &gt;----------------------------------------------------</span>
</span><span id="L-1662"><a href="#L-1662"><span class="linenos" data-line="1662"></span></a>
</span><span id="L-1663"><a href="#L-1663"><span class="linenos" data-line="1663"></span></a><span class="cm">check that certain option parameters have their associated identifier parameters with values</span>
</span><span id="L-1664"><a href="#L-1664"><span class="linenos" data-line="1664"></span></a>
</span><span id="L-1665"><a href="#L-1665"><span class="linenos" data-line="1665"></span></a><span class="cm">&lt;ID_list_coins_t&gt; is a table of k/v pairs where k is same as key in cfg.id_handlers and v is the assigned value</span>
</span><span id="L-1666"><a href="#L-1666"><span class="linenos" data-line="1666"></span></a><span class="cm">&lt;ID_support_t&gt; is a sequence table of tables created in citation0() where each subtable has four elements:</span>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos" data-line="1667"></span></a><span class="cm">	[1] is the support parameter&#39;s assigned value; empty string if not set</span>
</span><span id="L-1668"><a href="#L-1668"><span class="linenos" data-line="1668"></span></a><span class="cm">	[2] is a text string same as key in cfg.id_handlers</span>
</span><span id="L-1669"><a href="#L-1669"><span class="linenos" data-line="1669"></span></a><span class="cm">	[3] is cfg.error_conditions key used to create error message</span>
</span><span id="L-1670"><a href="#L-1670"><span class="linenos" data-line="1670"></span></a><span class="cm">	[4] is original ID support parameter name used to create error message</span>
</span><span id="L-1671"><a href="#L-1671"><span class="linenos" data-line="1671"></span></a><span class="cm">	</span>
</span><span id="L-1672"><a href="#L-1672"><span class="linenos" data-line="1672"></span></a><span class="cm">returns nothing; on error emits an appropriate error message</span>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos" data-line="1673"></span></a>
</span><span id="L-1674"><a href="#L-1674"><span class="linenos" data-line="1674"></span></a><span class="cm">]]</span>
</span><span id="L-1675"><a href="#L-1675"><span class="linenos" data-line="1675"></span></a>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos" data-line="1676"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">options_check</span> <span class="p">(</span><span class="n">ID_list_coins_t</span><span class="p">,</span> <span class="n">ID_support_t</span><span class="p">)</span>
</span><span id="L-1677"><a href="#L-1677"><span class="linenos" data-line="1677"></span></a>	<span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="kr">in</span> <span class="nb">ipairs</span> <span class="p">(</span><span class="n">ID_support_t</span><span class="p">)</span> <span class="kr">do</span>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos" data-line="1678"></span></a>		<span class="kr">if</span> <span class="n">is_set</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ID_list_coins_t</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="kr">then</span>						<span class="c1">-- when support parameter has a value but matching identifier parameter is missing or empty</span>
</span><span id="L-1679"><a href="#L-1679"><span class="linenos" data-line="1679"></span></a>			<span class="n">set_message</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">4</span><span class="p">]));</span>											<span class="c1">-- emit the appropriate error message</span>
</span><span id="L-1680"><a href="#L-1680"><span class="linenos" data-line="1680"></span></a>		<span class="kr">end</span>
</span><span id="L-1681"><a href="#L-1681"><span class="linenos" data-line="1681"></span></a>	<span class="kr">end</span>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos" data-line="1682"></span></a><span class="kr">end</span>
</span><span id="L-1683"><a href="#L-1683"><span class="linenos" data-line="1683"></span></a>
</span><span id="L-1684"><a href="#L-1684"><span class="linenos" data-line="1684"></span></a>
</span><span id="L-1685"><a href="#L-1685"><span class="linenos" data-line="1685"></span></a><span class="cm">--[[--------------------------&lt; I D E N T I F I E R _ L I S T S _ G E T &gt;--------------------------------------</span>
</span><span id="L-1686"><a href="#L-1686"><span class="linenos" data-line="1686"></span></a>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos" data-line="1687"></span></a><span class="cm">Creates two identifier lists: a k/v table of identifiers and their values to be used locally and for use in the</span>
</span><span id="L-1688"><a href="#L-1688"><span class="linenos" data-line="1688"></span></a><span class="cm">COinS metadata, and a sequence table of the rendered identifier strings that will be included in the rendered</span>
</span><span id="L-1689"><a href="#L-1689"><span class="linenos" data-line="1689"></span></a><span class="cm">citation.</span>
</span><span id="L-1690"><a href="#L-1690"><span class="linenos" data-line="1690"></span></a>
</span><span id="L-1691"><a href="#L-1691"><span class="linenos" data-line="1691"></span></a><span class="cm">]]</span>
</span><span id="L-1692"><a href="#L-1692"><span class="linenos" data-line="1692"></span></a>
</span><span id="L-1693"><a href="#L-1693"><span class="linenos" data-line="1693"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">identifier_lists_get</span> <span class="p">(</span><span class="n">args_t</span><span class="p">,</span> <span class="n">options_t</span><span class="p">,</span> <span class="n">ID_support_t</span><span class="p">)</span>
</span><span id="L-1694"><a href="#L-1694"><span class="linenos" data-line="1694"></span></a>	<span class="kd">local</span> <span class="n">ID_list_coins_t</span> <span class="o">=</span> <span class="n">extract_ids</span> <span class="p">(</span><span class="n">args_t</span><span class="p">);</span>										<span class="c1">-- get a table of identifiers and their values for use locally and for use in COinS</span>
</span><span id="L-1695"><a href="#L-1695"><span class="linenos" data-line="1695"></span></a>	<span class="n">options_check</span> <span class="p">(</span><span class="n">ID_list_coins_t</span><span class="p">,</span> <span class="n">ID_support_t</span><span class="p">);</span>										<span class="c1">-- ID support parameters must have matching identifier parameters </span>
</span><span id="L-1696"><a href="#L-1696"><span class="linenos" data-line="1696"></span></a>	<span class="kd">local</span> <span class="n">ID_access_levels_t</span> <span class="o">=</span> <span class="n">extract_id_access_levels</span> <span class="p">(</span><span class="n">args_t</span><span class="p">,</span> <span class="n">ID_list_coins_t</span><span class="p">);</span>		<span class="c1">-- get a table of identifier access levels</span>
</span><span id="L-1697"><a href="#L-1697"><span class="linenos" data-line="1697"></span></a>	<span class="kd">local</span> <span class="n">ID_list_t</span> <span class="o">=</span> <span class="n">build_id_list</span> <span class="p">(</span><span class="n">ID_list_coins_t</span><span class="p">,</span> <span class="n">options_t</span><span class="p">,</span> <span class="n">ID_access_levels_t</span><span class="p">);</span>	<span class="c1">-- get a sequence table of rendered identifier strings</span>
</span><span id="L-1698"><a href="#L-1698"><span class="linenos" data-line="1698"></span></a>
</span><span id="L-1699"><a href="#L-1699"><span class="linenos" data-line="1699"></span></a>	<span class="kr">return</span> <span class="n">ID_list_t</span><span class="p">,</span> <span class="n">ID_list_coins_t</span><span class="p">;</span>											<span class="c1">-- return the tables</span>
</span><span id="L-1700"><a href="#L-1700"><span class="linenos" data-line="1700"></span></a><span class="kr">end</span>
</span><span id="L-1701"><a href="#L-1701"><span class="linenos" data-line="1701"></span></a>
</span><span id="L-1702"><a href="#L-1702"><span class="linenos" data-line="1702"></span></a>
</span><span id="L-1703"><a href="#L-1703"><span class="linenos" data-line="1703"></span></a><span class="cm">--[[--------------------------&lt; S E T _ S E L E C T E D _ M O D U L E S &gt;--------------------------------------</span>
</span><span id="L-1704"><a href="#L-1704"><span class="linenos" data-line="1704"></span></a>
</span><span id="L-1705"><a href="#L-1705"><span class="linenos" data-line="1705"></span></a><span class="cm">Sets local cfg table and imported functions table to same (live or sandbox) as that used by the other modules.</span>
</span><span id="L-1706"><a href="#L-1706"><span class="linenos" data-line="1706"></span></a>
</span><span id="L-1707"><a href="#L-1707"><span class="linenos" data-line="1707"></span></a><span class="cm">]]</span>
</span><span id="L-1708"><a href="#L-1708"><span class="linenos" data-line="1708"></span></a>
</span><span id="L-1709"><a href="#L-1709"><span class="linenos" data-line="1709"></span></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">set_selected_modules</span> <span class="p">(</span><span class="n">cfg_table_ptr</span><span class="p">,</span> <span class="n">utilities_page_ptr</span><span class="p">)</span>
</span><span id="L-1710"><a href="#L-1710"><span class="linenos" data-line="1710"></span></a>	<span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg_table_ptr</span><span class="p">;</span>
</span><span id="L-1711"><a href="#L-1711"><span class="linenos" data-line="1711"></span></a>
</span><span id="L-1712"><a href="#L-1712"><span class="linenos" data-line="1712"></span></a>	<span class="n">has_accept_as_written</span> <span class="o">=</span> <span class="n">utilities_page_ptr</span><span class="p">.</span><span class="n">has_accept_as_written</span><span class="p">;</span>			<span class="c1">-- import functions from select Module:Citation/CS1/Utilities module</span>
</span><span id="L-1713"><a href="#L-1713"><span class="linenos" data-line="1713"></span></a>	<span class="n">is_set</span> <span class="o">=</span> <span class="n">utilities_page_ptr</span><span class="p">.</span><span class="n">is_set</span><span class="p">;</span>								
</span><span id="L-1714"><a href="#L-1714"><span class="linenos" data-line="1714"></span></a>	<span class="n">in_array</span> <span class="o">=</span> <span class="n">utilities_page_ptr</span><span class="p">.</span><span class="n">in_array</span><span class="p">;</span>
</span><span id="L-1715"><a href="#L-1715"><span class="linenos" data-line="1715"></span></a>	<span class="n">set_message</span> <span class="o">=</span> <span class="n">utilities_page_ptr</span><span class="p">.</span><span class="n">set_message</span><span class="p">;</span>
</span><span id="L-1716"><a href="#L-1716"><span class="linenos" data-line="1716"></span></a>	<span class="n">select_one</span> <span class="o">=</span> <span class="n">utilities_page_ptr</span><span class="p">.</span><span class="n">select_one</span><span class="p">;</span>
</span><span id="L-1717"><a href="#L-1717"><span class="linenos" data-line="1717"></span></a>	<span class="n">substitute</span> <span class="o">=</span> <span class="n">utilities_page_ptr</span><span class="p">.</span><span class="n">substitute</span><span class="p">;</span>
</span><span id="L-1718"><a href="#L-1718"><span class="linenos" data-line="1718"></span></a>	<span class="n">make_wikilink</span> <span class="o">=</span> <span class="n">utilities_page_ptr</span><span class="p">.</span><span class="n">make_wikilink</span><span class="p">;</span>
</span><span id="L-1719"><a href="#L-1719"><span class="linenos" data-line="1719"></span></a>
</span><span id="L-1720"><a href="#L-1720"><span class="linenos" data-line="1720"></span></a>	<span class="n">z</span> <span class="o">=</span> <span class="n">utilities_page_ptr</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>													<span class="c1">-- table of tables in Module:Citation/CS1/Utilities</span>
</span><span id="L-1721"><a href="#L-1721"><span class="linenos" data-line="1721"></span></a><span class="kr">end</span>
</span><span id="L-1722"><a href="#L-1722"><span class="linenos" data-line="1722"></span></a>
</span><span id="L-1723"><a href="#L-1723"><span class="linenos" data-line="1723"></span></a>
</span><span id="L-1724"><a href="#L-1724"><span class="linenos" data-line="1724"></span></a><span class="cm">--[[--------------------------&lt; E X P O R T E D   F U N C T I O N S &gt;------------------------------------------</span>
</span><span id="L-1725"><a href="#L-1725"><span class="linenos" data-line="1725"></span></a><span class="cm">]]</span>
</span><span id="L-1726"><a href="#L-1726"><span class="linenos" data-line="1726"></span></a>
</span><span id="L-1727"><a href="#L-1727"><span class="linenos" data-line="1727"></span></a><span class="kr">return</span> <span class="p">{</span>
</span><span id="L-1728"><a href="#L-1728"><span class="linenos" data-line="1728"></span></a>	<span class="n">auto_link_urls</span> <span class="o">=</span> <span class="n">auto_link_urls</span><span class="p">,</span>											<span class="c1">-- table of identifier URLs to be used when auto-linking |title=</span>
</span><span id="L-1729"><a href="#L-1729"><span class="linenos" data-line="1729"></span></a>	
</span><span id="L-1730"><a href="#L-1730"><span class="linenos" data-line="1730"></span></a>	<span class="n">identifier_lists_get</span> <span class="o">=</span> <span class="n">identifier_lists_get</span><span class="p">,</span>								<span class="c1">-- experiment to replace individual calls to build_id_list(), extract_ids, extract_id_access_levels</span>
</span><span id="L-1731"><a href="#L-1731"><span class="linenos" data-line="1731"></span></a>	<span class="n">is_embargoed</span> <span class="o">=</span> <span class="n">is_embargoed</span><span class="p">;</span>
</span><span id="L-1732"><a href="#L-1732"><span class="linenos" data-line="1732"></span></a>	<span class="n">set_selected_modules</span> <span class="o">=</span> <span class="n">set_selected_modules</span><span class="p">;</span>
</span><span id="L-1733"><a href="#L-1733"><span class="linenos" data-line="1733"></span></a>	<span class="p">}</span>
</span></pre></div>
<!-- 
NewPP limit report
Parsed by mw‐web.codfw.main‐779c5f569f‐v9v8q
Cached time: 20250328221719
Cache expiry: 2592000
Reduced expiry: false
Complications: [vary‐revision‐sha1]
CPU time usage: 0.114 seconds
Real time usage: 0.161 seconds
Preprocessor visited node count: 700/1000000
Post‐expand include size: 55939/2097152 bytes
Template argument size: 8660/2097152 bytes
Highest expansion depth: 27/100
Expensive parser function count: 3/500
Unstrip recursion depth: 0/20
Unstrip post‐expand size: 7663/5000000 bytes
Lua time usage: 0.063/10.000 seconds
Lua memory usage: 2221849/52428800 bytes
Number of Wikibase entities loaded: 0/400
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
171.29%  141.176      2 Template:Sandbox_other
100.00%   82.418      1 Module:Citation/CS1/Identifiers/doc
100.00%   82.418      1 -total
 44.30%   36.513      1 Template:High-risk
 28.35%   23.367      1 Template:Module_rating
 25.63%   21.122      2 Template:Module_other
 19.40%   15.985      1 Template:Module_rating/protected
 13.27%   10.935      3 Template:Namespace_detect
  7.17%    5.908      2 Template:Ombox
  6.23%    5.138      1 Template:Cascade-protected_template
-->
</div><!--esi <esi:include src="/esitest-fa8a495983347898/content" /> --><noscript><img src="https://login.wikimedia.org/wiki/Special:CentralAutoLogin/start?useformat=desktop&amp;type=1x1&amp;usesul3=0" alt="" width="1" height="1" style="border: none; position: absolute;"></noscript>
<div class="printfooter" data-nosnippet="">Retrieved from "<a dir="ltr" href="https://en.wikipedia.org/w/index.php?title=Module:Citation/CS1/Identifiers&amp;oldid=1265768031">https://en.wikipedia.org/w/index.php?title=Module:Citation/CS1/Identifiers&amp;oldid=1265768031</a>"</div></div>
					<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a href="/wiki/Help:Category" title="Help:Category">Category</a>: <ul><li><a href="/wiki/Category:Modules_subject_to_page_protection" title="Category:Modules subject to page protection">Modules subject to page protection</a></li></ul></div><div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden category: <ul><li><a href="/wiki/Category:Wikipedia_fully_protected_modules" title="Category:Wikipedia fully protected modules">Wikipedia fully protected modules</a></li></ul></div></div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" >
	<ul id="footer-info">
	<li id="footer-info-lastmod"> This page was last edited on 28 December 2024, at 15:31<span class="anonymous-show">&#160;(UTC)</span>.</li>
	<li id="footer-info-copyright">Text is available under the <a href="/wiki/Wikipedia:Text_of_the_Creative_Commons_Attribution-ShareAlike_4.0_International_License" title="Wikipedia:Text of the Creative Commons Attribution-ShareAlike 4.0 International License">Creative Commons Attribution-ShareAlike 4.0 License</a>;
additional terms may apply. By using this site, you agree to the <a href="https://foundation.wikimedia.org/wiki/Special:MyLanguage/Policy:Terms_of_Use" class="extiw" title="foundation:Special:MyLanguage/Policy:Terms of Use">Terms of Use</a> and <a href="https://foundation.wikimedia.org/wiki/Special:MyLanguage/Policy:Privacy_policy" class="extiw" title="foundation:Special:MyLanguage/Policy:Privacy policy">Privacy Policy</a>. Wikipedia® is a registered trademark of the <a rel="nofollow" class="external text" href="https://wikimediafoundation.org/">Wikimedia Foundation, Inc.</a>, a non-profit organization.</li>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://foundation.wikimedia.org/wiki/Special:MyLanguage/Policy:Privacy_policy">Privacy policy</a></li>
	<li id="footer-places-about"><a href="/wiki/Wikipedia:About">About Wikipedia</a></li>
	<li id="footer-places-disclaimers"><a href="/wiki/Wikipedia:General_disclaimer">Disclaimers</a></li>
	<li id="footer-places-contact"><a href="//en.wikipedia.org/wiki/Wikipedia:Contact_us">Contact Wikipedia</a></li>
	<li id="footer-places-wm-codeofconduct"><a href="https://foundation.wikimedia.org/wiki/Special:MyLanguage/Policy:Universal_Code_of_Conduct">Code of Conduct</a></li>
	<li id="footer-places-developers"><a href="https://developer.wikimedia.org">Developers</a></li>
	<li id="footer-places-statslink"><a href="https://stats.wikimedia.org/#/en.wikipedia.org">Statistics</a></li>
	<li id="footer-places-cookiestatement"><a href="https://foundation.wikimedia.org/wiki/Special:MyLanguage/Policy:Cookie_statement">Cookie statement</a></li>
	<li id="footer-places-mobileview"><a href="//en.m.wikipedia.org/w/index.php?title=Module:Citation/CS1/Identifiers&amp;mobileaction=toggle_view_mobile" class="noprint stopMobileRedirectToggle">Mobile view</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.wikimedia.org/" class="cdx-button cdx-button--fake-button cdx-button--size-large cdx-button--fake-button--enabled"><picture><source media="(min-width: 500px)" srcset="/static/images/footer/wikimedia-button.svg" width="84" height="29"><img src="/static/images/footer/wikimedia.svg" width="25" height="25" alt="Wikimedia Foundation" lang="en" loading="lazy"></picture></a></li>
	<li id="footer-poweredbyico"><a href="https://www.mediawiki.org/" class="cdx-button cdx-button--fake-button cdx-button--size-large cdx-button--fake-button--enabled"><picture><source media="(min-width: 500px)" srcset="/w/resources/assets/poweredby_mediawiki.svg" width="88" height="31"><img src="/w/resources/assets/mediawiki_compact.svg" alt="Powered by MediaWiki" lang="en" width="25" height="25" loading="lazy"></picture></a></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-header-container vector-sticky-header-container">
	<div id="vector-sticky-header" class="vector-sticky-header">
		<div class="vector-sticky-header-start">
			<div class="vector-sticky-header-icon-start vector-button-flush-left vector-button-flush-right" aria-hidden="true">
				<button class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-sticky-header-search-toggle" tabindex="-1" data-event-name="ui.vector-sticky-search-form.icon"><span class="vector-icon mw-ui-icon-search mw-ui-icon-wikimedia-search"></span>

<span>Search</span>
			</button>
		</div>
			
		<div role="search" class="vector-search-box-vue  vector-search-box-show-thumbnail vector-search-box">
			<div class="vector-typeahead-search-container">
				<div class="cdx-typeahead-search cdx-typeahead-search--show-thumbnail">
					<form action="/w/index.php" id="vector-sticky-search-form" class="cdx-search-input cdx-search-input--has-end-button">
						<div  class="cdx-search-input__input-wrapper"  data-search-loc="header-moved">
							<div class="cdx-text-input cdx-text-input--has-start-icon">
								<input
									class="cdx-text-input__input"
									
									type="search" name="search" placeholder="Search Wikipedia">
								<span class="cdx-text-input__icon cdx-text-input__start-icon"></span>
							</div>
							<input type="hidden" name="title" value="Special:Search">
						</div>
						<button class="cdx-button cdx-search-input__end-button">Search</button>
					</form>
				</div>
			</div>
		</div>
		<div class="vector-sticky-header-context-bar">
				<div class="vector-sticky-header-context-bar-primary" aria-hidden="true" ><span class="mw-page-title-namespace">Module</span><span class="mw-page-title-separator">:</span><span class="mw-page-title-main">Citation/CS1/Identifiers</span></div>
			</div>
		</div>
		<div class="vector-sticky-header-end" aria-hidden="true">
			<div class="vector-sticky-header-icons">
				<a href="#" class="cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only" id="ca-talk-sticky-header" tabindex="-1" data-event-name="talk-sticky-header"><span class="vector-icon mw-ui-icon-speechBubbles mw-ui-icon-wikimedia-speechBubbles"></span>

<span></span>
			</a>
			<a href="#" class="cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only" id="ca-subject-sticky-header" tabindex="-1" data-event-name="subject-sticky-header"><span class="vector-icon mw-ui-icon-article mw-ui-icon-wikimedia-article"></span>

<span></span>
			</a>
			<a href="#" class="cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only" id="ca-history-sticky-header" tabindex="-1" data-event-name="history-sticky-header"><span class="vector-icon mw-ui-icon-wikimedia-history mw-ui-icon-wikimedia-wikimedia-history"></span>

<span></span>
			</a>
			<a href="#" class="cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only mw-watchlink" id="ca-watchstar-sticky-header" tabindex="-1" data-event-name="watch-sticky-header"><span class="vector-icon mw-ui-icon-wikimedia-star mw-ui-icon-wikimedia-wikimedia-star"></span>

<span></span>
			</a>
			<a href="#" class="cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only" id="ca-edit-sticky-header" tabindex="-1" data-event-name="wikitext-edit-sticky-header"><span class="vector-icon mw-ui-icon-wikimedia-wikiText mw-ui-icon-wikimedia-wikimedia-wikiText"></span>

<span></span>
			</a>
			<a href="#" class="cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only" id="ca-ve-edit-sticky-header" tabindex="-1" data-event-name="ve-edit-sticky-header"><span class="vector-icon mw-ui-icon-wikimedia-edit mw-ui-icon-wikimedia-wikimedia-edit"></span>

<span></span>
			</a>
			<a href="#" class="cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only" id="ca-viewsource-sticky-header" tabindex="-1" data-event-name="ve-edit-protected-sticky-header"><span class="vector-icon mw-ui-icon-wikimedia-editLock mw-ui-icon-wikimedia-wikimedia-editLock"></span>

<span></span>
			</a>
		</div>
			<div class="vector-sticky-header-buttons">
				<button class="cdx-button cdx-button--weight-quiet mw-interlanguage-selector" id="p-lang-btn-sticky-header" tabindex="-1" data-event-name="ui.dropdown-p-lang-btn-sticky-header"><span class="vector-icon mw-ui-icon-wikimedia-language mw-ui-icon-wikimedia-wikimedia-language"></span>

<span>134 languages</span>
			</button>
			<a href="#" class="cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive" id="ca-addsection-sticky-header" tabindex="-1" data-event-name="addsection-sticky-header"><span class="vector-icon mw-ui-icon-speechBubbleAdd-progressive mw-ui-icon-wikimedia-speechBubbleAdd-progressive"></span>

<span>Add topic</span>
			</a>
		</div>
			<div class="vector-sticky-header-icon-end">
				<div class="vector-user-links">
				</div>
			</div>
		</div>
	</div>
</div>
<div class="mw-portlet mw-portlet-dock-bottom emptyPortlet" id="p-dock-bottom">
	<ul>
		
	</ul>
</div>
<script>(RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgHostname":"mw-web.codfw.main-779c5f569f-v9v8q","wgBackendResponseTime":626,"wgPageParseReport":{"limitreport":{"cputime":"0.114","walltime":"0.161","ppvisitednodes":{"value":700,"limit":1000000},"postexpandincludesize":{"value":55939,"limit":2097152},"templateargumentsize":{"value":8660,"limit":2097152},"expansiondepth":{"value":27,"limit":100},"expensivefunctioncount":{"value":3,"limit":500},"unstrip-depth":{"value":0,"limit":20},"unstrip-size":{"value":7663,"limit":5000000},"entityaccesscount":{"value":0,"limit":400},"timingprofile":["171.29%  141.176      2 Template:Sandbox_other","100.00%   82.418      1 Module:Citation/CS1/Identifiers/doc","100.00%   82.418      1 -total"," 44.30%   36.513      1 Template:High-risk"," 28.35%   23.367      1 Template:Module_rating"," 25.63%   21.122      2 Template:Module_other"," 19.40%   15.985      1 Template:Module_rating/protected"," 13.27%   10.935      3 Template:Namespace_detect","  7.17%    5.908      2 Template:Ombox","  6.23%    5.138      1 Template:Cascade-protected_template"]},"scribunto":{"limitreport-timeusage":{"value":"0.063","limit":"10.000"},"limitreport-memusage":{"value":2221849,"limit":52428800}},"cachereport":{"origin":"mw-web.codfw.main-779c5f569f-v9v8q","timestamp":"20250328221719","ttl":2592000,"transientcontent":false}}});});</script>
</body>
</html>